62c7c4a7a7de5effa0a82c89e77e53795a82e11d
slackero@@phpwcms
diff --git a/include/inc_lib/revision/revision.php b/include/inc_lib/revision/revision.php
index fd5d87cfe..8ffa75fee 100644
--- a/include/inc_lib/revision/revision.php
+++ b/include/inc_lib/revision/revision.php
@@ -10,5 +10,5 @@
  **/
 
 define('PHPWCMS_VERSION', '1.8.9');
-define('PHPWCMS_RELEASE_DATE', '2017/09/14');
+define('PHPWCMS_RELEASE_DATE', '2017/10/23');
 define('PHPWCMS_REVISION', '547');
diff --git a/include/inc_tmpl/admin.edituser.tmpl.php b/include/inc_tmpl/admin.edituser.tmpl.php
index 3cffa8cf8..142caaf01 100755
--- a/include/inc_tmpl/admin.edituser.tmpl.php
+++ b/include/inc_tmpl/admin.edituser.tmpl.php
@@ -12,118 +12,118 @@
 // ----------------------------------------------------------------
 // obligate check for phpwcms constants
 if (!defined('PHPWCMS_ROOT')) {
-	die("You Cannot Access This Script Directly, Have a Nice Day.");
+    die("You Cannot Access This Script Directly, Have a Nice Day.");
 }
 // ----------------------------------------------------------------
 
 if(isset($_GET["u"]) && intval($_GET["u"])) {
 
-	if(empty($_POST["form_aktion"]) || $_POST["form_aktion"] != "edit_account") {
-		$new_user_id = intval($_GET["u"]);
-		$sql = "SELECT * FROM ".DB_PREPEND."phpwcms_user WHERE usr_id=".$new_user_id." AND usr_aktiv<>9;";
-		if($result = mysql_query($sql, $db) or die("error")) {
-			if($row = mysql_fetch_array($result)) {
-				$new_login = $row["usr_login"];
-				$new_email = $row["usr_email"];
-				$new_name = $row["usr_name"];
-				$set_user_aktiv = $row["usr_aktiv"];
-				$set_user_admin = $row["usr_admin"];
-				$set_user_fe	= $row["usr_fe"];
-				$set_user_var	= @unserialize($row["usr_vars"]);
-				$send_verification = 0;
-				$new_password = '';
-			}
-		}
-	}
-
-	$set_allowed_cp = isset($set_user_var['allowed_cp']) && is_array($set_user_var['allowed_cp']) ? $set_user_var['allowed_cp'] : array();
-
-	if(isset($_POST["form_aktion"]) && $_POST["form_aktion"] == "edit_account") {
-
-		// Handle account data
-
-		$new_user_id = intval($_POST["form_uid"]);
-		$new_login = slweg($_POST["form_newloginname"]);
-		$new_password = slweg($_POST["form_newpassword"]);
-		$new_email = clean_slweg($_POST["form_newemail"]);
-		$new_name = clean_slweg($_POST["form_newrealname"]);
-		$set_user_aktiv = isset($_POST["form_active"]) ? 1 : 0;
-		$set_user_admin = isset($_POST["form_admin"]) ? 1 : 0;
-		$set_user_fe = isset($_POST["form_feuser"]) ? intval($_POST["form_feuser"]) : 0;
-		$set_allowed_cp = isset($_POST["allowed_cp"]) && is_array($_POST["allowed_cp"]) && count($_POST["allowed_cp"]) ? $_POST["allowed_cp"] : array();
-		$set_allowed_cp_total = count($set_allowed_cp);
-		$cp_total = empty($_POST["cp_total"]) ? 0 : intval($_POST["cp_total"]);
-		if(!$set_allowed_cp_total || $cp_total == $set_allowed_cp_total) {
-			$set_allowed_cp = array();
-		}
-		if($set_user_admin) {
-			$set_user_fe = 2;
-		}
-		$send_verification = isset($_POST["verification_email"]) ? 1 : 0;
-		$user_err = '';
-		if(empty($new_login)) {
-			$user_err = $BL['be_admin_usr_err2']."\n";
-		} else {
-			$sql = "SELECT usr_id, usr_vars, COUNT(*) AS anzahl FROM ".DB_PREPEND."phpwcms_user WHERE usr_login='".aporeplace($new_login)."' GROUP BY usr_id";
-			if($result = mysql_query($sql, $db)) {
-				if($check_anzahl = mysql_fetch_array($result)) {
-					if($check_anzahl["usr_id"] != $new_user_id && $check_anzahl["anzahl"]) {
-						$user_err .= $BL['be_admin_usr_err1']."\n";
-					}
-
-					if(empty($user_err)) {
-						$set_user_var = @unserialize($check_anzahl["usr_vars"]);
-						if(!is_array($set_user_var)) {
-							$set_user_var = array();
-						}
-						$set_user_var['allowed_cp'] = $set_allowed_cp;
-					}
-				}
-			}
-		}
-
-		if(!is_valid_email($new_email)) {
-			$user_err .= $BL['be_admin_usr_err4']."\n";
-		}
-		if(empty($user_err)) { //Insert new User
-
-			$sql =	"UPDATE ".DB_PREPEND."phpwcms_user SET usr_login='".aporeplace($new_login)."', ";
-			if($new_password) {
-				$sql .= "usr_pass='".aporeplace(md5(makeCharsetConversion($new_password, PHPWCMS_CHARSET, 'utf-8')))."', ";
-			}
-			$sql .= "usr_email='".aporeplace($new_email)."', ".
-					"usr_admin='".$set_user_admin."', ".
-					"usr_aktiv='".$set_user_aktiv."', ".
-					"usr_name='".aporeplace($new_name)."', ";
-			if(isset($set_user_var['allowed_cp'])) {
-				$sql .= "usr_vars="._dbEscape(serialize($set_user_var)).", ";
-			}
-			$sql .= "usr_fe='".$set_user_fe."' WHERE usr_id=".$new_user_id;
-
-			if($result = mysql_query($sql, $db) or die("error")) {
-				$user_ok = 1;
-				$new_user_id = NULL;
-				if($send_verification) {
-					$emailbody = str_replace('{LOGIN}',			$new_login, $BL['be_admin_usr_emailbody']);
-					$emailbody = str_replace('{PASSWORD}',		(($new_password) ? $new_password : $BL['be_admin_usr_passnochange']), $emailbody);
-					$emailbody = str_replace('{SITE}',			PHPWCMS_URL, $emailbody);
-					$emailbody = str_replace('{LOGIN_PAGE}',	PHPWCMS_URL.get_login_file(), $emailbody);
-
-					sendEmail(	array(
-						'recipient'	=> $new_email,
-						'toName'	=> $new_name,
-						'subject'	=> $BL['be_admin_usr_mailsubject'],
-						'isHTML'	=> 0,
-						'text'		=> $emailbody,
-						'from'		=> $phpwcms["admin_email"],
-						'sender'	=> $phpwcms["admin_email"]
-				        ));
-				}
-			}
-		}
-	}
-
-	if(empty($user_ok)) {
+    if(empty($_POST["form_aktion"]) || $_POST["form_aktion"] != "edit_account") {
+        $new_user_id = intval($_GET["u"]);
+        $sql = "SELECT * FROM ".DB_PREPEND."phpwcms_user WHERE usr_id=".$new_user_id." AND usr_aktiv<>9";
+        $result = _dbQuery($sql);
+        if(isset($result[0]['usr_id'])) {
+            $new_login = $result[0]["usr_login"];
+            $new_email = $result[0]["usr_email"];
+            $new_name = $result[0]["usr_name"];
+            $set_user_aktiv = $result[0]["usr_aktiv"];
+            $set_user_admin = $result[0]["usr_admin"];
+            $set_user_fe    = $result[0]["usr_fe"];
+            $set_user_var   = @unserialize($result[0]["usr_vars"]);
+            $send_verification = 0;
+            $new_password = '';
+        }
+    }
+
+    $set_allowed_cp = isset($set_user_var['allowed_cp']) && is_array($set_user_var['allowed_cp']) ? $set_user_var['allowed_cp'] : array();
+
+    if(isset($_POST["form_aktion"]) && $_POST["form_aktion"] == "edit_account") {
+
+        // Handle account data
+
+        $new_user_id = intval($_POST["form_uid"]);
+        $new_login = slweg($_POST["form_newloginname"]);
+        $new_password = slweg($_POST["form_newpassword"]);
+        $new_email = clean_slweg($_POST["form_newemail"]);
+        $new_name = clean_slweg($_POST["form_newrealname"]);
+        $set_user_aktiv = isset($_POST["form_active"]) ? 1 : 0;
+        $set_user_admin = isset($_POST["form_admin"]) ? 1 : 0;
+        $set_user_fe = isset($_POST["form_feuser"]) ? intval($_POST["form_feuser"]) : 0;
+        $set_allowed_cp = isset($_POST["allowed_cp"]) && is_array($_POST["allowed_cp"]) && count($_POST["allowed_cp"]) ? $_POST["allowed_cp"] : array();
+        $set_allowed_cp_total = count($set_allowed_cp);
+        $cp_total = empty($_POST["cp_total"]) ? 0 : intval($_POST["cp_total"]);
+        if(!$set_allowed_cp_total || $cp_total == $set_allowed_cp_total) {
+            $set_allowed_cp = array();
+        }
+        if($set_user_admin) {
+            $set_user_fe = 2;
+        }
+        $send_verification = isset($_POST["verification_email"]) ? 1 : 0;
+        $user_err = '';
+        if(empty($new_login)) {
+            $user_err = $BL['be_admin_usr_err2']."\n";
+        } else {
+            $sql = "SELECT usr_id, usr_vars, COUNT(*) AS anzahl FROM ".DB_PREPEND."phpwcms_user WHERE usr_login='".aporeplace($new_login)."' GROUP BY usr_id";
+            $result = _dbQuery($sql);
+            if(isset($result[0]['anzahl'])) {
+
+                if($result[0]["usr_id"] != $new_user_id && $result[0]["anzahl"]) {
+                    $user_err .= $BL['be_admin_usr_err1']."\n";
+                }
+
+                if(empty($user_err)) {
+                    $set_user_var = @unserialize($result[0]["usr_vars"]);
+                    if(!is_array($set_user_var)) {
+                        $set_user_var = array();
+                    }
+                    $set_user_var['allowed_cp'] = $set_allowed_cp;
+                }
+
+            }
+        }
+
+        if(!is_valid_email($new_email)) {
+            $user_err .= $BL['be_admin_usr_err4']."\n";
+        }
+        if(empty($user_err)) { //Insert new User
+
+            $sql =  "UPDATE ".DB_PREPEND."phpwcms_user SET usr_login='".aporeplace($new_login)."', ";
+            if($new_password) {
+                $sql .= "usr_pass='".aporeplace(md5(makeCharsetConversion($new_password, PHPWCMS_CHARSET, 'utf-8')))."', ";
+            }
+            $sql .= "usr_email='".aporeplace($new_email)."', ".
+                    "usr_admin='".$set_user_admin."', ".
+                    "usr_aktiv='".$set_user_aktiv."', ".
+                    "usr_name='".aporeplace($new_name)."', ";
+            if(isset($set_user_var['allowed_cp'])) {
+                $sql .= "usr_vars="._dbEscape(serialize($set_user_var)).", ";
+            }
+            $sql .= "usr_fe='".$set_user_fe."' WHERE usr_id=".$new_user_id;
+            $result = _dbQuery($sql, 'UPDATE');
+            if(isset($result['AFFECTED_ROWS'])) {
+                $user_ok = 1;
+                $new_user_id = NULL;
+                if($send_verification) {
+                    $emailbody = str_replace('{LOGIN}',         $new_login, $BL['be_admin_usr_emailbody']);
+                    $emailbody = str_replace('{PASSWORD}',      (($new_password) ? $new_password : $BL['be_admin_usr_passnochange']), $emailbody);
+                    $emailbody = str_replace('{SITE}',          PHPWCMS_URL, $emailbody);
+                    $emailbody = str_replace('{LOGIN_PAGE}',    PHPWCMS_URL.get_login_file(), $emailbody);
+
+                    sendEmail(array(
+                        'recipient' => $new_email,
+                        'toName'    => $new_name,
+                        'subject'   => $BL['be_admin_usr_mailsubject'],
+                        'isHTML'    => 0,
+                        'text'      => $emailbody,
+                        'from'      => $phpwcms["admin_email"],
+                        'sender'    => $phpwcms["admin_email"]
+                    ));
+                }
+            }
+        }
+    }
+
+    if(empty($user_ok)) {
 
 ?>
 
@@ -132,49 +132,49 @@
             


-		  
+          

-            : 
-            
+            : 
+            


-		  
+          

: 
-            
+            



: 
-            
+            



: 
-            
+            



: 
-            
+            

 
-		  
+          

: 


-                  >
+                   />
  
-				  >
+                   />
  
-				  >
+                   />

-				  
+                  



@@ -184,7 +184,7 @@
             : 


-                  >
+                   />



@@ -195,8 +195,8 @@
             : 


-                  >
-                   !!!
+                   />
+                   !!!



@@ -205,43 +205,43 @@
             


-                  >
-				  
+                   />
+                  





 
-          	
-          		: 
-          		
+            
+                : 
+                
 $value):
+                foreach($wcs_content_type as $key => $value):
 
-					// count used CPs so it is easier to decide if needed or not
-					$used_count = _dbCount('SELECT COUNT(*) FROM '.DB_PREPEND.'phpwcms_articlecontent WHERE acontent_trash=0 AND acontent_type='._dbEscape($key));
+                    // count used CPs so it is easier to decide if needed or not
+                    $used_count = _dbCount('SELECT COUNT(*) FROM '.DB_PREPEND.'phpwcms_articlecontent WHERE acontent_trash=0 AND acontent_type='._dbEscape($key));
           ?>
 
-          			
-          				 checked="checked" />
-          				
-          			
+                    
+                         checked="checked" />
+                        
+                    
 
-          
-          			
-          		
-          	
+          
+                    
+                
+            

 

-            	
-            	
-            	
+                
+                
+                



@@ -255,11 +255,9 @@
        timer=setTimeout(\"self.location.href='phpwcms.php'+'?".CSRF_GET_TOKEN."&do=admin'\", 0); ";
+        echo "";
 
-	}
+    }
 }
-
-?>
\ No newline at end of file
diff --git a/include/inc_tmpl/admin.groups.tmpl.php b/include/inc_tmpl/admin.groups.tmpl.php
index 138e0024d..440e3372f 100644
--- a/include/inc_tmpl/admin.groups.tmpl.php
+++ b/include/inc_tmpl/admin.groups.tmpl.php
@@ -12,12 +12,12 @@
 // ----------------------------------------------------------------
 // obligate check for phpwcms constants
 if (!defined('PHPWCMS_ROOT')) {
-	die("You Cannot Access This Script Directly, Have a Nice Day.");
+    die("You Cannot Access This Script Directly, Have a Nice Day.");
 }
 // ----------------------------------------------------------------
 
-	//user group
-	$GLOBALS['BE']['HEADER']['optionselect.js']	= getJavaScriptSourceLink('include/inc_js/optionselect.js');
+//user group
+$GLOBALS['BE']['HEADER']['optionselect.js'] = getJavaScriptSourceLink('include/inc_js/optionselect.js');
 
 ?>
 
@@ -29,26 +29,26 @@
 
 

@@ -56,162 +56,152 @@
           .gif" alt="" width="19" height="16" border="0" />
">('.$total_member.' '.$BL['be_cnt_rssfeed_item'].')' : 'n.a.';
+            echo $grouplist["group_name"] ? html($grouplist["group_name"]).' ('.$total_member.' '.$BL['be_cnt_rssfeed_item'].')' : 'n.a.';
 
 
-		  ?>
+          ?>
">aktiv_mini.gif" alt="" width="14" height="15" border="0" />">" onclick="return confirm('Delete group ');">">
+            echo $grouplist["group_id"].':'.($grouplist["group_active"] ? "0" : "1");
+
+            ?>">aktiv_mini.gif" alt="" width="14" height="15" border="0" />">" onclick="return confirm('Delete group ');">">

'.$BL['be_admin_group_nogroup'].': '.$BL['be_admin_group_add'].'';
 
-	} else {
-			echo ''.$BL['be_admin_group_nogroup'].': '.$BL['be_admin_group_add'].'';
+    }
 
-	}
-
-		?>
-			
-			
-			
-			
-		
+        ?>
+            
+            
+            
+            
+        

 
 
-		  
-			
+          
+            

 
-		  
-  	 	  
+          
+          



-		   $group["name"],
-						'group_member'	=> $group["member"],
-						'group_value'	=> $group["value"],
-						'group_trash'	=> $group["trash"],
-						'group_active'	=> $group["active"]
-					);
+                if(empty($group["name"])) {
 
-					$result = $group["id"] ? _dbUpdate('phpwcms_usergroup', $data, 'group_id='.$group["id"]) : _dbInsert('phpwcms_usergroup', $data);
+                    $group["error"] = 1;
 
-					if(isset($result['AFFECTED_ROWS']) || isset($result['INSERT_ID'])) {
-						headerRedirect(PHPWCMS_URL.'phpwcms.php?'.get_token_get_string('csrftoken').'&do=admin&p=1');
-					} else {
-						echo mysql_error();
-					}
+                } else {
 
-				}
+                    $data = array(
 
-				$group["member"] = convertStringToArray($group["member"]);
+                        'group_name'    => $group["name"],
+                        'group_member'  => $group["member"],
+                        'group_value'   => $group["value"],
+                        'group_trash'   => $group["trash"],
+                        'group_active'  => $group["active"]
+                    );
 
-			}
-		  ?>
+                    $result = $group["id"] ? _dbUpdate('phpwcms_usergroup', $data, 'group_id='.$group["id"]) : _dbInsert('phpwcms_usergroup', $data);
 
+                    if(isset($result['AFFECTED_ROWS']) || isset($result['INSERT_ID'])) {
+                        headerRedirect(PHPWCMS_URL.'phpwcms.php?'.get_token_get_string('csrftoken').'&do=admin&p=1');
+                    } else {
+                        echo _dbError();
+                    }
 
+                }
 
-		  
-		  
-		  	
-		    
-		      : 
-		      
-		    
-			
-			
-			
-		    
-		      : 
-		      " size="40" maxlength="250" />
-		    
+                $group["member"] = convertStringToArray($group["member"]);
 
+            }
+          ?>
 
-		    
-
+          
+          
+            
+            
+              : 
+              
+            
+            
+            
+            
+            
+              : 
+              " size="40" maxlength="250" />
+            
 
+            

-		      : 
-		      
-		    
+              : 
+              
+            

 
-		  
+          
 
-		
+        
: 

@@ -219,103 +209,97 @@
 
 // list all available frontend users and put into temp array
 $sql = "SELECT * FROM ".DB_PREPEND."phpwcms_user WHERE usr_aktiv != 9 ORDER BY usr_fe, usr_name, usr_login";
-if($result = mysql_query($sql, $db) or die("error while listing frontend users")) {
-	$_temp_usr = array();
-	while($row = mysql_fetch_assoc($result)) {
-		$_temp_usr[$row['usr_id']]['name']   = html($row['usr_name']);
-		$_temp_usr[$row['usr_id']]['login']  = html($row['usr_login']);
-		$_temp_usr[$row['usr_id']]['fe']     = $row['usr_fe'];
-		$_temp_usr[$row['usr_id']]['active'] = $row['usr_aktiv'];
-		$_temp_usr[$row['usr_id']]['admin'] = $row['usr_admin'];
-	}
-	mysql_free_result($result);
+$result = _dbQuery($sql);
+$_temp_usr = array();
+if(isset($result[0]['usr_id'])) {
+    foreach($result as $row) {
+        $_temp_usr[$row['usr_id']]['name']   = html($row['usr_name']);
+        $_temp_usr[$row['usr_id']]['login']  = html($row['usr_login']);
+        $_temp_usr[$row['usr_id']]['fe']     = $row['usr_fe'];
+        $_temp_usr[$row['usr_id']]['active'] = $row['usr_aktiv'];
+        $_temp_usr[$row['usr_id']]['admin'] = $row['usr_admin'];
+    }
 }
 
 ?>
-			
+            


 $value) {
-	if (isset($group["member"]) && empty($group["error"])) {
-    if(in_array($key, $group["member"])) {
-  		echo ''.trim($_temp_usr[$key]['name']. ' ('.$_temp_usr[$key]['login'].')')."\n";
-  		unset($_temp_usr[$key]);
-  	}
-  }
-}
+    if(count($_temp_usr)) {
+        // list all fe_users
+        foreach($_temp_usr as $key => $value) {
+            if(isset($group["member"]) && empty($group["error"])) {
+                if(in_array($key, $group["member"])) {
+                    echo ''.trim($_temp_usr[$key]['name']. ' ('.$_temp_usr[$key]['login'].')')."\n";
+                    unset($_temp_usr[$key]);
+                }
+            }
+        }
+    }
 
 ?>
-		
+        


 $value) {
-		echo ''.trim($_temp_usr[$key]['name']. ' ('.$_temp_usr[$key]['login'].')')."\n";
-	}
-}
+    // list all available fe_users
+    if(count($_temp_usr)) {
+        foreach($_temp_usr as $key => $value) {
+            echo ''.trim($_temp_usr[$key]['name']. ' ('.$_temp_usr[$key]['login'].')')."\n";
+        }
+    }
 
 ?>
-		
+        



 
-
-
      
 
-
-
-
-
-
-			
-		    
-		      : 
-		      
+            
+            
+              : 
+              

 />
  


-		      
-		    
-		    
-		    
-		      
-			   
-			  " />
-			  
-			  
-		      
-			  
-		        
-		      
-		      
-		    
-		  
-		  
-		  
-		  
+              
+            
+            
+            
+              
+               
+              " />
+              
+              
+              
+              
+                
+              
+              
+            
+          
+          
+          
+          


\ No newline at end of file
diff --git a/include/inc_tmpl/admin.newuser.tmpl.php b/include/inc_tmpl/admin.newuser.tmpl.php
index 483433b37..e29a314b2 100644
--- a/include/inc_tmpl/admin.newuser.tmpl.php
+++ b/include/inc_tmpl/admin.newuser.tmpl.php
@@ -12,83 +12,82 @@
 // ----------------------------------------------------------------
 // obligate check for phpwcms constants
 if (!defined('PHPWCMS_ROOT')) {
-	die("You Cannot Access This Script Directly, Have a Nice Day.");
+    die("You Cannot Access This Script Directly, Have a Nice Day.");
 }
 // ----------------------------------------------------------------
 
-
-$new_login 			= genlogname();
-$new_password 		= generic_string(8);
-$new_email			= '';
-$new_name			= '';
-$set_user_aktiv 	= 0;
-$set_user_admin 	= 0;
-$set_user_fe		= 0;
-$send_verification	= 1;
-$user_err			= '';
+$new_login          = genlogname();
+$new_password       = generic_string(8);
+$new_email          = '';
+$new_name           = '';
+$set_user_aktiv     = 0;
+$set_user_admin     = 0;
+$set_user_fe        = 0;
+$send_verification  = 1;
+$user_err           = '';
 
 if(isset($_POST["form_aktion"]) && $_POST["form_aktion"] == "create_account") {
-	//Create Account Daten verarbeiten
-	$new_login 			= slweg($_POST["form_newloginname"]);
-	$new_password 		= slweg($_POST["form_newpassword"]);
-	$new_email 			= clean_slweg($_POST["form_newemail"]);
-	$new_name 			= clean_slweg($_POST["form_newrealname"]);
-	$set_user_aktiv 	= isset($_POST["form_active"]) ? 1 : 0;
-	$set_user_admin 	= isset($_POST["form_admin"]) ? 1 : 0;
-	$set_user_fe 		= isset($_POST["form_feuser"]) ? intval($_POST["form_feuser"]) : 0;
-	if($set_user_admin) {
-		$set_user_fe 	= 2;
-	}
-	$send_verification 	= isset($_POST["verification_email"]) ? 1 : 0;
-	if(str_empty($new_login)) {
-		$user_err = $BL['be_admin_usr_err2']."\n";
-	} else {
-		$sql = "SELECT COUNT(*) AS anzahl FROM ".DB_PREPEND."phpwcms_user WHERE usr_login='".aporeplace($new_login)."'";
-		if($result = mysql_query($sql, $db)) {
-			if($check_anzahl = mysql_fetch_array($result)) {
-				if($check_anzahl["anzahl"]) $user_err .= $BL['be_admin_usr_err1']."\n";
-			}
-			mysql_free_result($result);
-		}
-	}
-	if(str_empty($new_password)) $user_err .= $BL['be_admin_usr_err3']."\n";
-	if(!is_valid_email($new_email) && $send_verification) $user_err .= $BL['be_admin_usr_err4']."\n";
-	if(empty($user_err)) { //Insert new User
-		$sql =	"INSERT INTO ".DB_PREPEND."phpwcms_user (usr_login, usr_pass, usr_email, ".
-				"usr_admin, usr_aktiv, usr_name, usr_wysiwyg, usr_fe ) VALUES ('".
-				aporeplace($new_login)."', '".
-				aporeplace(md5(makeCharsetConversion($new_password, PHPWCMS_CHARSET, 'utf-8')))."', '".
-				aporeplace($new_email)."', '".
-				$set_user_admin."', '".
-				$set_user_aktiv."', '".
-				aporeplace($new_name)."', 1, '".
-				$set_user_fe."')";
-		if(mysql_query($sql, $db) or die('error while creating new user')) {
-			$new_user_id = mysql_insert_id($db);
-			$user_ok = 1;
-			if($send_verification) {
-				$emailbody = str_replace('{LOGIN}', $new_login, $BL['be_admin_usr_mailbody']);
-				$emailbody = str_replace('{PASSWORD}', $new_password, $emailbody);
-				$emailbody = str_replace('{SITE}', PHPWCMS_URL, $emailbody);
-				$emailbody = str_replace('{LOGIN_PAGE}', PHPWCMS_URL.get_login_file(), $emailbody);
+    //Create Account Daten verarbeiten
+    $new_login          = slweg($_POST["form_newloginname"]);
+    $new_password       = slweg($_POST["form_newpassword"]);
+    $new_email          = clean_slweg($_POST["form_newemail"]);
+    $new_name           = clean_slweg($_POST["form_newrealname"]);
+    $set_user_aktiv     = isset($_POST["form_active"]) ? 1 : 0;
+    $set_user_admin     = isset($_POST["form_admin"]) ? 1 : 0;
+    $set_user_fe        = isset($_POST["form_feuser"]) ? intval($_POST["form_feuser"]) : 0;
+    if($set_user_admin) {
+        $set_user_fe = 2;
+    }
+    $send_verification  = isset($_POST["verification_email"]) ? 1 : 0;
+    if(empty($new_login)) {
+        $user_err .= $BL['be_admin_usr_err2']."\n";
+    } elseif(($check_anzahl = _dbQuery("SELECT COUNT(*) FROM ".DB_PREPEND."phpwcms_user WHERE usr_login='".aporeplace($new_login)."'", 'COUNT'))) {
+        $user_err .= $BL['be_admin_usr_err1']."\n";
+    }
+    if(empty($new_password)) {
+        $user_err .= $BL['be_admin_usr_err3']."\n";
+    }
+    if(!is_valid_email($new_email) && $send_verification) {
+        $user_err .= $BL['be_admin_usr_err4']."\n";
+    }
+    if(empty($user_err)) { //Insert new User
+        $sql =  "INSERT INTO ".DB_PREPEND."phpwcms_user (usr_login, usr_pass, usr_email, ".
+                "usr_admin, usr_aktiv, usr_name, usr_wysiwyg, usr_fe ) VALUES ('".
+                aporeplace($new_login)."', '".
+                aporeplace(md5(makeCharsetConversion($new_password, PHPWCMS_CHARSET, 'utf-8')))."', '".
+                aporeplace($new_email)."', '".
+                $set_user_admin."', '".
+                $set_user_aktiv."', '".
+                aporeplace($new_name)."', 1, '".
+                $set_user_fe."')";
+        $result = _dbQuery($sql, 'INSERT');
+
+        if(!empty($result['INSERT_ID'])) {
+            $new_user_id = $result['INSERT_ID'];
+            $user_ok = 1;
+            if($send_verification) {
+                $emailbody = str_replace('{LOGIN}', $new_login, $BL['be_admin_usr_mailbody']);
+                $emailbody = str_replace('{PASSWORD}', $new_password, $emailbody);
+                $emailbody = str_replace('{SITE}', PHPWCMS_URL, $emailbody);
+                $emailbody = str_replace('{LOGIN_PAGE}', PHPWCMS_URL.get_login_file(), $emailbody);
 
-				sendEmail(	array(
-					'recipient'	=> $new_email,
-					'toName'	=> $new_name,
-					'subject'	=> $BL['be_admin_usr_mailsubject'],
-					'isHTML'	=> 0,
-					'text'		=> $emailbody,
-					'from'		=> $phpwcms["admin_email"],
-					'sender'	=> $phpwcms["admin_email"]
-				));
-			}
-		}
-	}
+                sendEmail(  array(
+                    'recipient' => $new_email,
+                    'toName'    => $new_name,
+                    'subject'   => $BL['be_admin_usr_mailsubject'],
+                    'isHTML'    => 0,
+                    'text'      => $emailbody,
+                    'from'      => $phpwcms["admin_email"],
+                    'sender'    => $phpwcms["admin_email"]
+                ));
+            }
+        }
+    }
 }
 
 if(empty($user_ok)) {
 
-?>
+?>



@@ -101,49 +100,49 @@
             


-		  
+          

-            : 
-            
+            : 
+            


-		  
+          

: 
-            
+            



: 
-            
+            



: 
-            
+            



: 
-            
+            

 
-		  
+          

: 


-                  >
+                   />
  
-				  >
+                   />
  
-				  >
+                   />

-				  
+                  



@@ -153,7 +152,7 @@
             : 


-                  >
+                   />



@@ -164,8 +163,8 @@
             : 


-                  >
-                   !!!
+                   />
+                   !!!



@@ -181,17 +180,15 @@
                 


-          
+          

 
-            
+            


 timer=setTimeout(\"self.location.href='phpwcms.php'+'?".CSRF_GET_TOKEN."&do=admin'\", 0); ";
+    echo "";
 }
-
-?>
\ No newline at end of file
