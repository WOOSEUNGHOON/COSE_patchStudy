c2808a0493243f618bbbb3459af23c7da3dc5485
openemr@@openemr@@pull@@1757
diff --git a/ccdaservice/ccda_gateway.php b/ccdaservice/ccda_gateway.php
index fee7faeae22..6efc575bec3 100644
--- a/ccdaservice/ccda_gateway.php
+++ b/ccdaservice/ccda_gateway.php
@@ -128,10 +128,10 @@ function checkService($ip = "localhost", $port = '6661')
     if ($result === false) {
         $path = $GLOBALS['fileroot'] . "/ccdaservice";
         if (IS_WINDOWS) {
-            $cmd = "node " . $path . "/serveccda.js";
+            $cmd = "node " . escapeshellarg($path . "/serveccda.js");
             pclose(popen("start /B " . $cmd, "r"));
         } else {
-            $cmd = "nodejs " . $path . "/serveccda.js";
+            $cmd = "nodejs " . escapeshellarg($path . "/serveccda.js");
             exec($cmd . " > /dev/null &");
         }
         sleep(2); // give cpu a rest
diff --git a/interface/billing/sl_eob_search.php b/interface/billing/sl_eob_search.php
index cc520babfb4..b7ec69064be 100644
--- a/interface/billing/sl_eob_search.php
+++ b/interface/billing/sl_eob_search.php
@@ -560,7 +560,7 @@ function upload_file_to_client_pdf($file_to_send, $aPatFirstName = '', $aPatID =
         if ($DEBUG) {
             $alertmsg = xl("Printing skipped; see test output in") .' '. $STMT_TEMP_FILE;
         } else {
-            exec("$STMT_PRINT_CMD $STMT_TEMP_FILE");
+            exec(escapeshellcmd($STMT_PRINT_CMD) . " " . escapeshellarg($STMT_TEMP_FILE));
             if ($_POST['form_without']) {
                 $alertmsg = xl('Now printing') .' '. $stmt_count .' '. xl('statements; invoices will not be updated.');
             } else {
@@ -705,13 +705,13 @@ function npopup(pid) {
                           


-                                   
+                                  





-                        
+
                         


@@ -755,11 +755,11 @@ function npopup(pid) {
                     


-                             
+                            


                                         Browse…
-                                         
+                                        



@@ -771,9 +771,9 @@ function npopup(pid) {
                 


-                            
-                            


@@ -802,7 +802,7 @@ function npopup(pid) {
                                     exec("unzip -p $tmp_name.zip > $tmp_name");
                                     unlink("$tmp_name.zip");
                                 }
-                                
+
                                 echo "\n";
@@ -1055,14 +1055,14 @@ function npopup(pid) {
                                 

-                                    

-                                    


-                                    

 
+    ?>
     

@@ -133,7 +133,7 @@ function check_search_str()
    '
     title='' />
     
-   ' />  
+   ' />
    


@@ -152,9 +152,9 @@ function check_search_str()
     $search_term = $_REQUEST['search_term'];
     {
     $query = "SELECT count(*) as count FROM drugs " .
-      "WHERE (drug_id LIKE '%$search_term%' OR " .
-      "name LIKE '%$search_term%') ";
-    $res = sqlStatement($query);
+      "WHERE (drug_id LIKE ? OR " .
+      "name LIKE ?) ";
+    $res = sqlStatement($query, array('%'.$search_term.'%', '%'.$search_term.'%'));
     if ($row = sqlFetchArray($res)) {
         $no_of_items = addslashes($row['count']);
         if ($no_of_items < 1) {
@@ -165,15 +165,15 @@ function check_search_str()
             echo xl('Please enter new search string');?>");
         document.theform.search_term.value=" ";
         document.theform.search_term.focus();
-            
+        


' onclick="chkbox_select_all(document.select_drug.chkbox);"/>
- 
+
  ' onclick="chkbox_select_none(document.select_drug.chkbox);"/>
- 
+
  ' onclick="window_submit(document.select_drug.chkbox);"/>
- 
+
  ' onclick="window_close();"/>
- 
+



diff --git a/interface/de_identification_forms/find_immunization_popup.php b/interface/de_identification_forms/find_immunization_popup.php
index f03e17614dc..85e57565cc6 100644
--- a/interface/de_identification_forms/find_immunization_popup.php
+++ b/interface/de_identification_forms/find_immunization_popup.php
@@ -144,8 +144,8 @@ function check_search_str()
   $search_term = $_REQUEST['search_term'];
   {
     $query = "SELECT count(*) as count FROM list_options " .
-      "WHERE (list_id = 'immunizations' and title LIKE '%$search_term%' AND activity = 1) " ;
-    $res = sqlStatement($query);
+      "WHERE (list_id = 'immunizations' and title LIKE ? AND activity = 1) " ;
+    $res = sqlStatement($query, array('%'.$search_term.'%'));
 if ($row = sqlFetchArray($res)) {
     $no_of_items = addslashes($row['count']);
     if ($no_of_items < 1) {
@@ -161,9 +161,9 @@ function check_search_str()
     }
 
     $query = "SELECT option_id,title FROM list_options " .
-    "WHERE (list_id = 'immunizations' and title LIKE '%$search_term%' AND activity = 1) " .
+    "WHERE (list_id = 'immunizations' and title LIKE ? AND activity = 1) " .
     "ORDER BY title";
-    $res = sqlStatement($query);
+    $res = sqlStatement($query, array('%'.$search_term.'%'));
     $row_count = 0;
     while ($row = sqlFetchArray($res)) {
         $row_count = $row_count + 1;
diff --git a/interface/fax/fax_dispatch.php b/interface/fax/fax_dispatch.php
index c4eeff9a4a2..4cc71a070e6 100644
--- a/interface/fax/fax_dispatch.php
+++ b/interface/fax/fax_dispatch.php
@@ -314,7 +314,7 @@ function mergeTiffs()
         $cpstring = str_replace('{MESSAGE}', $form_message, $cpstring);
         fwrite($tmph, $cpstring);
         fclose($tmph);
-        $tmp0 = exec("cd $webserver_root/custom; " . $GLOBALS['hylafax_enscript'] .
+        $tmp0 = exec("cd $webserver_root/custom; " . escapeshellcmd($GLOBALS['hylafax_enscript']) .
         " -o $tmpfn2 $tmpfn1", $tmp1, $tmp2);
         if ($tmp2) {
               $info_msg .= "enscript returned $tmp2: $tmp0 ";
diff --git a/interface/fax/faxq.php b/interface/fax/faxq.php
index 6b6ad130909..947281ecfb9 100644
--- a/interface/fax/faxq.php
+++ b/interface/fax/faxq.php
@@ -29,7 +29,7 @@
 if ($GLOBALS['enable_hylafax']) {
 // Get the recvq entries, parse and sort by filename.
     $statlines = array();
-    exec("faxstat -r -l -h " . $GLOBALS['hylafax_server'], $statlines);
+    exec("faxstat -r -l -h " . escapeshellarg($GLOBALS['hylafax_server']), $statlines);
     foreach ($statlines as $line) {
         // This gets pagecount, sender, time, filename.  We are expecting the
         // string to start with "-rw-rw-" so as to exclude faxes not yet fully
diff --git a/interface/main/daemon_frame.php b/interface/main/daemon_frame.php
index bee67e1894e..13f4d754750 100644
--- a/interface/main/daemon_frame.php
+++ b/interface/main/daemon_frame.php
@@ -24,7 +24,7 @@
  $faxcount = 0;
 if ($GLOBALS['enable_hylafax']) {
     $statlines = array();
-    exec("faxstat -r -l -h " . $GLOBALS['hylafax_server'], $statlines);
+    exec("faxstat -r -l -h " . escapeshellarg($GLOBALS['hylafax_server']), $statlines);
     foreach ($statlines as $line) {
         if (substr($line, 0, 1) == '-') {
             ++$faxcount;
diff --git a/interface/patient_file/encounter/search_code.php b/interface/patient_file/encounter/search_code.php
index 4e8d038be16..f94c53256ff 100644
--- a/interface/patient_file/encounter/search_code.php
+++ b/interface/patient_file/encounter/search_code.php
@@ -4,8 +4,8 @@
 // THIS MODULE REPLACES cptcm_codes.php, hcpcs_codes.php AND icd9cm_codes.php.
 ////////////////////////////////////////////////////////////////////////////////
 
-include_once("../../globals.php");
-include_once("../../../custom/code_types.inc.php");
+require_once("../../globals.php");
+require_once("../../../custom/code_types.inc.php");
 
 //the maximum number of records to pull out with the search:
 $M = 30;
@@ -58,18 +58,18 @@
 
   // The above is obsolete now, fees come from the prices table:
     $sql = "SELECT codes.*, prices.pr_price FROM codes " .
-    "LEFT OUTER JOIN patient_data ON patient_data.pid = '$pid' " .
+    "LEFT OUTER JOIN patient_data ON patient_data.pid = ? " .
     "LEFT OUTER JOIN prices ON prices.pr_id = codes.id AND " .
     "prices.pr_selector = '' AND " .
     "prices.pr_level = patient_data.pricelevel " .
-    "WHERE (code_text LIKE '%" . $_POST["text"] . "%' OR " .
-    "code LIKE '%" . $_POST["text"] . "%') AND " .
-    "code_type = '" . $code_types[$code_type]['id'] . "' " .
+    "WHERE (code_text LIKE ? OR " .
+    "code LIKE ?) AND " .
+    "code_type = ? " .
     "ORDER BY code ".
     " LIMIT " . ($M + 1).
     "";
 
-    if ($res = sqlStatement($sql)) {
+    if ($res = sqlStatement($sql, array($pid, "%".$_POST["text"]."%", "%".$_POST["text"]."%", $code_types[$code_type]['id']))) {
         for ($iter=0; $row=sqlFetchArray($res); $iter++) {
             $result[$iter] = $row;
         }
diff --git a/interface/super/manage_site_files.php b/interface/super/manage_site_files.php
index 2543d7a4df0..c0b5b4e7bba 100644
--- a/interface/super/manage_site_files.php
+++ b/interface/super/manage_site_files.php
@@ -70,6 +70,11 @@
             die(htmlspecialchars(xl('Cannot find a destination filename')));
         }
 
+        $path_parts = pathinfo($form_dest_filename);
+        if (in_array(strtolower($path_parts['extension']), array('gif','jpg','jpe','jpeg','png','svg'))) {
+            die(xl('Only images files are accepted'));
+        }
+
         $imagepath = "$imagedir/$form_dest_filename";
         // If the site's image directory does not yet exist, create it.
         if (!is_dir($imagedir)) {
diff --git a/library/forms.inc b/library/forms.inc
index df91b37d432..abf79c15eb4 100644
--- a/library/forms.inc
+++ b/library/forms.inc
@@ -164,8 +164,8 @@ function getProviderIdOfEncounter($encounter)
 {
         global $attendant_type;
         $table = $attendant_type == 'pid' ? 'form_encounter' : 'form_groups_encounter';
-        $sql = "select provider_id from $table where encounter='$encounter' order by date";
-        $res = sqlQuery($sql);
+        $sql = "select provider_id from $table where encounter=? order by date";
+        $res = sqlQuery($sql, array($encounter));
         return $res['provider_id'];
 }
 
diff --git a/library/registry.inc b/library/registry.inc
index ede859aac94..c4e81ac8304 100644
--- a/library/registry.inc
+++ b/library/registry.inc
@@ -58,8 +58,8 @@ function getRegistered($state = "1", $limit = "unlimited", $offset = "0")
 
 function getRegistryEntry($id, $cols = "*")
 {
-    $sql = "select $cols from registry where id='$id'";
-    return sqlQuery($sql);
+    $sql = "select $cols from registry where id=?";
+    return sqlQuery($sql, array($id));
 }
 
 function getRegistryEntryByDirectory($directory, $cols = "*")
diff --git a/patients/add_edit_event_user.php b/patients/add_edit_event_user.php
index 874cd198d12..b267a229bd8 100644
--- a/patients/add_edit_event_user.php
+++ b/patients/add_edit_event_user.php
@@ -127,7 +127,7 @@
     $facility = sqlQuery("SELECT pc_facility, pc_multiple, pc_aid, facility.name
                             FROM openemr_postcalendar_events
                               LEFT JOIN facility ON (openemr_postcalendar_events.pc_facility = facility.id)
-                              WHERE pc_eid = $eid");
+                              WHERE pc_eid = ?", array($eid));
     if (!$facility['pc_facility']) {
         $qmin = sqlQuery("SELECT facility_id as minId, facility FROM users WHERE id = ".$facility['pc_aid']);
         $min  = $qmin['minId'];
@@ -141,7 +141,7 @@
 
         // EOS multiple
 
-        sqlStatement("UPDATE openemr_postcalendar_events SET pc_facility = $min WHERE pc_eid = $eid");
+        sqlStatement("UPDATE openemr_postcalendar_events SET pc_facility = ? WHERE pc_eid = ?", array($min, $eid));
         $e2f = $min;
         $e2f_name = $min_name;
     } else {
@@ -298,7 +298,7 @@
 ========================================================*/
     if ($eid) {
         // what is multiple key around this $eid?
-        $row = sqlQuery("SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = $eid");
+        $row = sqlQuery("SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = ?", array($eid));
 
         if ($GLOBALS['select_multi_providers'] && $row['pc_multiple']) {
             /* ==========================================
@@ -408,7 +408,7 @@
                 "pc_apptstatus = '"  . $_POST['form_apptstatus']           . "', "  .
                 "pc_prefcatid = '"   . $_POST['form_prefcat']              . "' ,"  .
                  "pc_facility = '"   .(int)$_POST['facility']               ."' "  . // FF stuff
-                "WHERE pc_eid = '$eid'");
+                "WHERE pc_eid = '" . add_escape_custom($eid) . "'");
         }
 
     // =======================================
@@ -546,18 +546,18 @@
       // =======================================
     if ($GLOBALS['select_multi_providers']) {
         // what is multiple key around this $eid?
-        $row = sqlQuery("SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = $eid");
+        $row = sqlQuery("SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = ?", array($eid));
         if ($row['pc_multiple']) {
             sqlStatement("DELETE FROM openemr_postcalendar_events WHERE pc_multiple = {$row['pc_multiple']}");
         } else {
-                        sqlStatement("DELETE FROM openemr_postcalendar_events WHERE pc_eid = $eid");
+                        sqlStatement("DELETE FROM openemr_postcalendar_events WHERE pc_eid = ?", array($eid));
         }
 
         // =======================================
         //  EOS multi providers case
         // =======================================
     } else {
-        sqlStatement("DELETE FROM openemr_postcalendar_events WHERE pc_eid = '$eid'");
+        sqlStatement("DELETE FROM openemr_postcalendar_events WHERE pc_eid = ?", array($eid));
     }
 }
 
@@ -603,7 +603,7 @@
 
 // If we are editing an existing event, then get its data.
 if ($eid) {
-    $row = sqlQuery("SELECT * FROM openemr_postcalendar_events WHERE pc_eid = $eid");
+    $row = sqlQuery("SELECT * FROM openemr_postcalendar_events WHERE pc_eid = ?", array($eid));
     $date = $row['pc_eventDate'];
     $userid = $row['pc_aid'];
     $patientid = $row['pc_pid'];
@@ -631,7 +631,7 @@
  // If we have a patient ID, get the name and phone numbers to display.
 if ($patientid) {
     $prow = sqlQuery("SELECT lname, fname, phone_home, phone_biz, DOB " .
-        "FROM patient_data WHERE pid = '" . $patientid . "'");
+        "FROM patient_data WHERE pid = ?", array($patientid));
     $patientname = $prow['lname'] . ", " . $prow['fname'];
     if ($prow['phone_home']) {
         $patienttitle .= " H=" . $prow['phone_home'];
@@ -650,7 +650,7 @@
 //(CHEMED)
 //Set default facility for a new event based on the given 'userid'
 if ($userid) {
-    $pref_facility = sqlFetchArray(sqlStatement("SELECT facility_id, facility FROM users WHERE id = $userid"));
+    $pref_facility = sqlFetchArray(sqlStatement("SELECT facility_id, facility FROM users WHERE id = ?", array($userid)));
     $e2f = $pref_facility['facility_id'];
     $e2f_name = $pref_facility['facility'];
 }
@@ -941,7 +941,7 @@ function deleteEvent() {
 
 
 
-
+


 
@@ -995,7 +995,7 @@ function deleteEvent() {
   


-   
+   


     
diff --git a/patients/find_appt_popup_user.php b/patients/find_appt_popup_user.php
index a543d1aff0b..97dbd7931e3 100644
--- a/patients/find_appt_popup_user.php
+++ b/patients/find_appt_popup_user.php
@@ -97,7 +97,7 @@ function doOneDay($catid, $udate, $starttime, $duration, $prefcatid)
 
  $catslots = 1;
 if ($input_catid) {
-    $srow = sqlQuery("SELECT pc_duration FROM openemr_postcalendar_categories WHERE pc_catid = '$input_catid'");
+    $srow = sqlQuery("SELECT pc_duration FROM openemr_postcalendar_categories WHERE pc_catid = ?", array($input_catid));
     if ($srow['pc_duration']) {
         $catslots = ceil($srow['pc_duration'] / $slotsecs);
     }
@@ -158,10 +158,10 @@ function doOneDay($catid, $udate, $starttime, $duration, $prefcatid)
     $query = "SELECT pc_eventDate, pc_endDate, pc_startTime, pc_duration, " .
     "pc_recurrtype, pc_recurrspec, pc_alldayevent, pc_catid, pc_prefcatid, pc_title " .
     "FROM openemr_postcalendar_events " .
-    "WHERE pc_aid = '$providerid' AND " .
-    "((pc_endDate >= '$sdate' AND pc_eventDate < '$edate') OR " .
-    "(pc_endDate = '0000-00-00' AND pc_eventDate >= '$sdate' AND pc_eventDate < '$edate'))";
-    $res = sqlStatement($query);
+    "WHERE pc_aid = ? AND " .
+    "((pc_endDate >= ? AND pc_eventDate < ?) OR " .
+    "(pc_endDate = '0000-00-00' AND pc_eventDate >= ? AND pc_eventDate < ?))";
+    $res = sqlStatement($query, array($providerid, $sdate, $edate, $sdate, $edate));
 //  print_r($res);
 
     while ($row = sqlFetchArray($res)) {
@@ -391,7 +391,7 @@ function setappt(year,mon,mday,hours,minutes) {
 

-
+


diff --git a/portal/add_edit_event_user.php b/portal/add_edit_event_user.php
index b3bb7add1d0..057143190b6 100644
--- a/portal/add_edit_event_user.php
+++ b/portal/add_edit_event_user.php
@@ -262,7 +262,7 @@
 ========================================================*/
     if ($eid) {
         // what is multiple key around this $eid?
-        $row = sqlQuery("SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = $eid");
+        $row = sqlQuery("SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = ?", array($eid));
 
         if ($GLOBALS['select_multi_providers'] && $row['pc_multiple']) {
             /* ==========================================
@@ -270,7 +270,7 @@
             ==========================================*/
 
             // obtain current list of providers regarding the multiple key
-            $up = sqlStatement("SELECT pc_aid FROM openemr_postcalendar_events WHERE pc_multiple={$row['pc_multiple']}");
+            $up = sqlStatement("SELECT pc_aid FROM openemr_postcalendar_events WHERE pc_multiple = ?", array($row['pc_multiple']));
             while ($current = sqlFetchArray($up)) {
                 $providers_current[] = $current['pc_aid'];
             }
@@ -282,7 +282,7 @@
             $r1 = array_diff($providers_current, $providers_new);
             if (count($r1)) {
                 foreach ($r1 as $to_be_removed) {
-                    sqlQuery("DELETE FROM openemr_postcalendar_events WHERE pc_aid='$to_be_removed' AND pc_multiple={$row['pc_multiple']}");
+                    sqlQuery("DELETE FROM openemr_postcalendar_events WHERE pc_aid = ? AND pc_multiple = ?", array($to_be_removed, $row['pc_multiple']));
                 }
             }
 
@@ -293,25 +293,25 @@
                 foreach ($r2 as $to_be_inserted) {
                     sqlInsert("INSERT INTO openemr_postcalendar_events ( pc_catid, pc_multiple, pc_aid, pc_pid, pc_title, pc_time, pc_hometext, pc_informant, pc_eventDate, pc_endDate, pc_duration, pc_recurrtype, pc_recurrspec, pc_startTime, pc_endTime, pc_alldayevent, pc_apptstatus, pc_prefcatid, pc_location, pc_eventstatus, pc_sharing, pc_facility)
                 VALUES ( " .
-                    "'" . $_POST['form_category']             . "', " .
-                    "'" . $row['pc_multiple']             . "', " .
-                    "'" . $to_be_inserted            . "', " .
-                    "'" . $_POST['form_pid']                  . "', " .
-                    "'" . add_escape_custom($_POST['form_title'])               . "', " .
-                    "NOW(), "                                         .
-                    "'" . add_escape_custom($_POST['form_comments'])             . "', " .
-                    "'" . $_SESSION['providerId']             . "', " .
-                    "'" . $event_date                         . "', " .
-                    "'" . fixDate($_POST['form_enddate'])     . "', " .
-                    "'" . ($duration * 60)                    . "', " .
-                    "'" . ($_POST['form_repeat'] ? '1' : '0') . "', " .
-                    "'$recurrspec', "                                 .
-                    "'$starttime', "                                  .
-                    "'$endtime', "                                    .
-                    "'" . $_POST['form_allday']               . "', " .
-                    "'" . $_POST['form_apptstatus']           . "', " .
-                    "'" . $_POST['form_prefcat']              . "', " .
-                    "'$locationspec', "                               .
+                    "'" . add_escape_custom($_POST['form_category'])         . "', " .
+                    "'" . add_escape_custom($row['pc_multiple'])             . "', " .
+                    "'" . add_escape_custom($to_be_inserted)                 . "', " .
+                    "'" . add_escape_custom($_POST['form_pid'])              . "', " .
+                    "'" . add_escape_custom($_POST['form_title'])            . "', " .
+                    "NOW(), "                                                .
+                    "'" . add_escape_custom($_POST['form_comments'])         . "', " .
+                    "'" . add_escape_custom($_SESSION['providerId'])         . "', " .
+                    "'" . add_escape_custom($event_date)                     . "', " .
+                    "'" . add_escape_custom(fixDate($_POST['form_enddate'])) . "', " .
+                    "'" . add_escape_custom(($duration * 60))                . "', " .
+                    "'" . ($_POST['form_repeat'] ? '1' : '0')                . "', " .
+                    "'" . add_escape_custom($recurrspec)                     . "', " .
+                    "'" . add_escape_custom($starttime)                      . "', " .
+                    "'" . add_escape_custom($endtime)                        . "', " .
+                    "'" . add_escape_custom($_POST['form_allday'])           . "', " .
+                    "'" . add_escape_custom($_POST['form_apptstatus'])       . "', " .
+                    "'" . add_escape_custom($_POST['form_prefcat'])          . "', " .
+                    "'" . add_escape_custom($locationspec)                   . "', " .
                     "1, " .
                     "1, " .(int)$_POST['facility']. " )"); // FF stuff
                 } // foreach
@@ -322,24 +322,24 @@
          // those who are intersected in $providers_current and $providers_new
             foreach ($_POST['form_provider_ae'] as $provider) {
                      sqlStatement("UPDATE openemr_postcalendar_events SET " .
-                     "pc_catid = '"       . $_POST['form_category']             . "', " .
-                     "pc_pid = '"         . $_POST['form_pid']                  . "', " .
-                     "pc_title = '"       . add_escape_custom($_POST['form_title'])               . "', " .
-                     "pc_time = NOW(), "                                                .
-                     "pc_hometext = '"    . add_escape_custom($_POST['form_comments'])             . "', " .
-                     "pc_informant = '"   . $_SESSION['providerId']             . "', " .
-                     "pc_eventDate = '"   . $event_date                         . "', " .
-                     "pc_endDate = '"     . fixDate($_POST['form_enddate'])     . "', " .
-                     "pc_duration = '"    . ($duration * 60)                    . "', " .
-                     "pc_recurrtype = '"  . ($_POST['form_repeat'] ? '1' : '0') . "', " .
-                     "pc_recurrspec = '$recurrspec', "                                  .
-                     "pc_startTime = '$starttime', "                                    .
-                     "pc_endTime = '$endtime', "                                        .
-                     "pc_alldayevent = '" . $_POST['form_allday']               . "', " .
-                     "pc_apptstatus = '"  . $_POST['form_apptstatus']           . "', "  .
-                     "pc_prefcatid = '"   . $_POST['form_prefcat']              . "' ,"  .
-                      "pc_facility = '"   .(int)$_POST['facility']               ."' "  . // FF stuff
-                       "WHERE pc_aid = '$provider' AND pc_multiple={$row['pc_multiple']}");
+                     "pc_catid = '"       . add_escape_custom($_POST['form_category'])   . "', " .
+                     "pc_pid = '"         . add_escape_custom($_POST['form_pid'])        . "', " .
+                     "pc_title = '"       . add_escape_custom($_POST['form_title'])      . "', " .
+                     "pc_time = NOW(), "                                                 .
+                     "pc_hometext = '"    . add_escape_custom($_POST['form_comments'])   . "', " .
+                     "pc_informant = '"   . add_escape_custom($_SESSION['providerId'])   . "', " .
+                     "pc_eventDate = '"   . add_escape_custom($event_date)               . "', " .
+                     "pc_endDate = '"     . add_escape_custom(fixDate($_POST['form_enddate'])) . "', " .
+                     "pc_duration = '"    . add_escape_custom(($duration * 60))          . "', " .
+                     "pc_recurrtype = '"  . ($_POST['form_repeat'] ? '1' : '0')          . "', "  .
+                     "pc_recurrspec = '"  . add_escape_custom($recurrspec)               . "', " .
+                     "pc_startTime = '"   . add_escape_custom($starttime)                . "', " .
+                     "pc_endTime = '"     . add_escape_custom($endtime)                  . "', " .
+                     "pc_alldayevent = '" . add_escape_custom($_POST['form_allday'])     . "', " .
+                     "pc_apptstatus = '"  . add_escape_custom($_POST['form_apptstatus']) . "', "  .
+                     "pc_prefcatid = '"   . add_escape_custom($_POST['form_prefcat'])    . "', "  .
+                     "pc_facility = '"    . (int)$_POST['facility']                      . "' "  . // FF stuff
+                     "WHERE pc_aid = '"   . add_escape_custom($provider) . "' AND pc_multiple='" . add_escape_custom($row['pc_multiple']) . "'");
             } // foreach
 
       /* ==========================================
@@ -354,25 +354,25 @@
 
                 // simple provider case
                 sqlStatement("UPDATE openemr_postcalendar_events SET " .
-                "pc_catid = '"       . $_POST['form_category']             . "', " .
-                "pc_aid = '"         . $prov            . "', " .
-                "pc_pid = '"         . $_POST['form_pid']                  . "', " .
-                "pc_title = '"       . add_escape_custom($_POST['form_title'])               . "', " .
-                "pc_time = NOW(), "                                                .
-                "pc_hometext = '"    . add_escape_custom($_POST['form_comments'])          . "', " .
-                "pc_informant = '"   . $_SESSION['providerId']             . "', " .
-                "pc_eventDate = '"   . $event_date                         . "', " .
-                "pc_endDate = '"     . fixDate($_POST['form_enddate'])     . "', " .
-                "pc_duration = '"    . ($duration * 60)                    . "', " .
-                "pc_recurrtype = '"  . ($_POST['form_repeat'] ? '1' : '0') . "', " .
-                "pc_recurrspec = '$recurrspec', "                                  .
-                "pc_startTime = '$starttime', "                                    .
-                "pc_endTime = '$endtime', "                                        .
-                "pc_alldayevent = '" . $_POST['form_allday']               . "', " .
-                "pc_apptstatus = '"  . $_POST['form_apptstatus']           . "', "  .
-                "pc_prefcatid = '"   . $_POST['form_prefcat']              . "' ,"  .
-                 "pc_facility = '"   .(int)$_POST['facility']               ."' "  . // FF stuff
-                "WHERE pc_eid = '$eid'");
+                "pc_catid = '"       . add_escape_custom($_POST['form_category'])   . "', " .
+                "pc_aid = '"         . add_escape_custom($prov)                     . "', " .
+                "pc_pid = '"         . add_escape_custom($_POST['form_pid'])        . "', " .
+                "pc_title = '"       . add_escape_custom($_POST['form_title'])      . "', " .
+                "pc_time = NOW(), "                                                 .
+                "pc_hometext = '"    . add_escape_custom($_POST['form_comments'])   . "', " .
+                "pc_informant = '"   . add_escape_custom($_SESSION['providerId'])   . "', " .
+                "pc_eventDate = '"   . add_escape_custom($event_date)               . "', " .
+                "pc_endDate = '"     . add_escape_custom(fixDate($_POST['form_enddate'])) . "', " .
+                "pc_duration = '"    . add_escape_custom(($duration * 60))          . "', " .
+                "pc_recurrtype = '"  . ($_POST['form_repeat'] ? '1' : '0')          . "', " .
+                "pc_recurrspec = '"  . add_escape_custom($recurrspec)               . "', " .
+                "pc_startTime = '"   . add_escape_custom($starttime)                . "', " .
+                "pc_endTime = '"     . add_escape_custom($endtime)                  . "', " .
+                "pc_alldayevent = '" . add_escape_custom($_POST['form_allday'])     . "', " .
+                "pc_apptstatus = '"  . add_escape_custom($_POST['form_apptstatus']) . "', " .
+                "pc_prefcatid = '"   . add_escape_custom($_POST['form_prefcat'])    . "', " .
+                "pc_facility = '"    . (int)$_POST['facility']                       ."' "  . // FF stuff
+                "WHERE pc_eid = '"   . add_escape_custom($eid) . "'");
         }
 
     // =======================================
@@ -404,25 +404,25 @@
                 "pc_recurrspec, pc_startTime, pc_endTime, pc_alldayevent, " .
                 "pc_apptstatus, pc_prefcatid, pc_location, pc_eventstatus, pc_sharing, pc_facility " .
                 ") VALUES ( " .
-                "'" . $_POST['form_category']             . "', " .
-                "'" . $new_multiple_value             . "', " .
-                "'" . $provider                           . "', " .
-                "'" . $_POST['form_pid']                  . "', " .
-                "'" . add_escape_custom($_POST['form_title'])               . "', " .
-                "NOW(), "                                         .
-                "'" . add_escape_custom($_POST['form_comments'])             . "', " .
-                "'" . $_SESSION['providerId']             . "', " .
-                "'" . $event_date                         . "', " .
-                "'" . fixDate($_POST['form_enddate'])     . "', " .
-                "'" . ($duration * 60)                    . "', " .
-                "'" . ($_POST['form_repeat'] ? '1' : '0') . "', " .
-                "'$recurrspec', "                                 .
-                "'$starttime', "                                  .
-                "'$endtime', "                                    .
-                "'" . $_POST['form_allday']               . "', " .
-                "'" . $_POST['form_apptstatus']           . "', " .
-                "'" . $_POST['form_prefcat']              . "', " .
-                "'$locationspec', "                               .
+                "'" . add_escape_custom($_POST['form_category'])   . "', " .
+                "'" . add_escape_custom($new_multiple_value)       . "', " .
+                "'" . add_escape_custom($provider)                 . "', " .
+                "'" . add_escape_custom($_POST['form_pid'])        . "', " .
+                "'" . add_escape_custom($_POST['form_title'])      . "', " .
+                "NOW(), "                                          .
+                "'" . add_escape_custom($_POST['form_comments'])   . "', " .
+                "'" . add_escape_custom($_SESSION['providerId'])   . "', " .
+                "'" . add_escape_custom($event_date)               . "', " .
+                "'" . add_escape_custom(fixDate($_POST['form_enddate'])) . "', " .
+                "'" . add_escape_custom(($duration * 60))          . "', " .
+                "'" . ($_POST['form_repeat'] ? '1' : '0')          . "', " .
+                "'" . add_escape_custom($recurrspec)               . "', " .
+                "'" . add_escape_custom($starttime)                . "', " .
+                "'" . add_escape_custom($endtime)                  . "', " .
+                "'" . add_escape_custom($_POST['form_allday'])     . "', " .
+                "'" . add_escape_custom($_POST['form_apptstatus']) . "', " .
+                "'" . add_escape_custom($_POST['form_prefcat'])    . "', " .
+                "'" . add_escape_custom($locationspec)             . "', " .
                 "1, " .
                 "1, " .(int)$_POST['facility']. " )"); // FF stuff
             } // foreach
@@ -434,34 +434,34 @@
                 "pc_recurrspec, pc_startTime, pc_endTime, pc_alldayevent, " .
                 "pc_apptstatus, pc_prefcatid, pc_location, pc_eventstatus, pc_sharing, pc_facility " .
                 ") VALUES ( " .
-                "'" . $_POST['form_category'] . "', " .
-                "'" . $_POST['form_provider_ae'] . "', " .
-                "'" . $_POST['form_pid'] . "', " .
-                "'" . add_escape_custom($_POST['form_title']) . "', " .
-                "NOW(), " .
-                "'" . add_escape_custom($_POST['form_comments']) . "', " .
-                "'" . $_SESSION['providerId'] . "', " .
-                "'" . $event_date . "', " .
-                "'" . fixDate($_POST['form_enddate']) . "', " .
-                "'" . ($duration * 60) . "', " .
-                "'" . ($_POST['form_repeat'] ? '1' : '0') . "', " .
-                "'$recurrspec', " .
-                "'$starttime', " .
-                "'$endtime', " .
-                "'" . $_POST['form_allday'] . "', " .
-                "'" . $_POST['form_apptstatus'] . "', " .
-                "'" . $_POST['form_prefcat'] . "', " .
-                "'$locationspec', " .
+                "'" . add_escape_custom($_POST['form_category'])    . "', " .
+                "'" . add_escape_custom($_POST['form_provider_ae']) . "', " .
+                "'" . add_escape_custom($_POST['form_pid'])         . "', " .
+                "'" . add_escape_custom($_POST['form_title'])       . "', " .
+                "NOW(), "                                           .
+                "'" . add_escape_custom($_POST['form_comments'])    . "', " .
+                "'" . add_escape_custom($_SESSION['providerId'])    . "', " .
+                "'" . add_escape_custom($event_date)                . "', " .
+                "'" . add_escape_custom(fixDate($_POST['form_enddate'])) . "', " .
+                "'" . add_escape_custom(($duration * 60))           . "', " .
+                "'" . ($_POST['form_repeat'] ? '1' : '0')           . "', " .
+                "'" . add_escape_custom($recurrspec)                . "', " .
+                "'" . add_escape_custom($starttime)                 . "', " .
+                "'" . add_escape_custom($endtime)                   . "', " .
+                "'" . add_escape_custom($_POST['form_allday'])      . "', " .
+                "'" . add_escape_custom($_POST['form_apptstatus'])  . "', " .
+                "'" . add_escape_custom($_POST['form_prefcat'])     . "', " .
+                "'" . add_escape_custom($locationspec)              . "', " .
                 "1, " .
-                "1," . (int)$_POST['facility'] . ")"); // FF stuff
+                "1, " . (int)$_POST['facility'] . ")"); // FF stuff
         } // INSERT single
     } // else - insert
 
   // Save new DOB if it's there.
     $patient_dob = trim($_POST['form_dob']);
     if ($patient_dob && $_POST['form_pid']) {
-        sqlStatement("UPDATE patient_data SET DOB = '$patient_dob' WHERE " .
-        "pid = '" . $_POST['form_pid'] . "'");
+        sqlStatement("UPDATE patient_data SET DOB = ? WHERE " .
+        "pid = ?", array($patient_dob, $_POST['form_pid']));
     }
 
   // Auto-create a new encounter if appropriate.
@@ -476,10 +476,9 @@
 
     if (0) {
         $tmprow = sqlQuery("SELECT count(*) AS count FROM form_encounter WHERE " .
-        "pid = '" . $_POST['form_pid'] . "' AND date = '$event_date 00:00:00'");
+        "pid = ? AND date = ?", array($_POST['form_pid'], $event_date." 00:00:00"));
         if ($tmprow['count'] == 0) {
-              $tmprow = sqlQuery("SELECT username, facility, facility_id FROM users WHERE id = '" .
-            $_POST['form_provider_ae'] . "'");
+              $tmprow = sqlQuery("SELECT username, facility, facility_id FROM users WHERE id = ?", array($_POST['form_provider_ae']));
               $username = $tmprow['username'];
               $facility = $tmprow['facility'];
               $facility_id = $tmprow['facility_id'];
@@ -489,13 +488,13 @@
                   $encounter,
                   "New Patient Encounter",
                   sqlInsert("INSERT INTO form_encounter SET " .
-                  "date = '$event_date', " .
-                  "onset_date = '$event_date', " .
+                  "date = '" . add_escape_custom($event_date) . "', " .
+                  "onset_date = '" . add_escape_custom($event_date) . "', " .
                   "reason = '" . add_escape_custom($_POST['form_comments']) . "', " .
-                  "facility = '$facility', " .
-                  "facility_id = '$facility_id', " .
-                  "pid = '" . $_POST['form_pid'] . "', " .
-                  "encounter = '$encounter'"),
+                  "facility = '" . add_escape_custom($facility) . "', " .
+                  "facility_id = '" . add_escape_custom($facility_id) . "', " .
+                  "pid = '" . add_escape_custom($_POST['form_pid']) . "', " .
+                  "encounter = '" . add_escape_custom($encounter) . "'"),
                   "newpatient",
                   $_POST['form_pid'],
                   "1",
@@ -511,18 +510,18 @@
       // =======================================
     if ($GLOBALS['select_multi_providers']) {
         // what is multiple key around this $eid?
-        $row = sqlQuery("SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = $eid");
+        $row = sqlQuery("SELECT pc_multiple FROM openemr_postcalendar_events WHERE pc_eid = ?", array($eid));
         if ($row['pc_multiple']) {
-            sqlStatement("DELETE FROM openemr_postcalendar_events WHERE pc_multiple = {$row['pc_multiple']}");
+            sqlStatement("DELETE FROM openemr_postcalendar_events WHERE pc_multiple = ?", array($row['pc_multiple']));
         } else {
-                        sqlStatement("DELETE FROM openemr_postcalendar_events WHERE pc_eid = $eid");
+                        sqlStatement("DELETE FROM openemr_postcalendar_events WHERE pc_eid = ?", array($eid));
         }
 
         // =======================================
         //  EOS multi providers case
         // =======================================
     } else {
-        sqlStatement("DELETE FROM openemr_postcalendar_events WHERE pc_eid = '$eid'");
+        sqlStatement("DELETE FROM openemr_postcalendar_events WHERE pc_eid = ?", array($eid));
     }
 }
 
@@ -631,7 +630,7 @@
 

 
- 
+


@@ -639,25 +638,25 @@
 
 

-
+

-   ' />
-   ' />
+   ' />
+   ' />
 


-   : 
+   : 


-    "") ? htmlspecialchars($row['pc_title'], ENT_QUOTES) : xlt('Office Visit'); ?>' readonly='readonly'/>
+    "") ? attr($row['pc_title']) : xla('Office Visit'); ?>' readonly='readonly'/>
   


-    :
+    :


'  />
+    value=''  />
   


@@ -670,31 +669,31 @@
   


-   :
+   :


'
-    title='' readonly/> :
+    title='' readonly/> :
   '
-    title='' readonly/>  
+    title='' readonly/>  

-    
-    >
+    
+    >





-   :
+   :


-   
-   
+   
+   


     
   
-  
+  

' readonly />

@@ -703,7 +702,7 @@
     


-   :
+   :



@@ -711,14 +710,14 @@
         // present a list of providers to choose from
         // default to the currently logged-in user
 while ($urow = sqlFetchArray($ures)) {
-    echo "    " . $urow['lname'];
+    echo ">" . text($urow['lname']);
     if ($urow['fname']) {
-        echo ", " . $urow['fname'];
+        echo ", " . text($urow['fname']);
     }
 
     echo "\n";
@@ -728,20 +727,20 @@
   


-  ' onclick='find_available()' />
+  ' onclick='find_available()' />




-   :
+   :


-    ' />
+    ' />
   



-' onclick="validate()" />
+' onclick="validate()" />
  
 

@@ -764,9 +763,9 @@
         $duration = 1440;
     }
 
-    echo " durations[" . $crow['pc_catid'] . "] = $duration\n";
+    echo " durations[" . attr($crow['pc_catid']) . "] = " . text($duration) . "\n";
   // echo " rectypes[" . $crow['pc_catid'] . "] = " . $crow['pc_recurrtype'] . "\n";
-    $catoptions .= "    \n";
+    $catoptions .= ">" . text($crow['pc_catname']) . "\n";
 
   // This section is to build the list of preferred categories:
     if ($duration) {
-        $prefcat_options .= "    \n";
+        $prefcat_options .= ">" . text($crow['pc_catname']) . "\n";
     }
 }
 ?>
diff --git a/portal/find_appt_popup_user.php b/portal/find_appt_popup_user.php
index 4b5fcb388a4..6dcb3a38999 100644
--- a/portal/find_appt_popup_user.php
+++ b/portal/find_appt_popup_user.php
@@ -49,8 +49,8 @@
 
 $ignoreAuth = 1;
 
- include_once("../interface/globals.php");
- include_once("$srcdir/patient.inc");
+ require_once("../interface/globals.php");
+ require_once("$srcdir/patient.inc");
 
  $input_catid = $_REQUEST['catid'];
 
@@ -318,7 +318,7 @@ function doOneDay($catid, $udate, $starttime, $duration, $prefcatid)
 


-
+



@@ -403,19 +403,19 @@ function setappt(year,mon,mday,hours,minutes) {
 

-
+

 
-    
+    
 
-   
 
-    
-   
+   
-     
-   '>
+     
+   '>
 

@@ -430,8 +430,8 @@ function setappt(year,mon,mday,hours,minutes) {
 


-        
-        
+        
+        


\n";
     echo " \n";
 } else {
-    echo "  " . xl('No openings were found for this period.', 'e') . "\n";
+    echo "  " . xlt('No openings were found for this period.') . "\n";
 }
 ?>
 
