fe842ea5ede237443f1f45a99aeb839133115d8b
Bottelet@@DaybydayCRM
diff --git a/app/Http/Controllers/UsersController.php b/app/Http/Controllers/UsersController.php
index 3640868e9..d2893b363 100644
--- a/app/Http/Controllers/UsersController.php
+++ b/app/Http/Controllers/UsersController.php
@@ -40,6 +40,10 @@ public function index()
 
     public function calendarUsers()
     {
+        if (!auth()->user()->can('absence-view')) {
+            session()->flash('flash_message_warning', __('You do not have permission to view this page'));
+            return redirect()->back();
+        }
         return User::with(['department', 'absences' =>  function ($q) {
             return $q->whereBetween('start_at', [today()->subWeeks(2)->startOfDay(), today()->addWeeks(4)->endOfDay()])
                       ->orWhereBetween('end_at', [today()->subWeeks(2)->startOfDay(), today()->addWeeks(4)->endOfDay()]);
@@ -244,6 +248,12 @@ public function update($external_id, UpdateUserRequest $request)
         $password = bcrypt($request->password);
         $role = $request->roles;
         $department = $request->departments;
+
+        if( !auth()->user()->canChangePasswordOn($user) ) {
+            unset($request['password']);
+        }
+
+
         if ($request->hasFile('image_path')) {
             $companyname = Setting::first()->external_id;
             $file =  $request->file('image_path');
@@ -273,7 +283,9 @@ public function update($external_id, UpdateUserRequest $request)
         if ($role && $role->name == Role::OWNER_ROLE && $owners->count() <= 1) {
             Session()->flash('flash_message_warning', __('Not able to change owner role, please choose a new owner first'));
         } else {
-            $user->roles()->sync([$request->roles]);
+            if(auth()->user()->canChangeRole() ) {
+                $user->roles()->sync([$request->roles]);
+            }
         }
         $user->department()->sync([$department]);
 
diff --git a/app/Models/User.php b/app/Models/User.php
index 2350ecb1a..bdcf3dd13 100644
--- a/app/Models/User.php
+++ b/app/Models/User.php
@@ -98,6 +98,19 @@ public function tokens()
         return $this->hasMany(Token::class, 'user_id', 'id');
     }
 
+    public function canChangePasswordOn(User $user)
+    {
+        if($this->id === $user->id || ( $this->roles->first()->name == Role::OWNER_ROLE || $this->roles->first()->name == Role::ADMIN_ROLE)) {
+            return true;
+        }
+
+        return false;
+    }
+
+    public function canChangeRole()
+    {
+        return $this->roles->first()->name == Role::OWNER_ROLE || $this->roles->first()->name == Role::ADMIN_ROLE;
+    }
 
 
     public function isOnline()
diff --git a/resources/views/users/form.blade.php b/resources/views/users/form.blade.php
index c0477d22a..27d92a180 100644
--- a/resources/views/users/form.blade.php
+++ b/resources/views/users/form.blade.php
@@ -61,10 +61,11 @@
 


-
+@if(isset($user) && auth()->user()->canChangePasswordOn($user))
 
@lang('Security')

+
 

@lang('Password')
@@ -75,6 +76,7 @@
         


+@endif
 


@@ -82,6 +84,7 @@
     @lang('Access')


+@if(isset($user) && auth()->user()->canChangeRole())
     
@lang('Assign role')

@@ -90,6 +93,7 @@
         @endforeach
         

+@endif
     
@lang('Assign department')

