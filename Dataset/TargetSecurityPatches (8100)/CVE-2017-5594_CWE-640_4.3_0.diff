e0454f9c037c427a5ff76a57e78dbf8cc00c268b
pagekit@@pagekit
diff --git a/CHANGELOG.md b/CHANGELOG.md
index fe086b4e0..f3688e51c 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,5 +1,10 @@
 # Changelog
 
+## 1.0.11 (January 20, 2017)
+
+### Security
+- Fixed replay attack with password reset links when debug toolbar is enabled, discovered by SecureLayer7 
+
 ## 1.0.10 (December 22, 2016)
 
 ### Fixed
diff --git a/app/system/config.php b/app/system/config.php
index 5df7e791c..d1c00b09f 100644
--- a/app/system/config.php
+++ b/app/system/config.php
@@ -4,7 +4,7 @@
 
     'application' => [
 
-        'version' => '1.0.10'
+        'version' => '1.0.11'
 
     ],
 
diff --git a/app/system/modules/settings/app/components/system.vue b/app/system/modules/settings/app/components/system.vue
index c3d1b1017..67d4240e7 100644
--- a/app/system/modules/settings/app/components/system.vue
+++ b/app/system/modules/settings/app/components/system.vue
@@ -34,6 +34,7 @@
                  {{ 'Enable debug toolbar' | trans }}

{{ 'Please enable the SQLite database extension.' | trans }}
+            {{ 'Please note that enabling debug mode or toolbar has serious security implications.' | trans }}


 
diff --git a/app/system/modules/user/src/Controller/ResetPasswordController.php b/app/system/modules/user/src/Controller/ResetPasswordController.php
index 5874d7993..834e300c6 100644
--- a/app/system/modules/user/src/Controller/ResetPasswordController.php
+++ b/app/system/modules/user/src/Controller/ResetPasswordController.php
@@ -25,7 +25,7 @@ public function indexAction()
     }
 
     /**
-     * @Request({"email": "string"})
+     * @Request({"email"})
      */
     public function requestAction($email)
     {
@@ -51,9 +51,8 @@ public function requestAction($email)
                 throw new Exception(__('Your account has not been activated or is blocked.'));
             }
 
-            $user->activation = App::get('auth.random')->generateString(32);
-
-            $url = App::url('@user/resetpassword/confirm', ['user' => $user->username, 'key' => $user->activation], 0);
+            $key = App::get('auth.random')->generateString(32);
+            $url = App::url('@user/resetpassword/confirm', compact('key'), 0);
 
             try {
 
@@ -67,6 +66,7 @@ public function requestAction($email)
                 throw new Exception(__('Unable to send confirmation link.'));
             }
 
+            $user->activation = $key;
             $user->save();
 
             App::message()->success(__('Check your email for the confirmation link.'));
@@ -85,15 +85,26 @@ public function requestAction($email)
     }
 
     /**
-     * @Request({"user", "key"})
+     * @Request({"key", "password"})
      */
-    public function confirmAction($username = "", $activation = "")
+    public function confirmAction($activation = '', $password = '')
     {
-        if (empty($username) || empty($activation) || !$user = User::where(compact('username', 'activation'))->first()) {
+        if ($activation and $user = User::where(compact('activation'))->first()) {
+
+            App::session()->set('activation', [
+                'key' => $activation,
+                'user' => $user->id,
+            ]);
+
+            $user->activation = null;
+            $user->save();
+        }
+
+        if (!$data = App::session()->get('activation') or $data['key'] != $activation) {
             App::abort(400, __('Invalid key.'));
         }
 
-        if ($user->isBlocked()) {
+        if (!$user = User::find($data['user']) or $user->isBlocked()) {
             App::abort(400, __('Your account has not been activated or is blocked.'));
         }
 
@@ -105,8 +116,6 @@ public function confirmAction($username = "", $activation = "")
                     throw new Exception(__('Invalid token. Please try again.'));
                 }
 
-                $password = App::request()->request->get('password');
-
                 if (empty($password)) {
                     throw new Exception(__('Enter password.'));
                 }
@@ -115,10 +124,11 @@ public function confirmAction($username = "", $activation = "")
                     throw new Exception(__('Invalid password.'));
                 }
 
-                $user->password = App::get('auth.password')->hash($password);
                 $user->activation = null;
+                $user->password = App::get('auth.password')->hash($password);
                 $user->save();
 
+                App::session()->remove('activation');
                 App::message()->success(__('Your password has been reset.'));
 
                 return App::redirect('@user/login');
@@ -133,7 +143,6 @@ public function confirmAction($username = "", $activation = "")
                 'title' => __('Reset Confirm'),
                 'name' => 'system/user/reset-confirm.php'
             ],
-            'username' => $username,
             'activation' => $activation,
             'error' => isset($error) ? $error : ''
         ];
diff --git a/app/system/modules/user/views/reset-confirm.php b/app/system/modules/user/views/reset-confirm.php
index 59917f9d4..906888522 100644
--- a/app/system/modules/user/views/reset-confirm.php
+++ b/app/system/modules/user/views/reset-confirm.php
@@ -1,6 +1,6 @@
 script('uikit-form-password') ?>
 
-
+


