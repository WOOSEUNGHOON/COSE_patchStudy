299b5a3a66add4ac643e3ba78ada4d9637c8baff
bbalet@@jorani
diff --git a/application/config/routes.php b/application/config/routes.php
index d464ebc03..8a3ec44e9 100644
--- a/application/config/routes.php
+++ b/application/config/routes.php
@@ -58,10 +58,8 @@
 $route['users/reset/(:num)'] = 'users/reset/$1';
 $route['users/create'] = 'users/create';
 $route['users/edit/(:num)'] = 'users/edit/$1';
-$route['users/delete/(:num)'] = 'users/delete/$1';
 $route['users/check/login'] = 'users/checkLoginByAjax';
-$route['users/enable/(:num)'] = 'users/enable/$1';
-$route['users/disable/(:num)'] = 'users/disable/$1';
+$route['users/account']['POST'] = 'users/account';
 $route['users'] = 'users';
 
 //_______________________________________________
diff --git a/application/controllers/Users.php b/application/controllers/Users.php
index c59103fab..f35b3847d 100644
--- a/application/controllers/Users.php
+++ b/application/controllers/Users.php
@@ -46,34 +46,34 @@ public function index() {
     }
 
     /**
-     * Set a user as active (TRUE) or inactive (FALSE)
-     * @param int $id User identifier
-     * @param bool $active active (TRUE) or inactive (FALSE)
+     * Account management (activate/disable/delete) is done by a 
+     * POST request with a CSRF token for an improved security
      * @author Benjamin BALET 
      */
-    public function active($id, $active) {
+    public function account() {
         $this->auth->checkIfOperationIsAllowed('list_users');
-        $this->users_model->setActive($id, $active);
-        $this->session->set_flashdata('msg', lang('users_edit_flash_msg_success'));
-        redirect('users');
-    }
-
-    /**
-     * Enable a user
-     * @param int $id User identifier
-     * @author Benjamin BALET 
-     */
-    public function enable($id) {
-        $this->active($id, TRUE);
-    }
-
-    /**
-     * Disable a user
-     * @param int $id User identifier
-     * @author Benjamin BALET 
-     */
-    public function disable($id) {
-        $this->active($id, FALSE);
+        $id = $this->input->post('id');
+        $operation = $this->input->post('operation');
+        //Test if user exists
+        $data['users_item'] = $this->users_model->getUsers($id);
+        if (empty($data['users_item'])) {
+            redirect('notfound');
+        } else {
+            switch ($operation) {
+                case 'enable': 
+                    $this->users_model->setActive($id, TRUE);
+                    log_message('error', 'User #' . $id . ' has been enabled by user #' . $this->session->userdata('id'));
+                    break;
+                case 'disable':
+                    $this->users_model->setActive($id, FALSE);
+                    log_message('error', 'User #' . $id . ' has been disabled by user #' . $this->session->userdata('id'));
+                    break;
+                case 'delete':
+                    $this->auth->checkIfOperationIsAllowed('delete_user');
+                    $this->users_model->deleteUser($id);
+                    log_message('error', 'User #' . $id . ' has been deleted by user #' . $this->session->userdata('id'));
+            }
+        }
     }
 
     /**
@@ -194,25 +194,6 @@ public function edit($id) {
         }
     }
 
-    /**
-     * Delete a user. Log it as an error.
-     * @param int $id User identifier
-     * @author Benjamin BALET 
-     */
-    public function delete($id) {
-        $this->auth->checkIfOperationIsAllowed('delete_user');
-        //Test if user exists
-        $data['users_item'] = $this->users_model->getUsers($id);
-        if (empty($data['users_item'])) {
-            redirect('notfound');
-        } else {
-            $this->users_model->deleteUser($id);
-        }
-        log_message('error', 'User #' . $id . ' has been deleted by user #' . $this->session->userdata('id'));
-        $this->session->set_flashdata('msg', lang('users_delete_flash_msg_success'));
-        redirect('users');
-    }
-
     /**
      * Reset the password of a user
      * Can be accessed by the user itself or by admin
diff --git a/application/views/users/index.php b/application/views/users/index.php
index 47444fd9e..be4d846ba 100644
--- a/application/views/users/index.php
+++ b/application/views/users/index.php
@@ -28,20 +28,24 @@
     


-    
+    

 
             
+            session->userdata('id')) { ?>
                 
-                
+                

-                
+                

+            
                  
                 
                  
+                session->userdata('id')) { ?>
                 
                  
+                



@@ -79,7 +83,7 @@
         


-        
+        



@@ -119,11 +123,34 @@
 
 

+
