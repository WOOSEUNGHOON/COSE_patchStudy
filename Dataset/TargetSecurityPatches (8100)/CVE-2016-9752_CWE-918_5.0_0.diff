fbdd50a448ed87ba34ea8c56446b8f1873eadd6f
s9y@@Serendipity
diff --git a/docs/NEWS b/docs/NEWS
index 32a88ad79..390b28490 100644
--- a/docs/NEWS
+++ b/docs/NEWS
@@ -1,3 +1,12 @@
+Version 2.0.5 (November 28th, 2016)
+------------------------------------------------------------------------
+
+    * [Security] Improve preventing fetching local files, thanks to
+      Xu Yue.
+      
+    * [Security] Prevent XSS in adding category and directory names, 
+      thanks to Edric Teo @smarterbitbybit.
+
 Version 2.0.4 (September 26th, 2016)
 ------------------------------------------------------------------------
 
diff --git a/include/admin/images.inc.php b/include/admin/images.inc.php
index d02f71588..247f7093b 100644
--- a/include/admin/images.inc.php
+++ b/include/admin/images.inc.php
@@ -225,8 +225,11 @@
             } else {
                 // Fetch file
                 $fContent = $req->getResponseBody();
+                $fUrl = $req->getEffectiveUrl();
 
-                if ($serendipity['POST']['imageimporttype'] == 'hotlink') {
+                if (!serendipity_url_allowed($fUrl)) {
+                    $messages[] = sprintf(' ' . REMOTE_FILE_INVALID . "\n", $fUrl);
+                } elseif ($serendipity['POST']['imageimporttype'] == 'hotlink') {
                     $tempfile = $serendipity['serendipityPath'] . $serendipity['uploadPath'] . '/hotlink_' . time();
                     $fp = fopen($tempfile, 'w');
                     fwrite($fp, $fContent);
@@ -473,7 +476,7 @@
 
         /* TODO: check if directory already exist */
         if (is_dir($nd) || @mkdir($nd)) {
-            $data['print_DIRECTORY_CREATED'] = sprintf(DIRECTORY_CREATED, $serendipity['POST']['name']);
+            $data['print_DIRECTORY_CREATED'] = sprintf(DIRECTORY_CREATED, $new_dir);
             @umask(0000);
             @chmod($serendipity['serendipityPath'] . $serendipity['uploadPath'] . $new_dir, 0777);
 
diff --git a/serendipity_config.inc.php b/serendipity_config.inc.php
index 0626bb96c..0a1b04e41 100644
--- a/serendipity_config.inc.php
+++ b/serendipity_config.inc.php
@@ -47,7 +47,7 @@
 }
 
 // The version string
-$serendipity['version'] = '2.0.4';
+$serendipity['version'] = '2.0.5';
 
 
 // Setting this to 'false' will enable debugging output. All alpha/beta/cvs snapshot versions will emit debug information by default. To increase the debug level (to enable Smarty debugging), set this flag to 'debug'.
diff --git a/templates/2k11/admin/category.inc.tpl b/templates/2k11/admin/category.inc.tpl
index 596f15a72..04a1dd16e 100644
--- a/templates/2k11/admin/category.inc.tpl
+++ b/templates/2k11/admin/category.inc.tpl
@@ -54,7 +54,7 @@
             

{$CONST.NAME}
-                    
+                    


@@ -74,7 +74,7 @@
                         {$CONST.NO_CATEGORY}
                     {foreach $categories as $cat}
                         {if $cat.categoryid == $cid}{continue}{/if}
-                        {for $i=1 to $cat.depth} {/for} {$cat.category_name}
+                        {for $i=1 to $cat.depth} {/for} {$cat.category_name|escape}
                     {/foreach}
                     

