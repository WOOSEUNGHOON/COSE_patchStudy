31d348947419058c43b8dfcd062e2988abd5058e
ganglia@@ganglia-web
diff --git a/actions.php b/actions.php
index 461ae1a5..2a1a8fc4 100644
--- a/actions.php
+++ b/actions.php
@@ -14,13 +14,13 @@
   
-     Host regular expression
-     Metric regular expression
+     Host regular expression
+     Metric regular expression

-     Hostname
-     Metric/Report
+     Hostname
+     Metric/Report

@@ -35,17 +35,17 @@
 	foreach ( $_GET as $key => $value ) {
 	  if ( is_array($value) ) {
 	    foreach ( $value as $index => $value2 ) {
-	      print '';
+	      print '';
 	    }
 	  } else {
-	    print '';
+	    print '';
 	  }
 	}
     } else {
       // If hostname is not set we assume we are dealing with aggregate graphs
-      print "";
+      print "";
       $metric_name=$_GET['metric_name'];
-      print "";
+      print "";
       print "";
       if (isset($_GET['vl']) && ($_GET['vl'] !== ''))
 	  print "";
diff --git a/autorotation.php b/autorotation.php
index 267435ef..974af1ee 100644
--- a/autorotation.php
+++ b/autorotation.php
@@ -127,7 +127,7 @@
     


-    
+    

     Rotate graphs every 
 $arg ) {
-    $hreg .= "&hreg[]=" . $arg;
+    $hreg .= "&hreg[]=" . rawurlencode($arg);
   }
 }
 
 if ( isset($_GET['hreg']) ) {
-  $data->assign("hreg_arg", $_GET['hreg'][0]);
+  $data->assign("hreg_arg", htmlspecialchars($_GET['hreg'][0]) );
 } else {
   $data->assign("hreg_arg", "");
 }
diff --git a/decompose_graph.php b/decompose_graph.php
index 60b7e216..da16515e 100644
--- a/decompose_graph.php
+++ b/decompose_graph.php
@@ -23,10 +23,10 @@
 $graph_config = build_aggregate_graph_config ($graph_type, $line_width, $_GET['hreg'], $_GET['mreg']);
 
 foreach ( $_GET['hreg'] as $index => $arg ) {
-  print "";
+  print "";
 }
 foreach ( $_GET['mreg'] as $index => $arg ) {
-  print "";
+  print "";
 }
 
 $size = isset($clustergraphsize) ? $clustergraphsize : 'default';
diff --git a/graph_all_periods.php b/graph_all_periods.php
index 5622850f..bbbc84d6 100644
--- a/graph_all_periods.php
+++ b/graph_all_periods.php
@@ -53,12 +53,12 @@ function openDecompose($url) {
 
 foreach ($_GET as $key => $value) {
   if ( ! in_array($key, $ignore_keys_list) && ! is_array($value))
-    $query_string_array[] = "$key=" . urlencode($value);
+    $query_string_array[] = rawurlencode($key) . "=" . urlencode($value);
 
   // $_GET argument is an array. Rebuild it to pass it on
   if ( is_array($value) ) {
     foreach ( $value as $index => $value2 )
-      $query_string_array[] = $key . "[]=" . urlencode($value2);
+      $query_string_array[] = rawurlencode($key) . "[]=" . urlencode($value2);
 
   }
 }
@@ -77,20 +77,20 @@ function openDecompose($url) {
 
 // Descriptive host/aggregate graph
 if (isset($_GET['h']) && ($_GET['h'] != ''))
-  $description = $_GET['h'];
+  $description = htmlspecialchars($_GET['h']);
 else if (isset($_GET['c']) && ($_GET['c'] != ''))
-  $description = $_GET['c'];
+  $description = htmlspecialchars($_GET['c']);
 else if (is_array($_GET['hreg']))
-  $description = join(",", $_GET['hreg']);
+  $description = htmlspecialchars( join(",", $_GET['hreg']) );
 else
   $description = "Unknown";
 
 if (isset($_GET['g'])) 
-  $metric_description = $_GET['g'];
+  $metric_description = htmlspecialchars($_GET['g']);
 else if ( isset($_GET['m'] ))
-  $metric_description = $_GET['m'];
+  $metric_description = htmlspecialchars($_GET['m']);
 else if (is_array($_GET['mreg']) )
-  $metric_description = join(",", $_GET['mreg']);
+  $metric_description = htmlspecialchars( join(",", $_GET['mreg']) );
 else
   $metric_description = "Unknown";
 
@@ -152,7 +152,7 @@ function openDecompose($url) {
     

Back
-      
+      
Home


diff --git a/header.php b/header.php
index b3789e32..d0a30c29 100755
--- a/header.php
+++ b/header.php
@@ -529,7 +529,7 @@ function make_node_menu($self,
 if ( $conf['overlay_events'] == true )
   $data->assign('overlay_events', true);
 
-$data->assign('selected_tab', $user['selected_tab']);
+$data->assign('selected_tab', htmlspecialchars($user['selected_tab']) );
 $data->assign('view_name', $user['viewname']);
 
 $additional_buttons = "";
diff --git a/mobile_helper.php b/mobile_helper.php
index 1e8765d6..2a0e51de 100644
--- a/mobile_helper.php
+++ b/mobile_helper.php
@@ -14,7 +14,7 @@
   

Back
-      View 
+      View 
Home


@@ -39,7 +39,7 @@
       $checked = "class=\"ui-btn-active\"";
       $range_menu .= "$v";
     } else {
-      $range_menu .= "$v";
+      $range_menu .= "$v";
     }
 
   }
@@ -61,9 +61,9 @@
 
       $range_args = "";
       if ( isset($_GET['r']) && $_GET['r'] != "" ) 
-	    $range_args .= "&r=" . $_GET['r'];
+	    $range_args .= "&r=" . rawurlencode($_GET['r']);
       if ( isset($_GET['cs']) && isset($_GET['ce']) ) 
-	    $range_args .= "&cs=" . $_GET['cs'] . "&ce=" . $_GET['ce'];
+	    $range_args .= "&cs=" . rawurlencode($_GET['cs']) . "&ce=" . rawurlencode($_GET['ce']);
 
       if ( count($view_elements) != 0 ) {
 	foreach ( $view_elements as $id => $element ) {
@@ -93,7 +93,7 @@
   

Back
-      Cluster 
+      Cluster 
Home


@@ -114,7 +114,7 @@
 	     $checked = "class=\"ui-btn-active\"";
       	     $range_menu .= "$v";
 	  } else {
-      	     $range_menu .= "$v";
+      	     $range_menu .= "$v";
 	  }
 	}
 	  print $range_menu;
@@ -125,7 +125,7 @@
   
     
 array(), "excluded_reports" => array());
     if ( is_file($cluster_file) ) {
       $override_reports = array_merge($override_reports, json_decode(file_get_contents($cluster_file), TRUE));
@@ -154,8 +157,8 @@
     foreach ( $reports["included_reports"] as $index => $report_name ) {
       if ( ! in_array( $report_name, $reports["excluded_reports"] ) ) {
 	print "
-	
-	
+	
+	
 	";
       }
 
@@ -173,10 +176,10 @@
   $hostname = $_GET['h'];
   $clustername = $_GET['c'];
 ?>
-  
+  

Back
-      Host 
+      Host 
Home


@@ -197,7 +200,7 @@
 	     $checked = "class=\"ui-btn-active\"";
       	     $range_menu .= "$v";
 	  } else {
-      	     $range_menu .= "$v";
+      	     $range_menu .= "$v";
 	  }
 	}
 	  print $range_menu;
@@ -208,7 +211,7 @@
   
     
 array(), "excluded_reports" => array());
     if ( is_file($host_file) ) {
       $override_reports = array_merge($override_reports, json_decode(file_get_contents($host_file), TRUE));
@@ -239,7 +245,7 @@
       if ( ! in_array( $report_name, $reports["excluded_reports"] ) ) {
 	print "
 	
-	";
+	";
       }
     }
     ?>  
@@ -260,8 +266,8 @@
   } else if (isset($reports[$metric_name]) and $reports[$metric])
     continue;
   else {
-    $metric_graphargs = "c=$clustername&h=$hostname&v=$metric_attributes[VAL]"
-      ."&m=$metric_name&r=$range&z=$size&jr=$jobrange"
+    $metric_graphargs = "c=".rawurlencode($clustername)."&h=".rawurlencode($hostname)."&v=".rawurlencode($metric_attributes[VAL])
+      ."&m=$metric_name&r=".rawurlencode($range)."&z=$size&jr=$jobrange"
       ."&js=$jobstart&st=$cluster[LOCALTIME]";
     if ($cs)
        $metric_graphargs .= "&cs=" . rawurlencode($cs);
@@ -302,7 +308,7 @@
       foreach ( $metric_group_members as $index => $metric_name ) {
 	print "
 	
-	";
+	";
       }
 ?>
        
diff --git a/trend_navigation.php b/trend_navigation.php
index e71070bf..2d5f8a12 100644
--- a/trend_navigation.php
+++ b/trend_navigation.php
@@ -10,11 +10,11 @@
 
 foreach ( $_REQUEST as $key => $value ) {
   if ( ! in_array($key, $drop_args) )
-    $graph_args[] = $key . "=" . str_replace("_/graph_php?", "", $value);
+    $graph_args[] = rawurlencode($key) . "=" . rawurlencode( str_replace("_/graph_php?", "", $value) );
 }
 
 $query_string = preg_replace("/(&trendrange=)(\d+)/", "", $_SERVER['QUERY_STRING'] );
-$query_string = preg_replace("/(&trendhistory=)(\d+)/", "", $query_string);
+$query_string = preg_replace("/(&trendhistory=)(\d+)/", "", htmlspecialchars($query_string, ENT_QUOTES) );
 
 
 ?>
@@ -59,4 +59,4 @@
   $(function () {
     $("#trend_range_menu").buttonset();
   });
-
\ No newline at end of file
+
diff --git a/views.php b/views.php
index 76391dc7..baa422bb 100644
--- a/views.php
+++ b/views.php
@@ -10,7 +10,7 @@
 // Load the metric caching code we use if we need to display graphs
 retrieve_metrics_cache();
 
-$base = isset($_GET['base']) ? $_GET['base'] . "/" : "";
+$base = isset($_GET['base']) ? rawurlencode($_GET['base']) . "/" : "";
 ?>
 
 
@@ -33,14 +33,14 @@
       $view_elements = get_view_graph_elements($view);
       $range_args = "";
       if (isset($_GET['r']) && $_GET['r'] != "") 
-	$range_args .= "&r=" . $_GET['r'];
+	$range_args .= "&r=" . rawurlencode($_GET['r']);
       if (isset($_GET['cs']) && isset($_GET['ce'])) 
-	$range_args .= "&cs=" . $_GET['cs'] . "&ce=" . $_GET['ce'];
+	$range_args .= "&cs=" . rawurlencode($_GET['cs']) . "&ce=" . rawurlencode($_GET['ce']);
 
       if (count($view_elements) != 0) {
 	foreach ($view_elements as $id => $element) {
 	  $legend = isset($element['hostname']) ? $element['hostname'] : "Aggregate graph";
-          $base = isset($_GET['base']) ? $_GET['base'] : '.';
+          $base = isset($_GET['base']) ? rawurlencode($_GET['base']) : '.';
 	  print "";
 	}
       } else {
diff --git a/views_view.php b/views_view.php
index 53c61656..3ec6f5a2 100644
--- a/views_view.php
+++ b/views_view.php
@@ -32,12 +32,15 @@
       $empty_view = array ("view_name" => $_GET['view_name'],
                            "items" => array());
       $view_suffix = str_replace(" ", "_", $_GET['view_name']);
-      $view_filename = $conf['views_dir'] . "/view_" . $view_suffix . ".json";
+      $view_filename = $conf['views_dir'] . "/view_" . preg_replace('/[^a-zA-Z0-9_-]/', '', $view_suffix) . ".json";
+      if ( pathinfo( $view_filename, PATHINFO_DIRNAME ) != $conf['views_dir'] ) {
+        die('Invalid path detected');
+      }
       $json = json_encode($empty_view);
       if (file_put_contents($view_filename, 
                             json_prettyprint($json)) === FALSE) {
         $output = "Alert:" .
-                  " Can't write to file $view_filename." .
+                  " Can't write to file " . htmlspecialchars($view_filename) .
                   " Perhaps permissions are wrong.";
       } else {
         $output = "View has been created successfully.";
@@ -79,7 +82,10 @@
       " does not exist.";
     } else {
       $view_suffix = str_replace(" ", "_", $_GET['view_name']);
-      $view_filename = $conf['views_dir'] . "/view_" . $view_suffix . ".json";
+      $view_filename = $conf['views_dir'] . "/view_" . preg_replace('/[^a-zA-Z0-9_-]/', '', $view_suffix) . ".json";
+      if ( pathinfo( $view_filename, PATHINFO_DIRNAME ) != $conf['views_dir'] ) {
+        die('Invalid path detected');
+      }
       if (unlink($view_filename) === FALSE) {
         $output = "Alert:" .
                   " Can't remove file $view_filename." .
