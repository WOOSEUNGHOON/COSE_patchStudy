ef32e9c28b6ddc33cee8a25255bc8da54434af3e
nilsteampassnet@@TeamPass
diff --git a/changelog.md b/changelog.md
index 909d39985..5c451dd7f 100755
--- a/changelog.md
+++ b/changelog.md
@@ -11,6 +11,7 @@
  Fixed issue while restoring DB from administration page
  Improved / Fixed administration task for encrypting/decrypting files
  Improved security regarding item history display
+ Added filter in Roles
  #1947 Dependency & array update in install checks
  #1945 Cannot delete items
  #1944 File upload results in error
diff --git a/includes/css/passman.css b/includes/css/passman.css
index 2c74ffe82..9516ac5b9 100644
--- a/includes/css/passman.css
+++ b/includes/css/passman.css
@@ -165,7 +165,7 @@ float:left;
 
 .td_title{
 font-weight:bold;
-min-width: 150px;
+min-width: 120px;
 }
 
 ul{
@@ -181,6 +181,11 @@ list-style-type:none;
   padding: 10px;
 }
 
+.normal {
+  font: normal; "Lucida Grande";
+  color: #464646;
+}
+
 .readme{
   font-family: sans-serif;
   font-size: 9px;
@@ -392,4 +397,9 @@ div.dataTables_processing { z-index: 1; }
 
 .hidden {
   display: none;
+}
+
+.no-border {
+  border: none;
+  border-collapse: collapse;
 }
\ No newline at end of file
diff --git a/index.php b/index.php
index 46d0c9937..4c7d41f5f 100644
--- a/index.php
+++ b/index.php
@@ -117,6 +117,7 @@
 $session_hide_maintenance =     $superGlobal->get("hide_maintenance", "SESSION");
 $session_initial_url =          $superGlobal->get("initial_url", "SESSION");
 $server_request_uri =           $superGlobal->get("REQUEST_URI", "SERVER");
+$session_nb_users_online =        $superGlobal->get("nb_users_online", "SESSION");
 
 
 /* DEFINE WHAT LANGUAGE TO USE */
@@ -783,7 +784,7 @@ class="ui-state-error ui-corner-all">
             


-            ', ($session_user_id !== null && empty($session_user_id) === false) ? ' '.$_SESSION['nb_users_online'].' '.$LANG['users_online'].' |  '.$LANG['index_expiration_in'].' ' : '', '
+            ', ($session_user_id !== null && empty($session_user_id) === false) ? ' '.$session_nb_users_online.' '.$LANG['users_online'].' |  '.$LANG['index_expiration_in'].' ' : '', '
         

 '. $LANG['server_time']." : ".@date($SETTINGS['date_format'], (string) $_SERVER['REQUEST_TIME'])." - ".@date($SETTINGS['time_format'], (string) $_SERVER['REQUEST_TIME']).'
diff --git a/install/install.queries.php b/install/install.queries.php
index 24d0f2fc6..2c54f402f 100644
--- a/install/install.queries.php
+++ b/install/install.queries.php
@@ -364,7 +364,7 @@ function encryptFollowingDefuse($message, $ascii_key)
                         $mysqli_result = mysqli_query(
                             $dbTmp,
                             "CREATE TABLE IF NOT EXISTS `".$var['tbl_prefix']."misc` (
-                            `id` int(12) NOT null AUTO_INCREMENT,
+                            `increment_id` int(12) NOT null AUTO_INCREMENT,
                             `type` varchar(50) NOT NULL,
                             `intitule` varchar(100) NOT NULL,
                             `valeur` varchar(500) NOT NULL,
diff --git a/install/upgrade_run_2.1.27.php b/install/upgrade_run_2.1.27.php
index 4013937ce..ef4f8203d 100644
--- a/install/upgrade_run_2.1.27.php
+++ b/install/upgrade_run_2.1.27.php
@@ -188,11 +188,19 @@ function cleanFields($txt)
 // alter table Items
 mysqli_query($db_link, "ALTER TABLE `".$pre."items` MODIFY pw_len INT(5) NOT NULL DEFAULT '0'");
 
-// alter table misc to add an index
-mysqli_query(
-    $db_link,
-    "ALTER TABLE `".$pre."misc` ADD `id` INT(12) NOT NULL AUTO_INCREMENT FIRST, ADD PRIMARY KEY (`id`)"
-);
+// alter table MISC - rename ID is exists
+$result = mysqli_query("SHOW COLUMNS FROM `misc` LIKE 'id'");
+if (mysqli_num_rows($result) !== 0) {
+    // Change name of field
+    mysqli_query($db_link, "ALTER TABLE `".$pre."misc` CHANGE `id` `increment_id` INT(12) NOT NULL");
+} else {
+    // alter table misc to add an index
+    $res = addColumnIfNotExist(
+        $pre."misc",
+        "increment_id",
+        "INT(12) NOT NULL AUTO_INCREMENT FIRST, ADD PRIMARY KEY (`id`)"
+    );
+}
 
 // alter table misc to add an index
 mysqli_query(
@@ -703,7 +711,7 @@ function replace_a_line($data)
         utf8_encode(
             " ".addslashes($LANG['please_wait'])."..."; ?>").show();
+    $("#div_formulaire_edition_item_info")
+        .html(" ".addslashes($LANG['please_wait'])."..."; ?>")
+        .removeClass("hidden");
     $("#item_detail_zone_loader").addClass("hidden");
     var erreur = "";
     var  reg=new RegExp("[.|,|;|:|!|=|+|-|*|/|#|\"|'|&]");
@@ -965,7 +967,7 @@ function(data) {
                         LoadingPage();
                     } else {
                         //refresh item in list
-                        $("#fileclass"+data.id).text($('#edit_label').val());
+                        $("#fileclass"+data.id).html('' + $('#edit_label').val() + '');
 
                         //Refresh form
                         $("#id_label").text($('#edit_label').val());
@@ -1088,16 +1090,24 @@ function(data) {
             );*/
 
         } else {
-            $('#edit_show_error').html("").show();
+            $('#edit_show_error')
+                .html("")
+                .show();
             $("#div_formulaire_edition_item ~ .ui-dialog-buttonpane").find("button:contains('')").prop("disabled", false);
-            $("#div_formulaire_edition_item_info").addClass("hidden").html("");
+            $("#div_formulaire_edition_item_info")
+                .addClass("hidden")
+                .html("");
         }
     }
 
     if (erreur != "") {
         $('#edit_show_error').html(erreur).show();
-        $("#div_formulaire_edition_item_info").addClass("hidden").html("");
-        $("#div_formulaire_edition_item ~ .ui-dialog-buttonpane").find("button:contains('')").prop("disabled", false);
+        $("#div_formulaire_edition_item_info")
+            .addClass("hidden")
+            .html("");
+        $("#div_formulaire_edition_item ~ .ui-dialog-buttonpane")
+            .find("button:contains('')")
+            .prop("disabled", false);
     }
 }
 
@@ -3293,6 +3303,11 @@ function(data) {
                     function(data) {
                         if (data[0].error === "") {
                             $("#div_suggest_change_wait").html("").show(1).delay(1500).fadeOut(1000);
+
+                            // set indicator if item has change proposal
+                            $("#item_extra_info").prepend(' ');
+                            $(".tip").tooltipster({multiple: true});
+
                             setTimeout(
                                 function() {
                                     $("#div_suggest_change").dialog("close");
diff --git a/items.php b/items.php
index d1480e8a6..95af3c7e6 100644
--- a/items.php
+++ b/items.php
@@ -226,11 +226,11 @@
                          '.$LANG['pw_is_expired_-_update_it'].'


-                ';
+                ';
 // Line for LABEL
 echo '
                 
-                    
+                    



@@ -252,7 +252,11 @@
                                 


-                        
+                    
+                    
+                        
+                    
+                    


 
@@ -266,7 +270,7 @@
 echo '
                 
  '.$LANG['description'].' :
-                    
+                    


';
@@ -274,7 +278,7 @@
 echo '
                 
  '.$LANG['pw'].' :
-                    
+                    
                          
                         

@@ -285,7 +289,7 @@
 echo '
                 
  '.$LANG['index_login'].' :
-                    
+                    



@@ -294,7 +298,7 @@
 echo '
                 
  '.$LANG['email'].' :
-                    
+                    


';
@@ -302,7 +306,7 @@
 echo '
                 
  '.$LANG['url'].' :
-                    
+                    


';
@@ -310,7 +314,7 @@
 echo '
                 
  '.$LANG['files_&_images'].' :
-                    
+                    


 
@@ -321,7 +325,7 @@
 echo '
                 
  '.$LANG['restricted_to'].' :
-                    
+                    


';
@@ -329,34 +333,34 @@
 echo '
                 
  '.$LANG['tags'].' :
-                    
+                    


';
 // Line for KBs
 if (isset($SETTINGS['enable_kb']) && $SETTINGS['enable_kb'] == 1) {
     echo '
-                    
-                          '.$LANG['kbs'].' :
-                        
-                            
-                        
-                    ';
+                
+                      '.$LANG['kbs'].' :
+                    
+                        
+                    
+                ';
 }
 // lines for FIELDS
 if (isset($SETTINGS['item_extra_fields']) && $SETTINGS['item_extra_fields'] == 1) {
     foreach ($_SESSION['item_fields'] as $elem) {
         $itemCatName = $elem[0];
         echo '
-                    
-                          '.$elem[1].' :
-                        
-                    ';
+                
+                      '.$elem[1].' :
+                    
+                ';
         foreach ($elem[2] as $field) {
             echo '
                     
   '.$field[1].' :
-                        ';
+                        ';
             if ($field[3] === "masked") {
                 echo '
                             ';
@@ -778,7 +782,7 @@
     ';
 }
 echo '
-    
+    


';
diff --git a/roles.load.php b/roles.load.php
index a4cbada21..939e92388 100644
--- a/roles.load.php
+++ b/roles.load.php
@@ -205,8 +205,6 @@ function(data) {
         }
     });
 
-
-
     refresh_roles_matrix();
 });
 
@@ -280,7 +278,7 @@ function refresh_roles_matrix(order)
     $("#div_loading").show();
 
     //clean up
-    $("#roles_next, #roles_previous").hide();
+    $(".roles_next, .roles_previous").hide();
 
     //manage start query
     if (order == "next") {
@@ -299,26 +297,42 @@ function refresh_roles_matrix(order)
         "sources/roles.queries.php",
         {
             type    : "refresh_roles_matrix",
-            start    : start
+            start   : start,
+            filter  : $("#filter_roles").val()
         },
         function(data) {
             //decrypt data
             data = $.parseJSON(data);
             $("#matrice_droits").html("");
-            if (data.new_table != "") {
+            if (data.new_table !== "") {
                 $("#matrice_droits").html(data.new_table);
-                if (data.next < data.all) {
-                    $("#roles_next").show();
+                if (data.next < data.all && data.next >= 9) {
+                    $(".roles_next").show();
                 }
                 if (data.next >= 9 && data.previous >= 0) {
-                    $("#roles_previous").show();
+                    $(".roles_previous").show();
                 }
                 //manage next & previous arrows
                 $('#next_role').val(data.next);
                 $('#previous_role').val(data.previous);
+
+                $("#filter_roles").val("");
             } else {
                 $("#matrice_droits").html(data.error);
             }
+
+            // Prepare autocomplete for filterbox
+            //Prepare autocomplete for filter
+            $("#filter_roles")
+                .autocomplete({
+                    source: data.list_of_roles,
+                    focus: function() {
+                        // prevent value inserted on focus
+                        return false;
+                    }
+                }
+            );
+
             $("#div_loading").hide();
         }
    );
diff --git a/roles.php b/roles.php
index 16e0c91a9..44076b1ce 100644
--- a/roles.php
+++ b/roles.php
@@ -50,17 +50,30 @@
 
     '.$LANG['admin_functions'].'  
     
-        
+        

+     
+    

-        
+        
+    
+     
+    
+        
+    
+    
+        





-         
-        
+        
+            
+        
+        
+            
+        



diff --git a/sources/import.queries.php b/sources/import.queries.php
index 349d89b0f..e51cc4506 100644
--- a/sources/import.queries.php
+++ b/sources/import.queries.php
@@ -251,7 +251,7 @@ function sanitiseString($str, $crLFReplacement)
             // Show results to user.
             echo '[{"error":"no" , "output" : "'.$display.'"}]';
         }
-        
+
         //delete file
         unlink($file);
 
diff --git a/sources/roles.queries.php b/sources/roles.queries.php
index 193bf6bef..3f480068e 100644
--- a/sources/roles.queries.php
+++ b/sources/roles.queries.php
@@ -288,24 +288,33 @@
 
             // Prepare POST variables
             $post_start = filter_input(INPUT_POST, 'start', FILTER_SANITIZE_NUMBER_INT);
+            $post_filter = filter_input(INPUT_POST, 'filter', FILTER_SANITIZE_STRING);
 
             $tree = $tree->getDescendants();
             $texte = ''.$LANG['groups'].'';
             $gpes_ok = array();
             $gpes_nok = array();
-            $tab_fonctions = array();
+            $arrRolesTitle = array();
             $arrRoles = array();
             $display_nb = 8;
             $sql_limit = "";
             $next = 1;
             $previous = 1;
+            $where = "";
+
+            // Should we filter on role names
+            if (empty($post_filter) === false) {
+                $where = " WHERE title LIKE '".$post_filter."%'";
+            }
 
             //count nb of roles
             $arrUserRoles = array_filter($_SESSION['user_roles']);
-            if (count($arrUserRoles) == 0 || $_SESSION['is_admin'] == 1) {
-                $where = "";
-            } else {
-                $where = " WHERE id IN (".implode(',', $arrUserRoles).")";
+            if (count($arrUserRoles) >= 0 && $_SESSION['is_admin'] !== "1") {
+                if (empty($where) === false) {
+                    $where = " WHERE id IN (".implode(',', $arrUserRoles).")";
+                } else {
+                    $where .= " AND id IN (".implode(',', $arrUserRoles).")";
+                }
             }
             DB::query("SELECT * FROM ".prefix_table("roles_title").$where);
             $roles_count = DB::count();
@@ -318,7 +327,7 @@
                     $previous = $start - $display_nb;
                 }
                 $sql_limit = " LIMIT ".mysqli_real_escape_string($link, filter_var($start, FILTER_SANITIZE_NUMBER_INT)).", ".mysqli_real_escape_string($link, filter_var($display_nb, FILTER_SANITIZE_NUMBER_INT));
-                $next = $start + $display_nb;
+                $next = $start + $display_nb + 1;
             }
 
             // array of roles for actual user
@@ -348,6 +357,7 @@
                         '[ '.$SETTINGS_EXT['pwComplexity'][$record['complexity']][1].' ]';
 
                     array_push($arrRoles, $record['id']);
+                    array_push($arrRolesTitle, $record['title']);
                 }
             }
             $texte .= '';
@@ -419,7 +429,8 @@
                 "new_table" => $texte,
                 "all" => $roles_count,
                 "next" => $next,
-                "previous" => $previous
+                "previous" => $previous,
+                "list_of_roles" => $arrRolesTitle
             );
 
             $return_values = json_encode($return_values, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP);
