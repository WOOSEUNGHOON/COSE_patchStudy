33e2692a37b5b6340cf5bec1a84e541460983c03
chamilo@@chamilo-lms
diff --git a/main/inc/lib/TicketManager.php b/main/inc/lib/TicketManager.php
index dc5584e7a65..389e1ce6d6c 100644
--- a/main/inc/lib/TicketManager.php
+++ b/main/inc/lib/TicketManager.php
@@ -966,7 +966,7 @@ public static function getTicketsByCurrentUser(
 
             if ($isAdmin) {
                 $ticket = [
-                    $icon.' '.$row['subject'],
+                    $icon.' '.Security::remove_XSS($row['subject']),
                     $row['status_name'],
                     $row['start_date'],
                     $row['sys_lastedit_datetime'],
@@ -977,7 +977,7 @@ public static function getTicketsByCurrentUser(
                 ];
             } else {
                 $ticket = [
-                    $icon.' '.$row['subject'],
+                    $icon.' '.Security::remove_XSS($row['subject']),
                     $row['status_name'],
                     $row['start_date'],
                     $row['sys_lastedit_datetime'],
diff --git a/main/messages/new_message.php b/main/messages/new_message.php
index d5e7f6796ca..fb8c302b6d1 100755
--- a/main/messages/new_message.php
+++ b/main/messages/new_message.php
@@ -186,7 +186,7 @@ function manageForm($default, $select_from_user_list = null, $sent_to = '', $tpl
 
     if (isset($_GET['re_id'])) {
         $message_reply_info = MessageManager::get_message_by_id($_GET['re_id']);
-        $default['title'] = get_lang('MailSubjectReplyShort').' '.$message_reply_info['title'];
+        $default['title'] = get_lang('MailSubjectReplyShort').' '.Security::remove_XSS($message_reply_info['title']);
         $form->addHidden('re_id', (int) $_GET['re_id']);
         $form->addHidden('save_form', 'save_form');
 
@@ -207,14 +207,14 @@ function manageForm($default, $select_from_user_list = null, $sent_to = '', $tpl
             $fileListToString = !empty($attachments) ? implode('', $attachments) : '';
             $form->addLabel('', $fileListToString);
         }
-        $default['title'] = '['.get_lang('MailSubjectForwardShort').": ".$message_reply_info['title'].']';
+        $default['title'] = '['.get_lang('MailSubjectForwardShort').": ".Security::remove_XSS($message_reply_info['title']).']';
         $form->addHidden('forward_id', $forwardId);
         $form->addHidden('save_form', 'save_form');
         $receiverInfo = api_get_user_info($message_reply_info['user_receiver_id']);
 
         $forwardMessage = '---------- '.get_lang('ForwardedMessage').' ---------'.'';
         $forwardMessage .= get_lang('Date').': '.api_get_local_time($message_reply_info['send_date']).'';
-        $forwardMessage .= get_lang('Subject').': '.$message_reply_info['title'].'';
+        $forwardMessage .= get_lang('Subject').': '.Security::remove_XSS($message_reply_info['title']).'';
         $forwardMessage .= get_lang('To').': '.$receiverInfo['complete_name'].' - '.$receiverInfo['email'].' ';
         $default['content'] = ''.$forwardMessage.''.Security::filter_terms($message_reply_info['content']);
     }
diff --git a/main/social/personal_data.php b/main/social/personal_data.php
index 68e02cfcb09..5d80dc0849b 100755
--- a/main/social/personal_data.php
+++ b/main/social/personal_data.php
@@ -256,7 +256,7 @@
                         $personalDataContent .= ''.get_lang('NoData').'';
                     } else {
                         foreach ($subValue as $subSubValue) {
-                            $personalDataContent .= ''.$subSubValue.'';
+                            $personalDataContent .= ''.Security::remove_XSS($subSubValue).'';
                         }
                     }
                     $personalDataContent .= '';
@@ -268,7 +268,7 @@
                     $personalDataContent .= ''.get_lang('NoData').'';
                 } else {
                     foreach ($value as $subValue) {
-                        $personalDataContent .= ''.$subValue->variable.': '.$subValue->value.'';
+                        $personalDataContent .= ''.$subValue->variable.': '.Security::remove_XSS($subValue->value).'';
                     }
                 }
                 $personalDataContent .= '';
@@ -292,7 +292,7 @@
                                 );
                                 $personalDataContent .= ''.$documentLink.'';
                             } else {
-                                $personalDataContent .= ''.$subSubValue.'';
+                                $personalDataContent .= ''.Security::remove_XSS($subSubValue).'';
                             }
                         }
                     }
@@ -312,7 +312,7 @@
                     $personalDataContent .= ''.get_lang('NoData').'';
                 } else {
                     foreach ($value as $subValue) {
-                        $personalDataContent .= ''.$subValue.'';
+                        $personalDataContent .= ''.Security::remove_XSS($subValue).'';
                     }
                 }
                 $personalDataContent .= '';
@@ -350,7 +350,7 @@
             $personalDataContent .= ''.$key.': '.get_lang('ComplexDataNotShown').'';
         }*/
     } else {
-        $personalDataContent .= ''.$key.': '.$value.'';
+        $personalDataContent .= ''.$key.': '.Security::remove_XSS($value).'';
     }
 }
 $personalDataContent .= '';
diff --git a/main/ticket/ticket_details.php b/main/ticket/ticket_details.php
index 1172e5dadb5..815e7fed971 100644
--- a/main/ticket/ticket_details.php
+++ b/main/ticket/ticket_details.php
@@ -121,7 +121,12 @@ class: "controls"
 
 $ticket_id = (int) $_REQUEST['ticket_id'];
 $ticket = TicketManager::get_ticket_detail_by_id($ticket_id);
-if (!isset($ticket['ticket'])) {
+if (!isset($ticket['ticket']) ||
+    // make sure it's either a user assigned to this ticket, or the reporter, or and admin
+    !($ticket['ticket']['assigned_last_user'] == $user_id ||
+      $ticket['ticket']['sys_insert_user_id'] == $user_id ||
+      $isAdmin)
+    ) {
     api_not_allowed(true);
 }
 if (!isset($_REQUEST['ticket_id'])) {
@@ -347,11 +352,12 @@ class: "controls"
 }
 $senderData = get_lang('AddedBy').' '.$ticket['usuario']['complete_name_with_message_link'];
 
+
 echo '


'.$title.'
-          '.$ticket['ticket']['subject'].'
+          '.Security::remove_XSS($ticket['ticket']['subject']).'

             '.$senderData.' '.
             get_lang('Created').' '.
@@ -405,11 +411,12 @@ class: "controls"
             
';
 }
+
 echo '


'.get_lang('Description').': 
-        '.$ticket['ticket']['message'].'
+        '.Security::remove_XSS($ticket['ticket']['message']).'
         


