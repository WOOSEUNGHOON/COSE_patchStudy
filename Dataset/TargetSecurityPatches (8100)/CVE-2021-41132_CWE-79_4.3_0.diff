0168067accde5e635341b3c714b1d53ae92ba424
ome@@omero-web
diff --git a/CHANGELOG.md b/CHANGELOG.md
index f0c9a6d465..9a5b599e4c 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,4 +1,10 @@
 
+5.11.0 (October 2021)
+---------------------
+
+- Security vulnerability fixes for
+  [2021-SV3](https://www.openmicroscopy.org/security/advisories/2021-SV3)
+
 5.11.0.rc1 (September 2021)
 ---------------------------
 
diff --git a/omeroweb/webadmin/templates/webadmin/includes/drivespaceStats.js b/omeroweb/webadmin/templates/webadmin/includes/drivespaceStats.js
index 43f8dc0cdc..c6fa25357e 100644
--- a/omeroweb/webadmin/templates/webadmin/includes/drivespaceStats.js
+++ b/omeroweb/webadmin/templates/webadmin/includes/drivespaceStats.js
@@ -18,7 +18,7 @@
                 for(i=0; i' + rowData.label + '(id:'+ rowId +')');
+                    tableRows.push('' + rowData.label.escapeHTML() + '(id:'+ rowId +')');
                     tableRows.push('' + rowData.data.filesizeformat() + '');
                 }
                 
@@ -50,6 +50,7 @@
 
                     for(i=0; i MAX_SLICES) {
diff --git a/omeroweb/webclient/static/webclient/javascript/ome.chgrp.js b/omeroweb/webclient/static/webclient/javascript/ome.chgrp.js
index 90cbf22851..3c37bc02af 100644
--- a/omeroweb/webclient/static/webclient/javascript/ome.chgrp.js
+++ b/omeroweb/webclient/static/webclient/javascript/ome.chgrp.js
@@ -62,7 +62,7 @@ $(function() {
             data_owners = data.owners;  // save for later
             var ownernames = [];
             for (var o=0; o" +
+            var headerTxt = "Move data owned by " + ownernames.join(", ").escapeHTML() + "." +
                             "Please choose target group below:";
             $group_chooser.append(headerTxt);
 
@@ -72,7 +72,7 @@ $(function() {
                 var g = data.groups[i];
                 html += "";
                 html += "";
-                html += g.name + "";
+                html += g.name.escapeHTML() + "";
             }
             // If no target groups found...
             if (data.groups.length === 0) {
@@ -407,7 +407,7 @@ $(function() {
             if (count === 1) otype = otype.slice(0, -1);  // remove s
             var namesList = [], names;
             unlinked.forEach(function (u) {
-                namesList.push(u.name);
+                namesList.push(u.name.escapeHTML());
             });
             names = namesList.join(", ");
             names = " (" + names.slice(0, 40) + (names.length > 40 ? "..." : "") + ")";
diff --git a/omeroweb/webclient/static/webclient/javascript/ome.chown.js b/omeroweb/webclient/static/webclient/javascript/ome.chown.js
index 784f9e7414..0d12918a8c 100644
--- a/omeroweb/webclient/static/webclient/javascript/ome.chown.js
+++ b/omeroweb/webclient/static/webclient/javascript/ome.chown.js
@@ -37,7 +37,7 @@ $(function() {
     var templateText = `
         
         <% _.each(selobjs, function(obj, idx) { %>
-            
+            
         <% }) %>
 
         
@@ -50,7 +50,7 @@ $(function() {
             <% _.each(exps, function(exp, idx) { %>
                 
'/>
-                    <%= exp.FirstName%> <%= exp.LastName %> 
+                    <%- exp.FirstName%> <%- exp.LastName %>
                 

             <% }) %>
diff --git a/omeroweb/webclient/static/webclient/javascript/ome.right_panel_comments_pane.js b/omeroweb/webclient/static/webclient/javascript/ome.right_panel_comments_pane.js
index 910f4dbf81..ff1f72cf18 100644
--- a/omeroweb/webclient/static/webclient/javascript/ome.right_panel_comments_pane.js
+++ b/omeroweb/webclient/static/webclient/javascript/ome.right_panel_comments_pane.js
@@ -110,7 +110,6 @@ var CommentsPane = function CommentsPane($element, opts) {
                         ann.link.owner = experimenters[ann.link.owner.id];
                     }
                     ann.addedBy = [ann.link.owner.id];
-                    ann.textValue = _.escape(ann.textValue);
                     return ann;
                 });
 
diff --git a/omeroweb/webclient/static/webclient/javascript/ome.right_panel_customanns_pane.js b/omeroweb/webclient/static/webclient/javascript/ome.right_panel_customanns_pane.js
index 56f5bfb828..38bac83361 100644
--- a/omeroweb/webclient/static/webclient/javascript/ome.right_panel_customanns_pane.js
+++ b/omeroweb/webclient/static/webclient/javascript/ome.right_panel_customanns_pane.js
@@ -88,7 +88,7 @@ var CustomAnnsPane = function CustomAnnsPane($element, opts) {
                     var attrs = ['textValue', 'timeValue', 'termValue', 'longValue', 'doubleValue', 'boolValue'];
                     attrs.forEach(function(a){
                         if (ann[a] !== undefined){
-                            ann.value = _.escape(ann[a]);
+                            ann.value = ann[a];
                         }
                     });
                     if (objects.length > 1) {
diff --git a/omeroweb/webclient/static/webclient/javascript/ome.right_panel_fileanns_pane.js b/omeroweb/webclient/static/webclient/javascript/ome.right_panel_fileanns_pane.js
index 02a1ab52bd..a823b96297 100644
--- a/omeroweb/webclient/static/webclient/javascript/ome.right_panel_fileanns_pane.js
+++ b/omeroweb/webclient/static/webclient/javascript/ome.right_panel_fileanns_pane.js
@@ -164,7 +164,6 @@ var FileAnnsPane = function FileAnnsPane($element, opts) {
                     }
                     // AddedBy IDs for filtering
                     ann.addedBy = [ann.link.owner.id];
-                    ann.description = _.escape(ann.description);
                     ann.file.size = ann.file.size !== null ? ann.file.size.filesizeformat() : "";
                     return ann;
                 });
diff --git a/omeroweb/webclient/static/webclient/javascript/ome.right_panel_tags_pane.js b/omeroweb/webclient/static/webclient/javascript/ome.right_panel_tags_pane.js
index 631bf46afe..7aa858bc64 100644
--- a/omeroweb/webclient/static/webclient/javascript/ome.right_panel_tags_pane.js
+++ b/omeroweb/webclient/static/webclient/javascript/ome.right_panel_tags_pane.js
@@ -143,8 +143,8 @@ var TagPane = function TagPane($element, opts) {
                     }
                     // AddedBy IDs for filtering
                     tag.addedBy = [tag.link.owner.id];
-                    tag.textValue = _.escape(tag.textValue);
-                    tag.description = _.escape(tag.description);
+                    tag.textValue = tag.textValue;
+                    tag.description = tag.description;
                     tag.canRemove = tag.link.permissions.canDelete;
                     return tag;
                 });
@@ -158,7 +158,7 @@ var TagPane = function TagPane($element, opts) {
                         var tagId = tag.id,
                             linkOwner = tag.link.owner.id;
                         if (summary[tagId] === undefined) {
-                            summary[tagId] = {'textValue': tag.textValue,
+                            summary[tagId] = {'textValue': _.escape(tag.textValue),
                                               'id': tag.id,
                                               'canRemove': false,
                                               'canRemoveCount': 0,
diff --git a/omeroweb/webclient/static/webclient/javascript/ome.tagging_form.js b/omeroweb/webclient/static/webclient/javascript/ome.tagging_form.js
index b161ea0207..6d5b29a82a 100644
--- a/omeroweb/webclient/static/webclient/javascript/ome.tagging_form.js
+++ b/omeroweb/webclient/static/webclient/javascript/ome.tagging_form.js
@@ -98,8 +98,9 @@ var tagging_form = function(
         for (var id in all_tags) {
             var tag = all_tags[id];
             if (tag && !(id in child_tags)) {
-                html += create_tag_html(tag.t, tag.d, owners[tag.o], tag.i,
-                                        null, tag.s !== 0);
+                html += create_tag_html(
+                    tag.t, tag.d, tag.i, null, tag.s !== 0
+                );
                 tag.sort_key = tag.t.toLowerCase();
                 if (tag.s) {
                     for (var sid in tag.s) {
@@ -108,8 +109,8 @@ var tagging_form = function(
                             child.sort_key = (tag.t.toLowerCase() +
                                 child.t.toLowerCase());
                             html += create_tag_html(
-                                child.t, child.d, owners[child.o], child.i,
-                                tag.i);
+                                child.t, child.d, child.i, tag.i
+                            );
                         }
                     }
                 }
@@ -118,15 +119,7 @@ var tagging_form = function(
         div_all_tags.append(html);
         // TODO This tooltip application is used until the extra data has loaded
         // at which point the tooltips are updated and this handler is replaced?
-        $(".tag_selection div").on('click', tag_click).tooltip({
-            track: false,
-            show: false,
-            hide: false,
-            items: '[data-content]',
-            content: function() {
-                return $(this).data('content');
-            }
-        });
+        $(".tag_selection div").on('click', tag_click);
     };
 
     var update_selected_labels = function() {
@@ -145,7 +138,7 @@ var tagging_form = function(
         if (tagset) {
             $("#id_selected_tag_set").html(
                 "Add a new tag in " +
-                tagset.text() + " tag set and select it immediately:");
+                tagset.text().escapeHTML() + " tag set and select it immediately:");
         } else {
             $("#id_selected_tag_set").text(
                 "Add a new tag and select it immediately:");
@@ -169,6 +162,7 @@ var tagging_form = function(
             track: false,
             show: false,
             hide: false,
+            items: '[data-id]',  // Just needs an attribute that exists
             content: title
         });
     };
@@ -369,45 +363,35 @@ var tagging_form = function(
         }
     };
 
-    var encode_html = function(text) {
-        return $('').text(text).html();
-    };
-
     var create_tag_title = function(description, owner, tagset, link_owner) {
         var title = "";
         if (owner) {
-            title += "Owner: " + owner + "";
+            title += "Owner: " + owner.escapeHTML() + "";
         }
         if (link_owner) {
-            title += "Linked by: " + link_owner + "";
+            title += "Linked by: " + link_owner.escapeHTML() + "";
         }
         if (description) {
-            title += "Description: " + description + "";
+            title += "Description: " + description.escapeHTML() + "";
         }
         if (tagset) {
-            title += "Tag set: " + tagset + "";
+            title += "Tag set: " + tagset.escapeHTML() + "";
         }
         return title;
     };
 
-    var create_tag_html = function(text, description, owner, id, parent_id,
+    var create_tag_html = function(text, description, id, parent_id,
                                    is_tagset) {
         var cls = is_tagset ? "alltags-tagset" :
             (parent_id ? "alltags-childtag" : "alltags-tag");
         var html = "";
+        html += ">" + text.escapeHTML() + "";
         return html;
     };
 
@@ -633,7 +617,7 @@ var tagging_form = function(
             new_tag_counter -= 1;
             var tagset_id = (tagset ? parseInt(tagset.attr('data-id'), 10) :
                              false);
-            owners[me] = owners[me] || my_name;
+            owners[me] = owners[me] || _.unescape(my_name);
             all_tags[new_tag_counter] = {
                 i: new_tag_counter,
                 d: description,
@@ -644,16 +628,18 @@ var tagging_form = function(
                            '') + text.toLowerCase()
             };
             var div = $(create_tag_html(
-                text, description, my_name, new_tag_counter,
+                text, description, new_tag_counter,
                 tagset ? tagset.attr('data-id') : null));
+            var title = create_tag_title(
+                description, _.unescape(my_name),
+                tagset_id? all_tags[tagset_id].t : null
+            );
             div.addClass('ui-selected').on('click', tag_click).tooltip({
                 track: true,
                 show: false,
                 hide: false,
-                items: '[data-content]',
-                content: function() {
-                    return $(this).data('content');
-                }
+                items: '[data-id]',  // Just needs an attribute that exists
+                content: title
             });
             $("div.ui-selected", div_selected_tags).removeClass('ui-selected');
             div_selected_tags.append(div);
diff --git a/omeroweb/webclient/static/webclient/javascript/ome.thumbnail_figure.js b/omeroweb/webclient/static/webclient/javascript/ome.thumbnail_figure.js
index 0de438efc4..6d2b5d681a 100644
--- a/omeroweb/webclient/static/webclient/javascript/ome.thumbnail_figure.js
+++ b/omeroweb/webclient/static/webclient/javascript/ome.thumbnail_figure.js
@@ -201,7 +201,7 @@ $(document).ready(function() {
                         // start a new container...
                         topLevelTag = tagData.tags[0] || tagsText;      // Group under 1st tag (unless we have no tags)
 
-                        $tr = $('' + topLevelTag + '');
+                        $tr = $('' + topLevelTag.escapeHTML() + '');
                         $tr.appendTo($this);
                         $td = $('').appendTo($tr);
                     }
@@ -263,4 +263,4 @@ $(document).ready(function() {
         }
     });
 
-});
\ No newline at end of file
+});
diff --git a/omeroweb/webclient/templates/webclient/annotations/comments_underscore.html b/omeroweb/webclient/templates/webclient/annotations/comments_underscore.html
index 03103528a3..bdf030cef3 100644
--- a/omeroweb/webclient/templates/webclient/annotations/comments_underscore.html
+++ b/omeroweb/webclient/templates/webclient/annotations/comments_underscore.html
@@ -1,36 +1,36 @@
 <% _.each(anns, function(ann) { %>
-
+

-        
+        




-                <%= ann.owner.firstName %> <%= ann.owner.lastName %>
-             
+                <%- ann.owner.firstName %> <%- ann.owner.lastName %>
+            
             at
             <% print(OME.formatDate(ann.link.date)) %>
         
-    
+
         <% if (ann.permissions.canDelete) { %>
-            
         <% } %>
 
-        <%= ann.textValue %>
+        <%- ann.textValue %>

 
     <% if (ann.ns || ann.description) { %>
     
-        ID: <%= ann.id %>
-        <% if (ann.ns) { %>Namespace: <%= ann.ns %><% } %>
-        <% if (ann.description) { %>Description: <%= ann.description %><% } %>
+        ID: <%- ann.id %>
+        <% if (ann.ns) { %>Namespace: <%- ann.ns %><% } %>
+        <% if (ann.description) { %>Description: <%- ann.description %><% } %>
     
     <% } %>
 
diff --git a/omeroweb/webclient/templates/webclient/annotations/customanns_underscore.html b/omeroweb/webclient/templates/webclient/annotations/customanns_underscore.html
index eb8cdd8e0e..af30864909 100644
--- a/omeroweb/webclient/templates/webclient/annotations/customanns_underscore.html
+++ b/omeroweb/webclient/templates/webclient/annotations/customanns_underscore.html
@@ -1,31 +1,31 @@
 
 <% _.each(anns, function(ann) { %>
 
-
-    <%= ann.type %>
+
+    <%- ann.type %>


         <% if (ann.type === 'Xml') { %>
-            <% print((ann.value + "").slice(0, 20)) %>...
+            <% print(_.escape((ann.value + "").slice(0, 20))) %>...
Open in new window
-            <%= ann.value %>
+            <%- ann.value %>
         <% } else { %>
-            <%= ann.value %>
+            <%- ann.value %>
         <% } %>
         
-        
+
         
-            ID: <%= ann.id %>
-            <% if (ann.ns) { %>Namespace: <%= ann.ns %><% } %>
-            <% if (ann.description) { %>Description: <%= ann.description %><% } %>
-            Owner: <%= ann.owner.firstName %> <%= ann.owner.lastName %>
+            ID: <%- ann.id %>
+            <% if (ann.ns) { %>Namespace: <%- ann.ns %><% } %>
+            <% if (ann.description) { %>Description: <%- ann.description %><% } %>
+            Owner: <%- ann.owner.firstName %> <%- ann.owner.lastName %>
Date: <% print(OME.formatDate(ann.date)) %>
 
             <% if (ann.parent) { %>
             
-            Linked to: <%= ann.parent.class %> <%= ann.parent.id %>
+            Linked to: <%- ann.parent.class %> <%- ann.parent.id %>
             <% } %>
         


-<% }) %>
\ No newline at end of file
+<% }) %>
diff --git a/omeroweb/webclient/templates/webclient/annotations/fileanns_underscore.html b/omeroweb/webclient/templates/webclient/annotations/fileanns_underscore.html
index 55af29ff4f..79edbb1948 100644
--- a/omeroweb/webclient/templates/webclient/annotations/fileanns_underscore.html
+++ b/omeroweb/webclient/templates/webclient/annotations/fileanns_underscore.html
@@ -1,26 +1,26 @@
 
 <% _.each(anns, function(ann) { %>
 
+    id="file_ann-<%- ann.id %>"
+    data-added-by="<% print(_.escape(ann.addedBy.join(','))) %>">
 
     
-        <%= ann.file.name %>
+        <%- ann.file.name %>
         <% if (ann.file.size) { %>
-            (<%= ann.file.size %>)
+            (<%- ann.file.size %>)
         <% } %>
     


         <% if (ann.links) { %>
-            Can remove File from <%= ann.canRemoveCount %>
+            Can remove File from <%- ann.canRemoveCount %>
             object<% if(ann.canRemoveCount !== 1) {print('s')} %>:
             <% _.each(ann.links, function(link, idx) { %>
                 
                     <% if (idx < 20) { %>
-                        <%= link.parent.class %> <%= link.parent.id %>
+                        <%- link.parent.class %> <%- link.parent.id %>
                         <% print(_.escape(link.parent.name).slice(0, 28)) %>
                         <% if (link.owner.id !== userId){
                             print("(" + link.owner.firstName.slice(0, 1) + " " + _.escape(link.owner.lastName) + ")")
@@ -31,18 +31,18 @@
                 
             <% }) %>
         <% } else { %>
-            Annotation ID: <%= ann.id %>
-            Owner: <%= ann.owner.firstName %> <%= ann.owner.lastName %>
-            Linked by: <%= ann.link.owner.firstName %> <%= ann.link.owner.lastName %>
+            Annotation ID: <%- ann.id %>
+            Owner: <%- ann.owner.firstName %> <%- ann.owner.lastName %>
+            Linked by: <%- ann.link.owner.firstName %> <%- ann.link.owner.lastName %>
On: <% print(OME.formatDate(ann.link.date)) %> 
-            Description: <%= ann.description %>
+            Description: <%- ann.description %>
             <% if (ann.ns){ %>
-                Namespace: <%= ann.ns %>
+                Namespace: <%- ann.ns %>
             <% } %>
             <% if (ann.file.mimetype){ %>
-                Mimetype: <%= ann.file.mimetype %>
+                Mimetype: <%- ann.file.mimetype %>
             <% } %>
-            File ID: <%= ann.file.id %>
+            File ID: <%- ann.file.id %>
         <% } %>
     
 
@@ -50,19 +50,19 @@
         
         <% if ((ann.ns && ann.ns === 'openmicroscopy.org/omero/bulk_annotations') || ann.file.mimetype == 'OMERO.tables' ){ %>
              
+            href='<%= webindex %>omero_table/<%- ann.file.id %>/'> 
         <% } %>
         <% if (ann.link.permissions.canDelete) { %> 
-            –
+            –
         <% } %>
 
         <% if (ann.permissions.canDelete) { %> 
-             × 
+             × 
         <% } %>
 
     

 
-<% }) %>
\ No newline at end of file
+<% }) %>
diff --git a/omeroweb/webclient/templates/webclient/annotations/mapanns_underscore.html b/omeroweb/webclient/templates/webclient/annotations/mapanns_underscore.html
index 6e50702bb9..fc28427993 100644
--- a/omeroweb/webclient/templates/webclient/annotations/mapanns_underscore.html
+++ b/omeroweb/webclient/templates/webclient/annotations/mapanns_underscore.html
@@ -1,8 +1,8 @@
 <% _.each(anns, function(ann) { %>
 
 
-            data-annId="<%= ann.id %>"
-            data-added-by="<% print (ann.addedBy.join(',')) %>"
+            data-annId="<%- ann.id %>"
+            data-added-by="<% print(_.escape(ann.addedBy.join(','))) %>"
         <% } else { %>
             data-added-by="<%= WEBCLIENT.USER.id %>"
         <% } %>
@@ -11,56 +11,56 @@
             ">
     
       <% if (showNs && ann.ns) { %>
-      
+      

-              <%= ann.ns.slice(0, 50) %>
+              <%- ann.ns.slice(0, 50) %>
           

       <% } %>
       

             <% if (ann.id) { %>
-                Added by: <%= ann.owner.firstName %> <%= ann.owner.lastName %>
+                Added by: <%- ann.owner.firstName %> <%- ann.owner.lastName %>
                 <% if (showParent && ann.link.parent.name){ %>
                   
                   <% if (ann.parentNames) { %>
-                    <%= ann.parentNames.length %> Annotations linked to:
+                    <%- ann.parentNames.length %> Annotations linked to:
                   <% } else { %>
                     To:
                   <% } %>
-                  <%= ann.parentNames ? (ann.parentNames.length + " objects") : ann.link.parent.name %>
+                  <%- ann.parentNames ? (ann.parentNames.length + " objects") : ann.link.parent.name %>
                 <% } %>
 
                 
                     <% if (ann.parentNames) { %>
                       You are
                       <% print (ann.permissions.canEdit && clientMapAnn ? 'editing' : 'viewing') %>
-                      <%= ann.parentNames.length %> identical Key-Value annotations:
+                      <%- ann.parentNames.length %> identical Key-Value annotations:
                     <% } %>
                     <% if (!ann.parentNames && ann.link) { %>
                         
-                        <%= ann.link.parent.class.slice(0, ann.link.parent.class.length-1) %>
-                            ID: <%= ann.link.parent.id %>
+                        <%- ann.link.parent.class.slice(0, ann.link.parent.class.length-1) %>
+                            ID: <%- ann.link.parent.id %>
                     <% } %>
                     Annotation ID<% if (ann.parentNames) { %>s<% } %>: <%= ann.id %>
                     <% if (ann.parentNames) { %>
                         Linked to:
                         <% _.each(ann.parentNames, function(pName) { %>
-                              <%= pName %>
+                              <%- pName %>
                         <% }) %>
                     <% } %>
                     <% if (ann.owner) { %>
-                        Owner: <%= ann.owner.firstName %> <%= ann.owner.lastName %>
+                        Owner: <%- ann.owner.firstName %> <%- ann.owner.lastName %>
                     <% } %>
                     <% if (ann.link) { %>
-                        Linked by: <%= ann.link.owner.firstName %> <%= ann.link.owner.lastName %>
+                        Linked by: <%- ann.link.owner.firstName %> <%- ann.link.owner.lastName %>
                         <% if (ann.link.date) { %>
                             On: <% print(OME.formatDate(ann.link.date)) %>
                         <% } %>
                     <% } %>
                 
             <% } else if (objCount && objCount > 1) { %>
-                Add annotations to <%= objCount %> objects
+                Add annotations to <%- objCount %> objects
                 
                     Identical Key-Value annotations will be added to each selected object.
                 
@@ -80,8 +80,8 @@
     <% if (ann.id) { %>
       <% _.each(ann.values, function(row) { %>
         
-            <% print(_.escape(row['0'])) %>
-            <% print(_.escape(row['1'])) %>
+            <%- row['0'] %>
+            <%- row['1'] %>

       <% }) %>
     <% } else { %>
diff --git a/omeroweb/webclient/templates/webclient/annotations/metadata_general.html b/omeroweb/webclient/templates/webclient/annotations/metadata_general.html
index e8e8084431..0ebb08f663 100644
--- a/omeroweb/webclient/templates/webclient/annotations/metadata_general.html
+++ b/omeroweb/webclient/templates/webclient/annotations/metadata_general.html
@@ -359,10 +359,10 @@
                         var bulkAnnTooltip = "" +
                             "Data from tables file:" +
                             "File ID: " + data.id + "" +
-                            "Owner: " + data.owner + " " +
+                            "Owner: " + data.owner.escapeHTML() + " " +
                             "Annotation ID: " + data.annId + "" +
                             "Linked to: " + data.parentType + " " + data.parentId + "" +
-                            "Linked by: " + data.addedBy + " " +
+                            "Linked by: " + data.addedBy.escapeHTML() + " " +
                             "On: " + OME.formatDate(data.addedOn) + "";
                         $("#bulk-annotations").append(bulkAnnTooltip);
                         $("#bulk-annotations").parent().tooltip({
diff --git a/omeroweb/webclient/templates/webclient/annotations/tags_underscore.html b/omeroweb/webclient/templates/webclient/annotations/tags_underscore.html
index 6f078c095d..3ff977abd1 100644
--- a/omeroweb/webclient/templates/webclient/annotations/tags_underscore.html
+++ b/omeroweb/webclient/templates/webclient/annotations/tags_underscore.html
@@ -1,17 +1,17 @@
 
 <% _.each(tags, function(tag) { %>
 
-	
+    data-tag-id="<%- tag.id %>"
+    data-added-by="<% print(_.escape(tag.addedBy.join(','))) %>">
+
     
-        
-            <%= tag.textValue %>
+        
+            <%- tag.textValue %>
         
 
         <% if (tag.canRemove) { %>
-        
+        
                 -
         
         <% } %>
@@ -19,13 +19,13 @@
         

         <% if (tag.links) { %>
-            Can remove Tag from <%= tag.canRemoveCount %> object<% if(tag.canRemoveCount !== 1) {print('s')} %>:
+            Can remove Tag from <%- tag.canRemoveCount %> object<% if(tag.canRemoveCount !== 1) {print('s')} %>:
             <% _.each(tag.links, function(link, idx) { %>
                 
                     <% if (idx < 20) { %>
-                        <%= link.parent.class %> <%= link.parent.id %>
-                        <% print(_.escape(link.parent.name).slice(0, 28)) %>
-                        <% if (link.owner.id !== userId){
+                        <%- link.parent.class %> <%- link.parent.id %>
+                        <%- link.parent.name.slice(0, 28) %>
+                        <% if (link.owner.id !== userId) {
                             print("(" + link.owner.firstName.slice(0, 1) + " " + _.escape(link.owner.lastName) + ")")
                         } %>
                     <% } else if (idx === 20) { %>
@@ -34,15 +34,15 @@
                 
             <% }) %>
         <% } else { %>
-            ID: <%= tag.id %>
-            Owner: <%= tag.owner.firstName %> <%= tag.owner.lastName %>
-            Linked by: <%= tag.link.owner.firstName %> <%= tag.link.owner.lastName %>
+            ID: <%- tag.id %>
+            Owner: <%- tag.owner.firstName %> <%- tag.owner.lastName %>
+            Linked by: <%- tag.link.owner.firstName %> <%- tag.link.owner.lastName %>
On: <% print(OME.formatDate(tag.link.date)) %>
-            Description: <%= tag.description %>
+            Description: <%- tag.description %>
         <% } %>
         

-    
+
 
 
-<% }) %>
\ No newline at end of file
+<% }) %>
diff --git a/omeroweb/webclient/templates/webclient/data/icon_thumbnails_underscore.html b/omeroweb/webclient/templates/webclient/data/icon_thumbnails_underscore.html
index 18df09a3aa..524aa0ad29 100644
--- a/omeroweb/webclient/templates/webclient/data/icon_thumbnails_underscore.html
+++ b/omeroweb/webclient/templates/webclient/data/icon_thumbnails_underscore.html
@@ -14,30 +14,30 @@
     <% _.each(images, function(img) { %>
          data-share="<%= img.shareId %>" <% }%>
+            <% if(img.shareId) { %> data-share="<%- img.shareId %>" <% }%>
             data-owned="">
 
             

-                
+                





-                 <%= img.name %>
-                 <%= img.name %> 
+                 <%- img.name %>
+                 <%- img.name %> 

-            <%= img.date %>
-            <%= img.data.obj.sizeX %>
-            <%= img.data.obj.sizeY %>
-            <%= img.data.obj.sizeZ %>
+            <%- img.date %>
+            <%- img.data.obj.sizeX %>
+            <%- img.data.obj.sizeY %>
+            <%- img.data.obj.sizeZ %>

     <% }) %>
 
@@ -62,4 +62,4 @@
 
 
 
-<% } %>
\ No newline at end of file
+<% } %>
diff --git a/omeroweb/webclient/templates/webclient/data/includes/center_plugin.thumbs.js.html b/omeroweb/webclient/templates/webclient/data/includes/center_plugin.thumbs.js.html
index be739c2983..4a6cdd209e 100644
--- a/omeroweb/webclient/templates/webclient/data/includes/center_plugin.thumbs.js.html
+++ b/omeroweb/webclient/templates/webclient/data/includes/center_plugin.thumbs.js.html
@@ -642,7 +642,7 @@
             var html = tagList.map(function(t){
                 // don't show tags we're filtering by
                 if (filter_tag_ids.indexOf(t.id) > -1) return "";
-                return "" + t.text + "";
+                return "" + t.text.escapeHTML() + "";
             }).join("");
             html = "Choose Tag" + html;
             $("#filter_by_tag").html(html);
@@ -663,7 +663,7 @@
             });
             // show tags
             var html = filter_tag_ids.map(function(tagId){
-                var tagText = usedTags[tagId].textValue;
+                var tagText = usedTags[tagId].textValue.escapeHTML();
                 return "" + tagText + "-";
             }).join("");
             $("#currentFilterTags").html(html);
diff --git a/omeroweb/webclient/templates/webclient/data/plate.html b/omeroweb/webclient/templates/webclient/data/plate.html
index c86fb5ae18..b56234ab48 100644
--- a/omeroweb/webclient/templates/webclient/data/plate.html
+++ b/omeroweb/webclient/templates/webclient/data/plate.html
@@ -267,7 +267,7 @@
                             if (selectImageIds && selectImageIds.indexOf(w.id) > -1) {
                                 cls = 'class="ui-selected"';
                             }
-                            html += '';
+                            html += '';
                             html += '';
                             html += '';
                             html += '';
diff --git a/omeroweb/webclient/templates/webclient/scripts/upload_script.html b/omeroweb/webclient/templates/webclient/scripts/upload_script.html
index 3095045e75..eb36183a47 100644
--- a/omeroweb/webclient/templates/webclient/scripts/upload_script.html
+++ b/omeroweb/webclient/templates/webclient/scripts/upload_script.html
@@ -123,7 +123,7 @@
                 }
                 $('#targetInfo').show();
                 if (!chosen_file.endsWith(".py")) {
-                    $("#targetMessage").html("File: " + chosen_file + " not valid.File must be Python script (.py)");
+                    $("#targetMessage").html("File: " + chosen_file.escapeHTML() + " not valid.File must be Python script (.py)");
                     return;
                 }
 
diff --git a/omeroweb/webclient/views.py b/omeroweb/webclient/views.py
index 49df928c0d..0b4bf835c8 100755
--- a/omeroweb/webclient/views.py
+++ b/omeroweb/webclient/views.py
@@ -35,6 +35,7 @@
 import warnings
 from past.builtins import unicode
 from future.utils import bytes_to_native_str
+from django.utils.html import escape
 from django.utils.http import is_safe_url
 
 from time import time
@@ -1793,7 +1794,7 @@ def load_metadata_preview(request, c_type, c_id, conn=None, share_id=None, **kwa
         rdefQueries.append(
             {
                 "id": r["id"],
-                "owner": r["owner"],
+                "owner": escape(r["owner"]),  # May be used unsafe later
                 "c": ",".join(chs),
                 "m": r["model"] == "greyscale" and "g" or "c",
             }
diff --git a/omeroweb/webgateway/static/webgateway/js/ome.popup.js b/omeroweb/webgateway/static/webgateway/js/ome.popup.js
index acf3dd9b3a..f53afd7a7f 100644
--- a/omeroweb/webgateway/static/webgateway/js/ome.popup.js
+++ b/omeroweb/webgateway/static/webgateway/js/ome.popup.js
@@ -169,7 +169,9 @@ String.prototype.escapeHTML = function(){
         switch(s) {
             case "&": return "&";
             case "\\": return "\";
-            case '"': return '\"';
+            case "`": return '`';
+            case "'": return ''';
+            case '"': return '"';
             case "<": return "<";
             case ">": return ">";
             default: return s;
diff --git a/omeroweb/webgateway/static/webgateway/js/ome.roidisplay.js b/omeroweb/webgateway/static/webgateway/js/ome.roidisplay.js
index 1a02a52d41..73d6c9b3d6 100644
--- a/omeroweb/webgateway/static/webgateway/js/ome.roidisplay.js
+++ b/omeroweb/webgateway/static/webgateway/js/ome.roidisplay.js
@@ -796,12 +796,12 @@ $.fn.roi_display = function(options) {
                                     var bb = newShape.getBBox();
                                     var textx = bb.x + (bb.width/2);
                                     var texty = bb.y + (bb.height/2);
-                                    var text_string = formatShapeText(shape['textValue'].escapeHTML())
+                                    var text_string = formatShapeText(shape['textValue'])
                                     var txt = paper.text(textx, texty, text_string);    // draw a 'dummy' paragraph to work out it's dimensions
                                     var newY = (texty-txt.getBBox().height/2)+9;
                                     // moving the existing text to newY doesn't seem to work - instead, remove and draw a new one
                                     txt.remove();
-                                    txt = paper.text(textx, newY, formatShapeText(shape['textValue'].escapeHTML()))
+                                    txt = paper.text(textx, newY, formatShapeText(shape['textValue']))
                                                .attr({'cursor':'default', 'fill': shape['strokeColor']}); // this is Insight's behavior
                                     txt_box = txt.getBBox();
                                     var txt_w = txt_box.width*1.3;
diff --git a/omeroweb/webgateway/static/webgateway/js/ome.spwgridview.js b/omeroweb/webgateway/static/webgateway/js/ome.spwgridview.js
index 4a5ad2b51b..a0c16c1b39 100644
--- a/omeroweb/webgateway/static/webgateway/js/ome.spwgridview.js
+++ b/omeroweb/webgateway/static/webgateway/js/ome.spwgridview.js
@@ -127,7 +127,7 @@ $(function(){
                     // check if min===max to avoid zero-division error
                     var x = (maxX === minX) ? 0.5 : (ws.position.x.value - minX)/(maxX - minX);
                     var y = (maxY === minY) ? 0.5 : (ws.position.y.value - minY)/(maxY - minY);
-                    return '';
+                    return '';
                 }, "");
                 $well_birds_eye.append(html.join(""));
             }
diff --git a/omeroweb/webgateway/static/webgateway/js/omero_image.js b/omeroweb/webgateway/static/webgateway/js/omero_image.js
index 2772030203..d5adaed0a9 100644
--- a/omeroweb/webgateway/static/webgateway/js/omero_image.js
+++ b/omeroweb/webgateway/static/webgateway/js/omero_image.js
@@ -314,10 +314,10 @@
 
         /* Image details */
         var tmp = viewport.getMetadata();
-        $('#wblitz-image-name').html(tmp.imageName);
-        $('#wblitz-image-description-content').html(tmp.imageDescription.replace(/\n/g, ''));
-        $('#wblitz-image-author').html(tmp.imageAuthor);
-        $('#wblitz-image-pub').html(tmp.projectName);
+        $('#wblitz-image-name').html(tmp.imageName.escapeHTML());
+        $('#wblitz-image-description-content').html(tmp.imageDescription.escapeHTML().replace(/\n/g, ''));
+        $('#wblitz-image-author').html(tmp.imageAuthor.escapeHTML());
+        $('#wblitz-image-pub').html(tmp.projectName.escapeHTML());
         $('#wblitz-image-pubid').html(tmp.projectId);
         $('#wblitz-image-timestamp').html(tmp.imageTimestamp);
 
@@ -392,8 +392,8 @@
             $(''+channels[i].label+'')
+                '" title="' + channels[i].label.escapeHTML() +
+                '">'+channels[i].label.escapeHTML()+'')
             .appendTo(box)
             .on('click', doToggle(i));
         }
@@ -542,11 +542,11 @@
             tmp.after(template
                 .replace(/\$class/g, btnClass)
                 .replace(/\$col/g, '#' + channels[i].color)
-                .replace(/\$label/g, channels[i].label)
-                .replace(/\$l/g, lbl)
+                .replace(/\$label/g, channels[i].label.escapeHTML())
+                .replace(/\$l/g, lbl.escapeHTML())
                 .replace(/\$idx0/g, i) // Channel Index, 0 based
                 .replace(/\$idx1/g, i+1) // Channel Index, 1 based
-                .replace(/\$cwl/g, channels[i].label) // Wavelength
+                .replace(/\$cwl/g, channels[i].label.escapeHTML()) // Wavelength
                 .replace(/\$cls/g, i/2!=parseInt(i/2, 10)?'even':'odd') // class
             );
 
diff --git a/omeroweb/webgateway/templates/webgateway/viewport/omero_image.html b/omeroweb/webgateway/templates/webgateway/viewport/omero_image.html
index 11704dbbfc..7036a5ea23 100644
--- a/omeroweb/webgateway/templates/webgateway/viewport/omero_image.html
+++ b/omeroweb/webgateway/templates/webgateway/viewport/omero_image.html
@@ -544,7 +544,7 @@
               var theT =
                   typeof shape.theT === "undefined"? NOZT : shape.theT + 1;
               shapesHtml += "" + theT + "";
-              shapesHtml += ""+ truncate_text(text.escapeHTML()) + "";
+              shapesHtml += ""+ truncate_text(text.escapeHTML()) + "";
               shapesHtml += "" + shapeThumbHtml + "";
               shapesHtml += "" + shapeVisibilityHtml + "";
               shapesHtml += "";
@@ -563,7 +563,7 @@
           roi_html += "" + roi['id'] + "";
           roi_html += " "+ tRange +" "; // no Z for ROI
           roi_html += " "+ zRange +" "; // no T for ROI
-          roi_html += ""+ truncate_text(roiText) +"";
+          roi_html += ""+ truncate_text(roiText).escapeHTML() +"";
           roi_html += ""+ roiThumbHtml +"";
           roi_html += "" + roiVisibilityHtml + "";
           roi_html += "";
