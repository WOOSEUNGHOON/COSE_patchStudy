ecbe822b48ef4ff61c2c6357c0c94199a81946f4
revive-adserver@@revive-adserver
diff --git a/lib/max/other/html.php b/lib/max/other/html.php
index 0e6bc05df3..fcdab591a7 100644
--- a/lib/max/other/html.php
+++ b/lib/max/other/html.php
@@ -192,7 +192,8 @@ function MAX_displayNoStatsMessage()
 function _getHtmlHeaderColumn($title, $name, $pageName, $entityIds, $listorder, $orderdirection, $showColumn = true)
 {
     $str = '';
-    $entity = _getEntityString($entityIds);
+    $entity = htmlspecialchars(_getEntityString($entityIds), ENT_QUOTES);
+    $pageName = htmlspecialchars($pageName, ENT_QUOTES);
     if ($listorder == $name) {
         if (($orderdirection == '') || ($orderdirection == 'down')) {
             $str = "";
@@ -200,7 +201,7 @@ function _getHtmlHeaderColumn($title, $name, $pageName, $entityIds, $listorder,
             $str = "";
         }
     }
-    return $showColumn ? "$title$str" : '';
+    return $showColumn ? "$title$str" : '';
 }
 
 function _getEntityString($entityIds)
@@ -209,9 +210,9 @@ function _getEntityString($entityIds)
     if (!empty($entityIds)) {
         $entityArr = array();
         foreach ($entityIds as $entityId => $entityValue) {
-            $entityArr[] = "$entityId=$entityValue";
+            $entityArr[] = "$entityId=".urlencode($entityValue);
         }
-        $entity = implode('&',$entityArr) . '&';
+        $entity = implode('&', $entityArr) . '&';
     }
 
     return $entity;
diff --git a/lib/templates/admin/layout/links-container.html b/lib/templates/admin/layout/links-container.html
index f9379eb598..6133996473 100644
--- a/lib/templates/admin/layout/links-container.html
+++ b/lib/templates/admin/layout/links-container.html
@@ -20,7 +20,7 @@
         		
         			{if $aLinks[linkLoop].type == 'link'}
             			{if $aLinks[linkLoop].icon}{/if}
-            			{$aLinks[linkLoop].title}
+                        {$aLinks[linkLoop].title}
         			{elseif $aLinks[linkLoop].type == 'form'}
             			{if $aLinks[linkLoop].icon}{/if}
             			{$aLinks[linkLoop].title}
diff --git a/www/admin/stats-conversions.php b/www/admin/stats-conversions.php
index f000e55613..36670720e2 100644
--- a/www/admin/stats-conversions.php
+++ b/www/admin/stats-conversions.php
@@ -58,31 +58,34 @@
 $expand         = MAX_getValue('expand', '');
 $collapse       = MAX_getValue('collapse');
 
-$clientId       = MAX_getValue('clientid');
-$campaignId     = MAX_getValue('campaignid');
-$bannerId       = MAX_getValue('bannerid');
-
-$affiliateId    = MAX_getValue('affiliateid');
-$zoneId         = MAX_getValue('zoneid');
-
-if (OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {
-    $clientId = $clientid = OA_Permission::getEntityId();
-} elseif (OA_Permission::isAccount(OA_ACCOUNT_TRAFFICKER)) {
-    $affiliateId = $affiliateid = OA_Permission::getEntityId();
+if ($clientid) {
+    OA_Permission::enforceAccessToObject('clients', $clientid);
+}
+if ($campaignid) {
+    OA_Permission::enforceAccessToObject('campaigns', $campaignid);
+}
+if ($bannerid) {
+    OA_Permission::enforceAccessToObject('banners', $bannerid);
+}
+if ($affiliateid) {
+    OA_Permission::enforceAccessToObject('affiliates', $clientid);
+}
+if ($zoneid) {
+    OA_Permission::enforceAccessToObject('zones', $zoneid);
 }
 
 // Build $addUrl variable which will be added to any required link on this page, eg: expand, collapse, editStatuses
 $entityIds = array(
     'entity'      => 'conversions',
     'clientid'    => $clientid,
-    'campaignid'  => $campaignId,
-    'bannerid'    => $bannerId,
-    'affiliateid' => $affiliateId,
-    'zoneid'      => $zoneId,
+    'campaignid'  => $campaignid,
+    'bannerid'    => $bannerid,
+    'affiliateid' => $affiliateid,
+    'zoneid'      => $zoneid,
     'setPerPage'  => $setPerPage,
     'pageID'      => $pageID
 );
-$addUrl = "entity=conversions&clientid=$clientId&campaignid=$campaignId&bannerid=$bannerId&affiliateid=$affiliateId&zoneid=$zoneId&setPerPage=$setPerPage&pageID=$pageID";
+$addUrl = "entity=conversions&clientid=$clientid&campaignid=$campaignid&bannerid=$bannerid&affiliateid=$affiliateid&zoneid=$zoneid&setPerPage=$setPerPage&pageID=$pageID";
 
 if (!empty($day)) {
     $entityIds += array(
@@ -90,14 +93,14 @@
         'hour' => $hour,
         'howLong' => $howLong
     );
-    $addUrl .= "&day={$day}&hour={$hour}&howLong={$howLong}";
+    $addUrl .= "&day=".urlencode($day)."&hour=".urlencode($hour)."&howLong=".urlencode($howLong);
 } else {
     $entityIds += array(
         'period_preset' => $period_preset,
         'period_start' => $period_start,
         'period_end' => $period_end,
     );
-    $addUrl .= "._preset={$period_preset}._start={$period_start}._end={$period_end}";
+    $addUrl .= "._preset=".urlencode($period_preset)."._start=".urlencode($period_start)."._end=".urlencode($period_end);
 }
 // Adjust which nodes are opened closed...
 MAX_adjustNodes($aNodes, $expand, $collapse);
@@ -178,11 +181,11 @@
 
 $hiddenValues = array(
     'entity'   => 'conversions',
-    'clientid' => $clientId,
-    'campaignid' => $campaignId,
-    'bannerid' => $bannerId,
-    'affiliateid' => $affiliateId,
-    'zoneid' => $zoneId,
+    'clientid' => $clientid,
+    'campaignid' => $campaignid,
+    'bannerid' => $bannerid,
+    'affiliateid' => $affiliateid,
+    'zoneid' => $zoneid,
 );
 if(!empty($period_preset)) {
     MAX_displayDateSelectionForm($period_preset, $period_start, $period_end, $pageName, $tabindex, $hiddenValues);
@@ -199,15 +202,15 @@
 $aParams = array();
 $aParams['agency_id'] = OA_Permission::getAgencyId();
 
-$aParams['clientid']    = $clientId;
-$aParams['campaignid']  = $campaignId;
-$aParams['bannerid']    = $bannerId;
+$aParams['clientid']    = $clientid;
+$aParams['campaignid']  = $campaignid;
+$aParams['bannerid']    = $bannerid;
 $aZonesIds = null; // Admin_DA class expects null if no zones to be used
-if (empty($zoneId) && !empty($affiliateId)) {
-    $aZonesIds = Admin_DA::fromCache('getZonesIdsByAffiliateId', $affiliateId);
+if (empty($zoneid) && !empty($affiliateid)) {
+    $aZonesIds = Admin_DA::fromCache('getZonesIdsByAffiliateId', $affiliateid);
 }
-if(!empty($zoneId)) {
-    $aZonesIds = array($zoneId);
+if(!empty($zoneid)) {
+    $aZonesIds = array($zoneid);
 }
 $aParams['zonesIds'] = $aZonesIds;
 
@@ -251,23 +254,23 @@
 
     if($editStatuses) {
         echo ""."\n";
-        echo ""."\n";
-        echo ""."\n";
-        echo ""."\n";
-        echo ""."\n";
-        echo ""."\n";
-        echo ""."\n";
-        echo ""."\n";
-        echo ""."\n";
-        echo ""."\n";
+        echo ""."\n";
+        echo ""."\n";
+        echo ""."\n";
+        echo ""."\n";
+        echo ""."\n";
+        echo ""."\n";
+        echo ""."\n";
+        echo ""."\n";
+        echo ""."\n";
         if ($period_preset == 'specific') {
-            echo ""."\n";
-            echo ""."\n";
+            echo ""."\n";
+            echo ""."\n";
         }
         echo ""."\n";
         echo ""."\n";
-        echo ""."\n";
-        echo ""."\n";
+        echo ""."\n";
+        echo ""."\n";
     }
 
     echo "
@@ -331,9 +334,9 @@
         
";
             if ($conversionExpanded) {
-                echo "  ";
+                echo "  ";
             } else {
-                echo "  ";
+                echo "  ";
             }
 
             $aConversionStatuses = array(
@@ -444,7 +447,7 @@
             ";
     echo "
             
-             $strExpandAll  |   $strCollapseAll  
+             $strExpandAll  |   $strCollapseAll  
";
     echo "
@@ -469,7 +472,7 @@
         echo ""."\n";
     }
 
-    echo "";
+    echo "";
 
     $getValues = preg_split('/&/D', $_SERVER['QUERY_STRING']);
     foreach ($getValues as $record) {
