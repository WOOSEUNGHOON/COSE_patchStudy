ce5b36e44b714b18b0bcd34c6db0187b8d13bab8
b2evolution@@b2evolution
diff --git a/plugins/markdown_plugin/_parsedown.inc.php b/plugins/markdown_plugin/_parsedown.inc.php
index 9ab2f281d9b..7aea9f00655 100644
--- a/plugins/markdown_plugin/_parsedown.inc.php
+++ b/plugins/markdown_plugin/_parsedown.inc.php
@@ -29,6 +29,7 @@
 	9. Don't apply  around list and already existing paragraph tags
 	10. Don't convert HTML entities inside  html tags because the "Escape code" plugin does this
 	11. Fix the missed empty lines in code blocks which are started and ended with ```
+	12. Ignore wrong URLs for links and images; Allow only which begin with http://, https:// or /
 */
 
 class Parsedown
@@ -100,7 +101,7 @@ function parse($text)
 
 		# Extracts link references.
 
-		if (preg_match_all('/^[ ]{0,3}\[(.+)\][ ]?:[ ]*\n?[ ]*(.+)$/m', $text, $matches, PREG_SET_ORDER))
+		if (preg_match_all('/^[ ]{0,3}\[(.+)\][ ]?:[ ]*\n?[ ]*((https?:\/\/|\/).+)$/m', $text, $matches, PREG_SET_ORDER))
 		{
 			foreach ($matches as $matches)
 			{
@@ -589,7 +590,7 @@ private function parse_inline_elements($text)
 			if( strpos($text, '](') !== FALSE ) # inline
 			{
 				$text = str_replace( '"', '"', $text ); // revert from html entity
-				if( preg_match_all( '/(!?)(\[((?:[^][]+|(?2))*)\])\(([^"]*?)( "([^"]+)")?\)/', $text, $matches, PREG_SET_ORDER ) )
+				if( preg_match_all( '/(!?)(\[((?:[^][]+|(?2))*)\])\((https?:\/\/|\/)([^"]*?)( "([^"]+)")?\)/', $text, $matches, PREG_SET_ORDER ) )
 				{
 					foreach ($matches as $matches)
 					{
@@ -597,7 +598,7 @@ private function parse_inline_elements($text)
 						{
 							if( $this->parse_images )
 							{ // Parse images only if it is enabled
-								$element = '';
+								$element = '';
 							}
 						}
 						else
@@ -605,7 +606,7 @@ private function parse_inline_elements($text)
 							if( $this->parse_links )
 							{ // Parse links only if it is enabled
 								$element_text = $this->parse_inline_elements($matches[3]);
-								$element = ''.$element_text.'';
+								$element = ''.$element_text.'';
 							}
 						}
 
