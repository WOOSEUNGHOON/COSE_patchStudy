796617e0131277011207541313522cd1946661ab
discourse@@discourse-footnote
diff --git a/assets/javascripts/initializers/inline-footnotes.js b/assets/javascripts/initializers/inline-footnotes.js
index c7327b2..5bdd1ea 100644
--- a/assets/javascripts/initializers/inline-footnotes.js
+++ b/assets/javascripts/initializers/inline-footnotes.js
@@ -8,14 +8,20 @@ function applyInlineFootnotes(elem) {
   const footnoteRefs = elem.querySelectorAll("sup.footnote-ref");
 
   footnoteRefs.forEach((footnoteRef) => {
+    const refLink = footnoteRef.querySelector("a");
+    if (!refLink) {
+      return;
+    }
+
     const expandableFootnote = document.createElement("a");
     expandableFootnote.classList.add("expand-footnote");
     expandableFootnote.innerHTML = iconHTML("ellipsis-h");
     expandableFootnote.href = "";
     expandableFootnote.role = "button";
-    expandableFootnote.dataset.footnoteId = footnoteRef
-      .querySelector("a")
-      .id.replace("footnote-ref-", "");
+    expandableFootnote.dataset.footnoteId = refLink.id.replace(
+      "footnote-ref-",
+      ""
+    );
 
     footnoteRef.after(expandableFootnote);
   });
diff --git a/assets/vendor/javascripts/markdown-it-footnote.js b/assets/vendor/javascripts/markdown-it-footnote.js
index 122eabc..0ec8054 100644
--- a/assets/vendor/javascripts/markdown-it-footnote.js
+++ b/assets/vendor/javascripts/markdown-it-footnote.js
@@ -212,6 +212,15 @@ module.exports = function footnote_plugin(md) {
         tokens = []
       );
 
+      // Having a rendered footnote inside a link creates a nested link, which
+      // is not valid HTML, so close the parent tag first before proceeding.
+      const previousToken = state.tokens[state.tokens.length - 1];
+      if (previousToken?.content.includes(" elements by ending the elements early" do
+    raw = <<~MD
+      I have a point, see footnote. ^[the point]
+
+      ^[footnote]
+    MD
+
+    post = create_post(raw: raw)
+    post.reload
+
+    html = <<~HTML
+      I have a point, see footnote. [1]
+      [2]
+      
+
+      
+      
+      the point ↩︎
+      
+      
+      footnote ↩︎
+      
+      
+    HTML
+
+    expect(post.cooked.strip).to eq(html.strip)
+  end
 end
