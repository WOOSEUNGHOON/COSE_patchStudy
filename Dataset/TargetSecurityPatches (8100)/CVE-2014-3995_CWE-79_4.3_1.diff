e2c79117efd925636acd871a5f473512602243cf
djblets@@djblets
diff --git a/djblets/gravatars/templatetags/gravatars.py b/djblets/gravatars/templatetags/gravatars.py
index fc68cca8..699d2a07 100644
--- a/djblets/gravatars/templatetags/gravatars.py
+++ b/djblets/gravatars/templatetags/gravatars.py
@@ -25,6 +25,7 @@
 from __future__ import unicode_literals
 
 from django import template
+from django.utils.html import format_html
 
 from djblets.gravatars import (get_gravatar_url,
                                get_gravatar_url_for_email)
@@ -55,9 +56,10 @@ def gravatar(context, user, size=None):
     url = get_gravatar_url(context['request'], user, size)
 
     if url:
-        return ('' %
-                (url, size, size, user.get_full_name() or user.username))
+        return format_html(
+            '',
+            url, size, user.get_full_name() or user.username)
     else:
         return ''
 
diff --git a/djblets/gravatars/templatetags/tests.py b/djblets/gravatars/templatetags/tests.py
new file mode 100644
index 00000000..69c237d5
--- /dev/null
+++ b/djblets/gravatars/templatetags/tests.py
@@ -0,0 +1,34 @@
+from __future__ import unicode_literals
+
+from django.contrib.auth.models import User
+from django.template import Token, TOKEN_TEXT
+
+from djblets.testing.testcases import TagTest
+from djblets.gravatars.templatetags.gravatars import gravatar
+
+
+class DummyRequest(object):
+    def is_secure(self):
+        return False
+
+
+class TagTests(TagTest):
+    """Unit tests for gravatars template tags."""
+    def test_gravatar_xss(self):
+        """Testing {% gravatar %} doesn't allow XSS injection"""
+        user = User(username='test',
+                    first_name='"><"',
+                    email='test@example.com')
+
+        node = gravatar(self.parser, Token(TOKEN_TEXT, 'gravatar user 32'))
+        context = {
+            'request': DummyRequest(),
+            'user': user,
+        }
+
+        self.assertEqual(
+            node.render(context),
+            '')
