3d3deac5e6d38602b689c4fef5dac004f07a2e63
unicorn-engine@@unicorn
diff --git a/qemu/exec.c b/qemu/exec.c
index decd041634..59beefaf5f 100644
--- a/qemu/exec.c
+++ b/qemu/exec.c
@@ -1130,7 +1130,7 @@ void qemu_ram_free(struct uc_struct *uc, RAMBlock *block)
     //    ram_block_notify_remove(block->host, block->max_length);
     //}
 
-    QLIST_SAFE_REMOVE(block, next);
+    QLIST_REMOVE(block, next);
     uc->ram_list.mru_block = NULL;
     /* Write list before version */
     //smp_wmb();
diff --git a/qemu/softmmu/memory.c b/qemu/softmmu/memory.c
index b6348301ac..400ee9a029 100644
--- a/qemu/softmmu/memory.c
+++ b/qemu/softmmu/memory.c
@@ -43,12 +43,17 @@ MemoryRegion *memory_map(struct uc_struct *uc, hwaddr begin, size_t size, uint32
     MemoryRegion *ram = g_new(MemoryRegion, 1);
 
     memory_region_init_ram(uc, ram, size, perms);
-    if (ram->addr == -1) {
-        // out of memory
+    if (!ram->ram_block->host) {
+        g_free(ram->ram_block);
+        g_free(ram);
         return NULL;
     }
 
     memory_region_add_subregion(uc->system_memory, begin, ram);
+    if (ram->addr == -1) {
+        // out of memory
+        return NULL;
+    }
 
     if (uc->cpu) {
         tlb_flush(uc->cpu);
