c331d26aaab41a7e9e8c1c1a990132dca9d01e10
Aaron-Junker@@USOC
diff --git a/admin/pages/usersearch.php b/admin/pages/usersearch.php
index 0fb22a928..d779e5e6b 100644
--- a/admin/pages/usersearch.php
+++ b/admin/pages/usersearch.php
@@ -1,104 +1,128 @@
 userHasPermission("Backend", "User","Search")){
+  if($U->userHasPermission("Backend", "User")){
 ?>
-    
-    " dir="ltr">
-        
-            
-            
-            getLang("admin") ?> - getLang("admin.user.search"); ?>
-        
-        
-            getLang("admin.exit"); ?>
-            getLang("admin.user.search.intro"); ?>
-            
-                getLang("admin.user.field.username"); ?>:
-                
-                getLang("admin.user.field.mail"); ?>:
-                
-                
-                " />
-            
-            db_link, $sql);
-                    }
-                }
-                if(isset($_GET["Mail"])){
-                    if($_GET["Mail"] !== ""){
-                        $sql = "SELECT * FROM User WHERE Mail='".mysqli::real_escape_string($_GET["Mail"])."';";
-                        $dbRes = mysqli_query($U->db_link, $sql);
-                    }
-                }
-                if(isset($_GET["Id"])){
-                    if($_GET["Id"] !== ""){
-                        $sql = "SELECT * FROM User WHERE Id='".mysqli::real_escape_string($_GET["Id"])."';";
-                        $dbRes = mysqli_query($U->db_link, $sql);
-                    }
-                }
-                if(isset($_GET["Mail"]) || isset($_GET["Name"]) || isset($_GET["Id"])){
-                    $userhere = False;
-                    while($row = mysqli_fetch_array($dbRes, MYSQLI_ASSOC)){
-                        $userhere = True;
-            ?>
-                        getLang("admin.user.search.title")); ?>
-                        
-                            
-                                
-                                    
-                                        Id:
-                                    
-                                    
-                                        
-                                    
-                                
-                                
-                                    
-                                        getLang("admin.user.field.mail"); ?>:
-                                    
-                                    
-                                        
-                                    
-                                
-                                
-                                    
-                                        getLang("admin.user.field.permissionlevel"); ?>
-                                    
-                                    
-                                        getPermissionName($row["Type"]); ?>
-                                    
-                                
-                                
-                                    
-                                        getLang("admin.user.field.blocked"); ?>
-                                    
-                                    
-                                        getLang("admin.no"):$U->getLang("admin.yes"); ?>
-                                    
-                                
-                            
-                        
-            getLang("admin.user.field.mail"), str_replace("%b", $_GET["Mail"], $U->getLang("admin.user.notFound.property")));
-                    }
-                    if(!$userhere&&isset($_GET["Name"])&&$_GET["Name"]!==""){
-                        echo str_replace("%a", $U->getLang("admin.user.field.username"), str_replace("%b", $_GET["Name"], $U->getLang("admin.user.notFound.property")));
-                    }
-                    if(!$userhere&&isset($_GET["Id"])){
-                        echo str_replace("%a", $U->getLang("admin.user.field.id"), str_replace("%b", $_GET["Id"], $U->getLang("admin.user.notFound.property")));
-                    }
+  
+  " dir="ltr">
+    
+      
+      getLang("admin") ?> - getLang("admin.user.edit"); ?>
+    
+    
+      getLang("admin.back"); ?>
+      db_link, $sql);
+          $userhere = False;
+          while($row = mysqli_fetch_array($dbRes, MYSQLI_ASSOC)){
+            $user_Type = $row["Type"];
+            $user_Blocked = $row["blocked"];
+            $userhere = True;
+          }
+          if($userhere){
+            if($_SESSION["User_ID"] !== md5($_POST["N"])){
+    ?>
+              
+                userHasPermission("Backend", "User","Permission")){
+                ?>
+                  getLang("admin.user.permissionLevel"); ?>
+                  
+                    getPermissionName(-1) as $key => $value){
+                        echo "".$value."";
+                      }
+                    ?>
+                  
+                  
+                userHasPermission("Backend", "User","Block")){
+                ?>
+                    getLang("admin.user.block"); ?>
+                     />
+                userHasPermission("Backend", "User","Permission")||$U->userHasPermission("Backend", "User","Block")){
+                ?>
+                    
+                    
+                
+              
+              userHasPermission("Backend", "User","Search")){
+              ?>
+                 
+                ', 'Search user', 'width=500,height=500,status=no,titlebar=no,location=no,toolbar=no,left=300');">getLang("admin.user.moreInformation"); ?>
+              
-        
-    
+              ?>
+    ".$U->getLang("admin.user.yourself");
+            }
+          }else{
+            echo "".str_replace("%a", $_POST["N"], $U->getLang("admin.user.notFound"));
+          }
+        }elseif(isset($_POST["Submit"])){
+          if(isset($_POST["A"])&&$U->userHasPermission("Backend", "User","Permission")){
+            $permissionLevel = $_POST["A"];
+          }elseif(!$U->userHasPermission("Backend", "User","Permission")){
+            $permissionLevel = false;
+          }
+          if(isset($_POST["G"])&&$U->userHasPermission("Backend", "User","Block")){
+            $b = 1;
+          }elseif($U->userHasPermission("Backend", "User","Block")){
+            $b = 0;
+          }else{
+            $b = false;
+          }
+          if($_SESSION["User_ID"] !== md5($_POST["N"])){
+            $sql = "UPDATE User ".($permissionLevel === false?"":"SET Type='".$permissionLevel."'".($b==false?"":", ")).($b==false?"":"blocked ='".$b."' ")."WHERE Id='".mysqli::real_escape_string($_POST["N"])."';";
+            $dbRes = mysqli_query($U->db_link, $sql);
+            echo "".$U->getLang("admin.user.changed");
+          }else{
+            // When the user tries to edit himself
+            echo "".$U->getLang("admin.user.yourself");
+          }
+        }else{
+          $sql = "SELECT * FROM User;";
+          $dbRes = mysqli_query($U->db_link, $sql);
+          // Allow only values in the range from the lowest Id to the highest id
+          $highestId = 0;
+          // BUG: #54 Lowest ID don't work if over 10000000000000000000000000 accounts are created
+          $lowestId = 10000000000000000000000000;
+          while($row = mysqli_fetch_array($dbRes, MYSQLI_ASSOC)){
+            if($row["Id"] > $highestId){
+              $highestId = $row["Id"];
+            }
+            if($row["Id"] < $lowestId){
+              $lowestId = $row["Id"];
+            }
+          }
+          $text = <<<'HEREDOC'
+          
+            ID:
+            
+          
+          HEREDOC;
+          $text = str_replace('$_SERVER["PHP_SELF"]', $_SERVER['PHP_SELF'], $text);
+          $text = str_replace('%a', $highestId, $text);
+          $text = str_replace('%b', $lowestId, $text);
+          echo $text;
+          if($U->userHasPermission("Backend", "User","Search")){
+      ?>
+            
+            getLang("admin.user.search"); ?>
+      
+    
+  

@@ -106,10 +130,10 @@
   " dir="ltr">
     

-      getLang("admin") ?> - getLang("admin.settings"); ?>
+      getLang("admin") ?> - getLang("admin.user"); ?>


-        getLang("admin.exit"); ?>
+      getLang("admin.back"); ?>
getLang("rights.error"); ?>


