27caf5b46bd0890e576fea7bd7b166a0639fdf68
phpmyadmin@@phpmyadmin
diff --git a/libraries/Config.php b/libraries/Config.php
index 95f74ad3014..f75963dfddf 100644
--- a/libraries/Config.php
+++ b/libraries/Config.php
@@ -1393,11 +1393,7 @@ public function getCookiePath()
             return $cookie_path;
         }
 
-        if (isset($GLOBALS['PMA_PHP_SELF'])) {
-            $parsed_url = parse_url($GLOBALS['PMA_PHP_SELF']);
-        } else {
-            $parsed_url = parse_url(PMA_getenv('REQUEST_URI'));
-        }
+        $parsed_url = parse_url($GLOBALS['PMA_PHP_SELF']);
 
         $parts = explode(
             '/',
diff --git a/libraries/core.lib.php b/libraries/core.lib.php
index 1ee6cef23a8..037227d7979 100644
--- a/libraries/core.lib.php
+++ b/libraries/core.lib.php
@@ -940,15 +940,20 @@ function PMA_setGlobalDbOrTable($param)
  */
 function PMA_cleanupPathInfo()
 {
-    global $PMA_PHP_SELF, $_PATH_INFO;
+    global $PMA_PHP_SELF;
 
     $PMA_PHP_SELF = PMA_getenv('PHP_SELF');
+    if (empty($PMA_PHP_SELF)) {
+        $PMA_PHP_SELF = urldecode(PMA_getenv('REQUEST_URI'));
+    }
     $_PATH_INFO = PMA_getenv('PATH_INFO');
     if (! empty($_PATH_INFO) && ! empty($PMA_PHP_SELF)) {
         $path_info_pos = mb_strrpos($PMA_PHP_SELF, $_PATH_INFO);
-        $pathLength = $path_info_pos + mb_strlen($_PATH_INFO);
-        if ($pathLength === mb_strlen($PMA_PHP_SELF)) {
-            $PMA_PHP_SELF = mb_substr($PMA_PHP_SELF, 0, $path_info_pos);
+        if ($path_info_pos !== false) {
+            $path_info_part = mb_substr($PMA_PHP_SELF, $path_info_pos, mb_strlen($_PATH_INFO));
+            if ($path_info_part == $_PATH_INFO) {
+                $PMA_PHP_SELF = mb_substr($PMA_PHP_SELF, 0, $path_info_pos);
+            }
         }
     }
     $PMA_PHP_SELF = htmlspecialchars($PMA_PHP_SELF);
diff --git a/test/libraries/core/PMA_cleanupPathInfo_test.php b/test/libraries/core/PMA_cleanupPathInfo_test.php
new file mode 100644
index 00000000000..7ca9f3f971e
--- /dev/null
+++ b/test/libraries/core/PMA_cleanupPathInfo_test.php
@@ -0,0 +1,84 @@
+assertEquals(
+            $expected,
+            $GLOBALS['PMA_PHP_SELF']
+        );
+    }
+
+    /**
+     * Data provider for PMA_cleanupPathInfo tests
+     *
+     * @return array
+     */
+    public function pathsProvider()
+    {
+        return array(
+            array(
+                '/phpmyadmin/index.php/; cookieinj=value/',
+                '/phpmyadmin/index.php/;%20cookieinj=value///',
+                '/; cookieinj=value/',
+                '/phpmyadmin/index.php'
+            ),
+            array(
+                '',
+                '/phpmyadmin/index.php/;%20cookieinj=value///',
+                '/; cookieinj=value/',
+                '/phpmyadmin/index.php'
+            ),
+            array(
+                '/phpmyadmin/index.php',
+                '/phpmyadmin/index.php',
+                '',
+                '/phpmyadmin/index.php'
+            ),
+            array(
+                '',
+                '/phpmyadmin/index.php',
+                '',
+                '/phpmyadmin/index.php'
+            ),
+        );
+    }
+}
+
