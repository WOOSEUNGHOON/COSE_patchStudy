3e8832d029b035e3fcfb4c75839567a9580b4f82
roundcube@@roundcubemail
diff --git a/CHANGELOG b/CHANGELOG
index 5440d1bdd7..434ccd0857 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -7,6 +7,7 @@ CHANGELOG Roundcube Webmail
 - Elastic: Fix context menu (paste) on the recipient input (#7431)
 - Fix problem with forwarding inline images attached to messages with no HTML part (#7414)
 - Fix problem with handling attached images with same name when using database_attachments/redundant_attachments (#7455)
+- Security: Fix cross-site scripting (XSS) via HTML messages with malicious svg/namespace
 
 RELEASE 1.4.6
 -------------
diff --git a/program/lib/Roundcube/rcube_washtml.php b/program/lib/Roundcube/rcube_washtml.php
index f2200e5385..a25c44839c 100644
--- a/program/lib/Roundcube/rcube_washtml.php
+++ b/program/lib/Roundcube/rcube_washtml.php
@@ -521,7 +521,10 @@ private function dumpHtml($node, $level = 20)
                         $xpath = new DOMXPath($node->ownerDocument);
                         foreach ($xpath->query('namespace::*') as $ns) {
                             if ($ns->nodeName != 'xmlns:xml') {
-                                $dump .= ' ' . $ns->nodeName . '="' . $ns->nodeValue . '"';
+                                $dump .= sprintf(' %s="%s"',
+                                    $ns->nodeName,
+                                    htmlspecialchars($ns->nodeValue, ENT_QUOTES, $this->config['charset'])
+                                );
                             }
                         }
                     }
@@ -588,7 +591,7 @@ public function wash($html)
         $this->max_nesting_level = (int) @ini_get('xdebug.max_nesting_level');
 
         // SVG need to be parsed as XML
-        $this->is_xml = stripos($html, 'is_xml = !preg_match('/<(html|head|body)/i', $html) && stripos($html, 'is_xml ? 'loadXML' : 'loadHTML';
 
         // DOMDocument does not support HTML5, try Masterminds parser if available
diff --git a/tests/Framework/Washtml.php b/tests/Framework/Washtml.php
index b6ada253d9..737ded13d0 100644
--- a/tests/Framework/Washtml.php
+++ b/tests/Framework/Washtml.php
@@ -315,6 +315,44 @@ function test_wash_svg()
         $this->assertSame($washed, $exp, "SVG content");
     }
 
+    /**
+     * Test SVG cleanup
+     */
+    function test_wash_svg2()
+    {
+        $svg = '';
+        $exp = '';
+
+        $washer = new rcube_washtml;
+        $washed = $washer->wash($svg);
+
+        $this->assertSame($washed, $exp, "SVG content");
+
+        $svg = 'Hello victim!';
+        $exp = 'Hello victim!';
+
+        $washer = new rcube_washtml;
+        $washed = $washer->wash($svg);
+
+        $this->assertSame($washed, $exp, "SVG content");
+
+        $svg = 'Hello victim!';
+        $exp = 'Hello victim!';
+
+        $washer = new rcube_washtml;
+        $washed = $washer->wash($svg);
+
+        $this->assertSame($washed, $exp, "SVG content");
+
+        $svg = '';
+        $exp = '';
+
+        $washer = new rcube_washtml;
+        $washed = $washer->wash($svg);
+
+        $this->assertSame($washed, $exp, "SVG content");
+    }
+
     /**
      * Test position:fixed cleanup - (#5264)
      */
