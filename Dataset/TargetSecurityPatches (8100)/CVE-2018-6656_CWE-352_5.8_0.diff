c51da34a27798b5fe6d1cb5133a15da6a6384e43
zblogcn@@zblogphp
diff --git a/.gitignore b/.gitignore
index c3806d85d..aeeb7bc39 100644
--- a/.gitignore
+++ b/.gitignore
@@ -27,7 +27,6 @@
 /zb_users/plugin/*

 !/zb_users/plugin/api

 !/zb_users/plugin/AdminColor

-!/zb_users/plugin/AppCentre

 !/zb_users/plugin/AuditRecords

 !/zb_users/plugin/AutoPublisher

 !/zb_users/plugin/CloudStorage

diff --git a/zb_users/plugin/AppCentre/app_del.php b/zb_users/plugin/AppCentre/app_del.php
deleted file mode 100644
index fdd3e611b..000000000
--- a/zb_users/plugin/AppCentre/app_del.php
+++ /dev/null
@@ -1,38 +0,0 @@
-Load();

-

-$action = 'root';

-if (!$zbp->CheckRights($action)) {$zbp->ShowError(6);die();}

-

-if (!$zbp->CheckPlugin('AppCentre')) {$zbp->ShowError(48);die();}

-

-function rrmdir($dir) {

-	if (is_dir($dir)) {

-		$objects = scandir($dir);

-		foreach ($objects as $object) {

-			if ($object != '.' && $object != '..') {

-				if (filetype($dir . '/' . $object) == 'dir') {

-					rrmdir($dir . '/' . $object);

-				} else {

-					unlink($dir . '/' . $object);

-				}

-

-			}

-		}

-		reset($objects);

-		rmdir($dir);

-	}

-}

-

-rrmdir($zbp->usersdir . $_GET['type'] . '/' . $_GET['id']);

-if ($_GET['type'] == "theme") {

-	rrmdir($zbp->usersdir . '/cache/template/' . $_GET['id']);

-}

-

-Redirect($_SERVER["HTTP_REFERER"]);
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/app_pack.php b/zb_users/plugin/AppCentre/app_pack.php
deleted file mode 100644
index 4bcae6cbc..000000000
--- a/zb_users/plugin/AppCentre/app_pack.php
+++ /dev/null
@@ -1,37 +0,0 @@
-Load();

-

-$action = 'root';

-if (!$zbp->CheckRights($action)) {$zbp->ShowError(6);die();}

-

-if (!$zbp->CheckPlugin('AppCentre')) {$zbp->ShowError(48);die();}

-

-$type = $_GET['type'];

-

-$id = $_GET['id'];

-

-$app = new App;

-

-if (!$app->LoadInfoByXml($type, $id)) {

-	exit;

-}

-

-ob_clean();

-

-if (

-	function_exists('gzencode') &&

-	$zbp->Config('AppCentre')->enablegzipapp &&

-	$app->adapted > 140614// 1.3和之前版本不打包为gzba

-) {

-	header('Content-Disposition:attachment;filename=' . $id . '.gzba');

-	echo AppCentre_Pack($app, true);

-} else {

-	header('Content-Disposition:attachment;filename=' . $id . '.zba');

-	echo AppCentre_Pack($app, false);

-}
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/app_upload.php b/zb_users/plugin/AppCentre/app_upload.php
deleted file mode 100644
index 04f72867d..000000000
--- a/zb_users/plugin/AppCentre/app_upload.php
+++ /dev/null
@@ -1,36 +0,0 @@
-Load();

-

-$action = 'root';

-if (!$zbp->CheckRights($action)) {$zbp->ShowError(6);die();}

-if (!$zbp->CheckPlugin('AppCentre')) {$zbp->ShowError(48);die();}

-if (!$zbp->ValidToken(GetVars('token', 'GET'))) {$zbp->ShowError(5, __FILE__, __LINE__);die();}

-foreach ($_FILES as $key => $value) {

-	if ($_FILES[$key]['error'] == 0) {

-		if (is_uploaded_file($_FILES[$key]['tmp_name'])) {

-			$tmp_name = $_FILES[$key]['tmp_name'];

-			$name = $_FILES[$key]['name'];

-

-			$xml = file_get_contents($tmp_name);

-			if (App::UnPack($xml)) {

-				$zbp->SetHint('good', '上传APP并解压成功!');

-				Redirect($_SERVER["HTTP_REFERER"]);

-			} else {

-				$zbp->SetHint('bad', $zbp->lang['error']['64']);

-				Redirect($_SERVER["HTTP_REFERER"]);

-			}

-			;

-		}

-	} else {

-		$zbp->SetHint('bad', $zbp->lang['error']['88']);

-	}

-

-}

-

-Redirect($_SERVER["HTTP_REFERER"]);
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/client.php b/zb_users/plugin/AppCentre/client.php
deleted file mode 100644
index 13a192cd5..000000000
--- a/zb_users/plugin/AppCentre/client.php
+++ /dev/null
@@ -1,92 +0,0 @@
-Load();

-

-$action = 'root';

-if (!$zbp->CheckRights($action)) {$zbp->ShowError(6);die();}

-if (!$zbp->CheckPlugin('AppCentre')) {$zbp->ShowError(48);die();}

-

-if (!$zbp->Config('AppCentre')->username || !$zbp->Config('AppCentre')->password) {

-	$blogtitle = '应用中心-登录应用商城';

-} else {

-	$blogtitle = '应用中心-我的应用仓库';

-}

-

-if (GetVars('act') == 'login') {

-

-	$s = Server_Open('vaild');

-	if ($s) {

-

-		$zbp->Config('AppCentre')->username = GetVars("app_username");

-		$zbp->Config('AppCentre')->password = $s;

-		$zbp->SaveConfig('AppCentre');

-

-		$zbp->SetHint('good', '您已成功登录APP应用中心.');

-		Redirect('./main.php');

-		die;

-	} else {

-		$zbp->SetHint('bad', '用户名或密码错误.');

-		Redirect('./client.php');

-		die;

-	}

-}

-

-if (GetVars('act') == 'logout') {

-	$zbp->Config('AppCentre')->username = '';

-	$zbp->Config('AppCentre')->password = '';

-	$zbp->SaveConfig('AppCentre');

-	$zbp->SetHint('good', '您已退出APP应用中心.');

-	Redirect('./client.php');

-	die;

-}

-

-require $blogpath . 'zb_system/admin/admin_header.php';

-require $blogpath . 'zb_system/admin/admin_top.php';

-?>

-

-

-  

-

-  

-Config('AppCentre')->username) {?>

-            应用中心账户登录

-            

-              

-                

-                  账户登录

-                    

-                

-                

-                  用户名:

-                    

-                

-                

-                  密    码:

-                    

-                

-                

-                  

-                

-              

-            

-

-

-

-

-	

-	

-  

-

-

-
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/function.php b/zb_users/plugin/AppCentre/function.php
deleted file mode 100644
index 349a6e3bc..000000000
--- a/zb_users/plugin/AppCentre/function.php
+++ /dev/null
@@ -1,470 +0,0 @@
-浏览在线应用';

-	echo '检查应用更新';

-	echo '系统更新与校验';

-

-	if ($zbp->Config('AppCentre')->username && $zbp->Config('AppCentre')->password) {

-		echo '我的应用仓库';

-	} else {

-		echo '登录应用商城';

-	}

-

-	echo '设置';

-	echo '新建插件';

-	echo '新建主题';

-}

-

-function AppCentre_GetCheckQueryString() {

-	global $zbp;

-	$check = '';

-	$app = new app;

-	if ($app->LoadInfoByXml('theme', $zbp->theme) == true) {

-		$check .= $app->id . ':' . $app->modified . ';';

-	}

-	foreach (explode('|', $zbp->option['ZC_USING_PLUGIN_LIST']) as $id) {

-		$app = new app;

-		if ($app->LoadInfoByXml('plugin', $id) == true) {

-			$check .= $app->id . ':' . $app->modified . ';';

-		}

-	}

-	return $check;

-}

-

-function Server_Open($method) {

-	global $zbp, $blogversion;

-

-	switch ($method) {

-	case 'down':

-		Add_Filter_Plugin('Filter_Plugin_Zbp_ShowError', 'ScriptError', PLUGIN_EXITSIGNAL_RETURN);

-		header('Content-type: application/x-javascript; Charset=utf-8');

-		ob_clean();

-		$s = Server_SendRequest(APPCENTRE_URL . '?down=' . GetVars('id', 'GET'));

-		if (App::UnPack($s)) {

-			$zbp->SetHint('good', '下载APP并解压安装成功!');

-		}

-		;

-		die();

-		break;

-	case 'search':

-		if (trim(GetVars('q', 'GET')) == '') {

-			continue;

-		}

-

-		$s = Server_SendRequest(APPCENTRE_URL . '?search=' . urlencode(GetVars('q', 'GET')));

-		echo str_replace('%bloghost%', $zbp->host . 'zb_users/plugin/AppCentre/main.php', $s);

-		break;

-	case 'view':

-		$s = Server_SendRequest(APPCENTRE_URL . '?' . GetVars('QUERY_STRING', 'SERVER'));

-		if (strpos($s, '') !== false) {

-			if ($zbp->Config('AppCentre')->username || $zbp->Config('AppCentre')->password) {

-				$zbp->Config('AppCentre')->username = '';

-				$zbp->Config('AppCentre')->password = '';

-				$zbp->SaveConfig('AppCentre');

-			}

-		}

-		if (strpos($s, '') !== false) {

-			if ($zbp->Config('AppCentre')->shop_username || $zbp->Config('AppCentre')->shop_password) {

-				$zbp->Config('AppCentre')->shop_username = '';

-				$zbp->Config('AppCentre')->shop_password = '';

-				$zbp->SaveConfig('AppCentre');

-			}

-		}

-		if (strpos($s, 'app.zblogcn.com') === false) {

-			$zbp->ShowHint('bad', '后台访问应用中心故障，不能登录和下载应用，请检查主机空间是否能远程访问app.zblogcn.com。');

-		}

-

-		echo str_replace('%bloghost%', $zbp->host . 'zb_users/plugin/AppCentre/main.php', $s);

-		break;

-	case 'check':

-		$s = Server_SendRequest(APPCENTRE_URL . '?check=' . urlencode(AppCentre_GetCheckQueryString())) . '';

-		echo str_replace('%bloghost%', $zbp->host . 'zb_users/plugin/AppCentre/main.php', $s);

-		break;

-	case 'checksilent':

-		header('Content-type: application/x-javascript; Charset=utf-8');

-		ob_clean();

-		$s = Server_SendRequest(APPCENTRE_URL . '?blogsilent=1' . ($zbp->Config('AppCentre')->checkbeta ? '&betablog=1' : '') . '✓=' . urlencode(AppCentre_GetCheckQueryString())) . '';

-		if (strpos($s, ';') !== false) {

-			$newversion = substr($s, 0, 6);

-			$s = str_replace(($newversion . ';'), '', $s);

-			if ((int) $newversion > (int) $blogversion) {

-				echo '$(".main").prepend("提示:Z-BlogPHP有新版本,请用APP应用中心插件的“系统更新与校验”升级' . $newversion . '版(' . ($zbp->Config('AppCentre')->checkbeta ? 'Beta' : '') . ').");';

-			}

-		}

-		if ($s != 0) {

-			echo '$(".main").prepend("提示:有' . $s . '个应用需要更新,请在应用中心的“检查应用更新”页升级.");';

-		}

-		die();

-		break;

-	case 'vaild':

-		$data = array();

-		$data["username"] = GetVars("app_username");

-		$data["password"] = md5(GetVars("app_password"));

-		$s = Server_SendRequest(APPCENTRE_URL . '?vaild', $data);

-		return $s;

-		break;

-	case 'submitpre':

-		$s = Server_SendRequest(APPCENTRE_URL . '?submitpre=' . urlencode(GetVars('id')));

-		return $s;

-	case 'submit':

-		$app = New App;

-		$app->LoadInfoByXml($_GET['type'], $_GET['id']);

-		$data["zba"] = $app->Pack();

-		$s = Server_SendRequest(APPCENTRE_URL . '?submit=' . urlencode(GetVars('id')), $data);

-		return $s;

-	case 'shopvaild':

-		$data = array();

-		$data["shop_username"] = GetVars("shop_username");

-		$data["shop_password"] = md5(GetVars("shop_password"));

-		$s = Server_SendRequest(APPCENTRE_URL . '?shopvaild', $data);

-		return $s;

-		break;

-	case 'shoplist':

-		$s = Server_SendRequest(APPCENTRE_URL . '?shoplist');

-		echo str_replace('%bloghost%', $zbp->host . 'zb_users/plugin/AppCentre/main.php', $s);

-		break;

-	case 'apptype':

-		$zbp->Config('AppCentre')->apptype = GetVars("type");

-		$zbp->SaveConfig('AppCentre');

-		Redirect('main.php');

-		break;

-	default:

-		# code...

-		break;

-	}

-

-}

-

-function Server_SendRequest($url, $data = array(), $u = '', $c = '') {

-	global $zbp;

-

-	$un = $zbp->Config('AppCentre')->username;

-	$ps = $zbp->Config('AppCentre')->password;

-	$c .= ' apptype=' . urlencode($zbp->Config('AppCentre')->apptype) . '; ';

-	$c .= ' app_guestver=' . urlencode('2.0') . '; ';

-	$c .= ' app_host=' . urlencode($zbp->host) . '; ';

-	$c .= ' app_email=' . urlencode($zbp->user->Email) . '; ';

-	$c .= ' app_user=' . urlencode($zbp->user->Name) . '; ';

-	if ($un && $ps) {

-		$c .= "username=" . urlencode($un) . "; password=" . urlencode($ps);

-	}

-

-	$shopun = $zbp->Config('AppCentre')->shop_username;

-	$shopps = $zbp->Config('AppCentre')->shop_password;

-

-	if ($shopun && $shopps) {

-		if ($c !== '') {

-			$c .= '; ';

-		}

-

-		$c .= "shop_username=" . urlencode($shopun) . "; shop_password=" . urlencode($shopps);

-	}

-

-	$u = 'ZBlogPHP/' . substr(ZC_BLOG_VERSION, -6, 6) . ' ' . GetGuestAgent();

-

-	if (!class_exists('NetworkFactory', false)) {

-		if (class_exists('Network')) {

-			return Server_SendRequest_Network($url, $data, $u, $c);

-		}

-	}

-

-	if (function_exists("curl_init") && function_exists('curl_exec')) {

-		return Server_SendRequest_CUrl($url, $data, $u, $c);

-	}

-

-	if (!ini_get("allow_url_fopen")) {

-		return "";

-	}

-

-	if ($data) {

-//POST

-		$data = http_build_query($data);

-		$opts = array(

-			'http' => array(

-				'method' => 'POST',

-				'header' => "Content-Type:application/x-www-form-urlencoded\r\n" .

-				'Content-Length: ' . strlen($data) . "\r\n" .

-				"Cookie: " . $c . "\r\n",

-				'user_agent' => $u,

-				'content' => $data,

-			),

-		);

-		$content = stream_context_create($opts);

-	} else {

-//GET

-		$opts = array(

-			'http' => array(

-				'method' => 'GET',

-				'header' => "Cookie: " . $c . "\r\n",

-				'user_agent' => $u,

-			),

-		);

-		$content = stream_context_create($opts);

-	}

-

-	if (function_exists('ini_set')) {

-		ini_set('default_socket_timeout', 120);

-	}

-

-	if (extension_loaded('zlib')) {

-		return file_get_contents('compress.zlib://' . $url, false, $content);

-	} else {

-		return file_get_contents($url, false, $content);

-	}

-}

-

-function Server_SendRequest_CUrl($url, $data = array(), $u, $c) {

-	global $zbp;

-

-	$ch = curl_init($url);

-	if (extension_loaded('zlib')) {

-		curl_setopt($ch, CURLOPT_ENCODING, 'gzip');

-	}

-	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

-	curl_setopt($ch, CURLOPT_TIMEOUT, 120);

-	curl_setopt($ch, CURLOPT_USERAGENT, $u);

-	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);

-	curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

-	if (ini_get("safe_mode") == false && ini_get("open_basedir") == false) {

-		curl_setopt($ch, CURLOPT_MAXREDIRS, 10);

-		curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);

-	}

-	if ($c) {

-		curl_setopt($ch, CURLOPT_COOKIE, $c);

-	}

-

-	if ($data) {

-//POST

-		curl_setopt($ch, CURLOPT_POST, 1);

-		curl_setopt($ch, CURLOPT_POSTFIELDS, $data);

-	} else { //GET

-	}

-

-	$r = curl_exec($ch);

-	curl_close($ch);

-

-	return $r;

-}

-

-function Server_SendRequest_Network($url, $data = array(), $u, $c) {

-	global $zbp;

-

-	$ajax = Network::Create();

-	if (!$ajax) {

-		throw new Exception('主机没有开启访问外部网络功能');

-	}

-

-	if ($data) {

-//POST

-		$ajax->open('POST', $url);

-		$ajax->enableGzip();

-		$ajax->setTimeOuts(120, 120, 0, 0);

-		$ajax->setRequestHeader('User-Agent', $u);

-		$ajax->setRequestHeader('Cookie', $c);

-		$ajax->send($data);

-	} else {

-		$ajax->open('GET', $url);

-		$ajax->enableGzip();

-		$ajax->setTimeOuts(120, 120, 0, 0);

-		$ajax->setRequestHeader('User-Agent', $u);

-		$ajax->setRequestHeader('Cookie', $c);

-		$ajax->send();

-	}

-

-	return $ajax->responseText;

-}

-

-function AppCentre_CreateOptoinsOfVersion($default) {

-	global $zbp;

-

-	$s = null;

-	$array = $GLOBALS['zbpvers'];

-	krsort($array);

-	$i = 0;

-	foreach ($array as $key => $value) {

-		$i += 1;

-		if (($i == 1) or strpos($value, 'Beta') === False) {

-			$s .= '' . $value . '';

-		}

-

-	}

-	return $s;

-}

-

-function AppCentre_GetHttpContent($url) {

-

-	if (function_exists("GetHttpContent")) {

-		return GetHttpContent($url);

-	}

-

-	$r = null;

-	if (function_exists("curl_init")) {

-		$ch = curl_init($url);

-		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

-		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);

-		curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

-		if (ini_get("safe_mode") == false && ini_get("open_basedir") == false) {

-			curl_setopt($ch, CURLOPT_MAXREDIRS, 1);

-			curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);

-		}

-		$r = curl_exec($ch);

-		curl_close($ch);

-	} elseif (ini_get("allow_url_fopen")) {

-		$r = file_get_contents($url);

-	}

-

-	return $r;

-}

-

-function AppCentre_crc32_signed($num) {

-	$crc = crc32($num);

-	if ($crc & 0x80000000) {

-		$crc ^= 0xffffffff;

-		$crc += 1;

-		$crc = -$crc;

-	}

-	return $crc;

-}

-

-$AppCentre_dirs = array();

-$AppCentre_files = array();

-

-function AppCentre_GetAllFileDir($dir) {

-	global $AppCentre_dirs;

-	global $AppCentre_files;

-	if (function_exists('scandir')) {

-		foreach (scandir($dir) as $d) {

-			if (is_dir($dir . $d)) {

-				if (substr($d, 0, 1) != '.') {

-					AppCentre_GetAllFileDir($dir . $d . '/');

-					$AppCentre_dirs[] = $dir . $d . '/';

-				}

-			} else {

-				$AppCentre_files[] = $dir . $d;

-			}

-		}

-	} else {

-		if ($handle = opendir($dir)) {

-			while (false !== ($file = readdir($handle))) {

-				if (substr($file, 0, 1) != '.') {

-					if (is_dir($dir . $file)) {

-						$AppCentre_dirs[] = $dir . $file . '/';

-						AppCentre_GetAllFileDir($dir . $file . '/');

-					} else {

-						$AppCentre_files[] = $dir . $file;

-					}

-				}

-			}

-			closedir($handle);

-		}

-	}

-

-}

-

-function AppCentre_Pack($app, $gzip) {

-

-	global $zbp;

-	global $AppCentre_dirs;

-	global $AppCentre_files;

-

-	$AppCentre_dirs = array();

-	$AppCentre_files = array();

-

-	$dir = $app->GetDir();

-	AppCentre_GetAllFileDir($dir);

-

-	$s = '';

-	$s .= '';

-

-	$s .= '' . htmlspecialchars($app->id) . '';

-	$s .= '' . htmlspecialchars($app->name) . '';

-	$s .= '' . htmlspecialchars($app->url) . '';

-	$s .= '' . htmlspecialchars($app->note) . '';

-	$s .= '' . htmlspecialchars($app->description) . '';

-

-	$s .= '' . htmlspecialchars($app->path) . '';

-	$s .= '' . htmlspecialchars($app->include) . '';

-	$s .= '' . htmlspecialchars($app->level) . '';

-

-	$s .= '';

-	$s .= '' . htmlspecialchars($app->author_name) . '';

-	$s .= '' . htmlspecialchars($app->author_email) . '';

-	$s .= '' . htmlspecialchars($app->author_url) . '';

-	$s .= '';

-

-	$s .= '';

-	$s .= '' . htmlspecialchars($app->source_name) . '';

-	$s .= '' . htmlspecialchars($app->source_email) . '';

-	$s .= '' . htmlspecialchars($app->source_url) . '';

-	$s .= '';

-

-	$s .= '' . htmlspecialchars($app->adapted) . '';

-	$s .= '' . htmlspecialchars($app->version) . '';

-	$s .= '' . htmlspecialchars($app->pubdate) . '';

-	$s .= '' . htmlspecialchars($app->modified) . '';

-	$s .= '' . htmlspecialchars($app->price) . '';

-

-	$s .= '';

-	$s .= '' . htmlspecialchars($app->advanced_dependency) . '';

-	$s .= '' . htmlspecialchars($app->advanced_rewritefunctions) . '';

-	$s .= '' . htmlspecialchars($app->advanced_conflict) . '';

-	$s .= '';

-

-	$s .= '';

-	$s .= '' . htmlspecialchars($app->sidebars_sidebar1) . '';

-	$s .= '' . htmlspecialchars($app->sidebars_sidebar2) . '';

-	$s .= '' . htmlspecialchars($app->sidebars_sidebar3) . '';

-	$s .= '' . htmlspecialchars($app->sidebars_sidebar4) . '';

-	$s .= '' . htmlspecialchars($app->sidebars_sidebar5) . '';

-	$s .= '';

-

-	foreach ($AppCentre_dirs as $key => $value) {

-		$value = preg_replace('/[^(\x20-\x7F)]*/', '', $value);

-		$d = $app->id . '/' . str_replace($dir, '', $value);

-		$s .= '' . htmlspecialchars($d) . '';

-	}

-	foreach ($AppCentre_files as $key => $value) {

-		$d = $app->id . '/' . str_replace($dir, '', $value);

-		$ext = pathinfo($value, PATHINFO_EXTENSION);

-		if ($ext == 'php' || $ext == 'inc') {

-			$c = base64_encode(RemoveBOM(file_get_contents($value)));

-		} else {

-			if (strripos($d, '/plugin.xml') !== false) {

-				$x = file_get_contents($value);

-				$x1 = 'app_host:' . $zbp->host . ';';

-				$x2 = 'app_email:' . $zbp->user->Email . ';';

-				$x3 = 'app_user:' . $zbp->user->Name . ';';

-				$x = str_replace('', '', $x);

-				$c = base64_encode($x);

-			} elseif (strripos($d, '/theme.xml') !== false) {

-				$x = file_get_contents($value);

-				$x1 = 'app_host:' . $zbp->host . ';';

-				$x2 = 'app_email:' . $zbp->user->Email . ';';

-				$x3 = 'app_user:' . $zbp->user->Name . ';';

-				$x = str_replace('', '', $x);

-				$c = base64_encode($x);

-			} else {

-				$c = base64_encode(file_get_contents($value));

-			}

-

-		}

-		if (IS_WINDOWS) {

-			$d = iconv($zbp->lang['windows_character_set'], 'UTF-8//IGNORE', $d);

-		}

-

-		$s .= '' . htmlspecialchars($d) . '' . $c . '';

-	}

-

-	$s .= '';

-

-	if ($gzip) {

-		return gzencode($s, 9, FORCE_GZIP);

-	} else {

-		return $s;

-	}

-

-}
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/images/Cube1.png b/zb_users/plugin/AppCentre/images/Cube1.png
deleted file mode 100644
index 5453102d1..000000000
Binary files a/zb_users/plugin/AppCentre/images/Cube1.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/Cube2.png b/zb_users/plugin/AppCentre/images/Cube2.png
deleted file mode 100644
index e830ab2b4..000000000
Binary files a/zb_users/plugin/AppCentre/images/Cube2.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/application_edit.png b/zb_users/plugin/AppCentre/images/application_edit.png
deleted file mode 100644
index fb2efb877..000000000
Binary files a/zb_users/plugin/AppCentre/images/application_edit.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/bricks.png b/zb_users/plugin/AppCentre/images/bricks.png
deleted file mode 100644
index 76b658faa..000000000
Binary files a/zb_users/plugin/AppCentre/images/bricks.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/delete.png b/zb_users/plugin/AppCentre/images/delete.png
deleted file mode 100644
index 08f249365..000000000
Binary files a/zb_users/plugin/AppCentre/images/delete.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/document_empty.png b/zb_users/plugin/AppCentre/images/document_empty.png
deleted file mode 100644
index 711a8c1f3..000000000
Binary files a/zb_users/plugin/AppCentre/images/document_empty.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/download.png b/zb_users/plugin/AppCentre/images/download.png
deleted file mode 100644
index 102b11bb4..000000000
Binary files a/zb_users/plugin/AppCentre/images/download.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/drive-upload.png b/zb_users/plugin/AppCentre/images/drive-upload.png
deleted file mode 100644
index 93589e4da..000000000
Binary files a/zb_users/plugin/AppCentre/images/drive-upload.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/loading.gif b/zb_users/plugin/AppCentre/images/loading.gif
deleted file mode 100644
index e38b1818c..000000000
Binary files a/zb_users/plugin/AppCentre/images/loading.gif and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/plugin.png b/zb_users/plugin/AppCentre/images/plugin.png
deleted file mode 100644
index 9c8bd8951..000000000
Binary files a/zb_users/plugin/AppCentre/images/plugin.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/refresh.png b/zb_users/plugin/AppCentre/images/refresh.png
deleted file mode 100644
index 80fbf86b4..000000000
Binary files a/zb_users/plugin/AppCentre/images/refresh.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/refresh2.png b/zb_users/plugin/AppCentre/images/refresh2.png
deleted file mode 100644
index 68f164bbe..000000000
Binary files a/zb_users/plugin/AppCentre/images/refresh2.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/images/style.css b/zb_users/plugin/AppCentre/images/style.css
deleted file mode 100644
index b94e8637e..000000000
--- a/zb_users/plugin/AppCentre/images/style.css
+++ /dev/null
@@ -1,32 +0,0 @@
-.app-theme{

-	float:left;

-	float:left;

-	width:350px;

-	background:#f0f0f0;

-	margin:5px 20px 40px 5px;

-

-}

-

-

-.app-plugin{

-	float:left;

-	width:350px;

-	background:#f0f0f0;

-	margin:5px 20px 40px 5px;

-	box-shadow: 0 0 10px #aaa;

-}

-

-.app-theme-image img{

-	width:320px;

-	height:240px;

-}

-

-.app-plugin-image img{

-	width:128px;

-	height:128px;

-}

-

-

-.app-plugin-id,.app-theme-id{

-	display:none;

-}

diff --git a/zb_users/plugin/AppCentre/images/theme.png b/zb_users/plugin/AppCentre/images/theme.png
deleted file mode 100644
index 2116fcfcb..000000000
Binary files a/zb_users/plugin/AppCentre/images/theme.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/include.php b/zb_users/plugin/AppCentre/include.php
deleted file mode 100644
index 0c5f444a2..000000000
--- a/zb_users/plugin/AppCentre/include.php
+++ /dev/null
@@ -1,109 +0,0 @@
-LoadLanguage('plugin', 'AppCentre');

-	} else {

-		if (is_readable($f = $zbp->path . 'zb_users/plugin/AppCentre/language/' . $zbp->option['ZC_BLOG_LANGUAGEPACK'] . '.php')) {

-			$zbp->lang['AppCentre'] = require $f;

-		} elseif (is_readable($f = $zbp->path . 'zb_users/plugin/AppCentre/language/' . 'zh-cn' . '.php')) {

-			$zbp->lang['AppCentre'] = require $f;

-		}

-

-	}

-}

-

-function InstallPlugin_AppCentre() {

-	global $zbp;

-	$zbp->Config('AppCentre')->enabledcheck = 1;

-	$zbp->Config('AppCentre')->checkbeta = 0;

-	$zbp->Config('AppCentre')->enabledevelop = 0;

-	$zbp->Config('AppCentre')->enablegzipapp = 0;

-	$zbp->SaveConfig('AppCentre');

-}

-

-function AppCentre_AddMenu(&$m) {

-	global $zbp;

-	$m['nav_AppCentre'] = MakeLeftMenu("root", $zbp->lang['AppCentre']['name'], $zbp->host . "zb_users/plugin/AppCentre/main.php", "nav_AppCentre", "aAppCentre", $zbp->host . "zb_users/plugin/AppCentre/images/Cube1.png");

-}

-

-function AppCentre_AddSiteInfoMenu() {

-	global $zbp;

-	if ($zbp->Config('AppCentre')->enabledcheck) {

-		$last = (int) $zbp->Config('AppCentre')->lastchecktime;

-		if ((time() - $last) > 11 * 60 * 60) {

-			echo "";

-			$zbp->Config('AppCentre')->lastchecktime = time();

-			$zbp->SaveConfig('AppCentre');

-		}

-	}

-	if ($zbp->version >= 150101 && (int) $zbp->option['ZC_LAST_VERSION'] < 150101) {

-		echo "";

-	}

-

-}

-

-function AppCentre_AddThemeMenu() {

-	global $zbp;

-	echo "";

-	echo "";

-	echo "";

-}

-

-function AppCentre_AddPluginMenu() {

-	global $zbp;

-	echo "";

-	echo "";

-	echo "";

-}

-

-//$appid是App在应用中心的发布后的文章ID数字号，非App的ID名称。

-function AppCentre_App_Check_ISBUY($appid) {

-	global $zbp;

-	$postdate = array(

-		'email' => $zbp->Config('AppCentre')->shop_username,

-		'password' => $zbp->Config('AppCentre')->shop_password,

-		'appid' => $appid,

-		    );

-	$http_post = Network::Create();

-	$http_post->open('POST', APPCENTRE_API_URL . APPCENTRE_API_APP_ISBUY);

-	$http_post->setRequestHeader('Referer', substr($zbp->host, 0, -1) . $zbp->currenturl);

-

-	$http_post->send($postdate);

-	$result = json_decode($http_post->responseText, true);

-	return $result;

-}
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/language/en.php b/zb_users/plugin/AppCentre/language/en.php
deleted file mode 100644
index 48d2bc918..000000000
--- a/zb_users/plugin/AppCentre/language/en.php
+++ /dev/null
@@ -1,6 +0,0 @@
-'App Store',

-

-);
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/language/zh-cn.php b/zb_users/plugin/AppCentre/language/zh-cn.php
deleted file mode 100644
index fcbff34f2..000000000
--- a/zb_users/plugin/AppCentre/language/zh-cn.php
+++ /dev/null
@@ -1,6 +0,0 @@
-'应用中心',

-

-);
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/language/zh-tw.php b/zb_users/plugin/AppCentre/language/zh-tw.php
deleted file mode 100644
index b732a9f23..000000000
--- a/zb_users/plugin/AppCentre/language/zh-tw.php
+++ /dev/null
@@ -1,6 +0,0 @@
-'應用市集',

-

-);
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/logo.png b/zb_users/plugin/AppCentre/logo.png
deleted file mode 100644
index 9ef68f625..000000000
Binary files a/zb_users/plugin/AppCentre/logo.png and /dev/null differ
diff --git a/zb_users/plugin/AppCentre/main.php b/zb_users/plugin/AppCentre/main.php
deleted file mode 100644
index 465232321..000000000
--- a/zb_users/plugin/AppCentre/main.php
+++ /dev/null
@@ -1,60 +0,0 @@
-Load();

-

-$action = 'root';

-if (!$zbp->CheckRights($action)) {$zbp->ShowError(6);die();}

-

-if (!$zbp->CheckPlugin('AppCentre')) {$zbp->ShowError(48);die();}

-

-$blogtitle = '应用中心';

-

-if (!$zbp->Config('AppCentre')->HasKey('enabledcheck')) {

-	$zbp->Config('AppCentre')->enabledcheck = 1;

-	$zbp->Config('AppCentre')->checkbeta = 0;

-	$zbp->Config('AppCentre')->enabledevelop = 0;

-	$zbp->SaveConfig('AppCentre');

-}

-

-if (count($_POST) > 0) {

-

-	$zbp->SetHint('good');

-	Redirect('./main.php');

-}

-

-require $blogpath . 'zb_system/admin/admin_header.php';

-require $blogpath . 'zb_system/admin/admin_top.php';

-

-?>

-

-

-  

-

-  

-

-

-	

-	

-	

-  

-

-
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/plugin.js.php b/zb_users/plugin/AppCentre/plugin.js.php
deleted file mode 100644
index 3c35906e3..000000000
--- a/zb_users/plugin/AppCentre/plugin.js.php
+++ /dev/null
@@ -1,56 +0,0 @@
-Load();
-ob_clean();
-header('Content-Type: application/x-javascript; charset=utf-8');
-?>
-
-$(document).ready(function(){ 
-
-$("#divMain2").prepend("本地上传并安装插件zba文件:        ")
-
-if(app_enabledevelop){
-
-$("tr").each(function(){
-	$(this).append("");
-});
-$("tr").first().children().last().append("开发者模式");
-
-}
-
-$(".plugin").each(function(){
-
-	var t=$(this).data("pluginid");
-	if(t==undefined)t=$(this).find("strong").html();
-	var s=""
-	s=s+"";
-
-	s=s+"    ";
-
-	if(app_username){
-		s=s+"    ";
-	}
-
-
-	
-	if(app_enabledevelop){
-	
-		$(this).parent().children().last().append(s);
-
-	}
-
-	if(!$(this).hasClass("plugin-on")){
-		$(this).parent().children().eq(4).append("    ");
-	}else{
-	};
-
-});
-
-
-
-});
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/plugin.xml b/zb_users/plugin/AppCentre/plugin.xml
deleted file mode 100644
index 9b4153355..000000000
--- a/zb_users/plugin/AppCentre/plugin.xml
+++ /dev/null
@@ -1,38 +0,0 @@
-

-

-AppCentre

-应用中心

-http://www.zblogcn.com/

-Z-BlogPHP版的资源大本营

-

-main.php

-include.php

-1

-

-  zx.asd

-  rainbowsoft@gmail.com

-  http://www.zblogcn.com/

-

-

-  

-  

-  

-

-131221

-2.1

-2013-07-07

-2015-12-08

-0

-

-  

-  

-  

-

-

-  

-  

-  

-  

-  

-

-
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/plugin_edit.php b/zb_users/plugin/AppCentre/plugin_edit.php
deleted file mode 100644
index eba5c75f1..000000000
--- a/zb_users/plugin/AppCentre/plugin_edit.php
+++ /dev/null
@@ -1,262 +0,0 @@
-Load();

-

-$action = 'root';

-if (!$zbp->CheckRights($action)) {$zbp->ShowError(6);die();}

-

-if (!$zbp->CheckPlugin('AppCentre')) {$zbp->ShowError(48);die();}

-

-$blogtitle = '应用中心-插件编辑';

-

-if (GetVars('id')) {

-	$app = $zbp->LoadApp('plugin', GetVars('id'));

-	$mt = array();

-	$ft = GetFilesInDir($zbp->path . '/zb_users/plugin/' . $app->id . '/', 'php|inc|png');

-	foreach ($ft as $f) {

-		$mt[] = filemtime($f);

-	}

-	rsort($mt);

-	if (count($mt) == 0) {

-		$mt[] = time();

-	}

-

-	$app->modified = date('Y-m-d', reset($mt));

-} else {

-	$app = new App;

-	$app->price = 0;

-	$app->version = '1.0';

-	$app->pubdate = date('Y-m-d', time());

-	$app->modified = date('Y-m-d', time());

-	$v = array_keys($zbpvers);

-	$app->adapted = (string) end($v);

-	$app->type = 'plugin';

-	$app->author_name = $zbp->user->Name;

-	$app->author_email = $zbp->user->Email;

-	$app->author_url = $zbp->user->HomePage;

-	$app->path = 'main.php';

-	$app->include = 'include.php';

-

-}

-

-if (count($_POST) > 0) {

-

-	$app->id = trim($_POST['app_id']);

-	if (!CheckRegExp($app->id, "/^[A-Za-z0-9_]{3,30}/")) {$zbp->ShowError('ID名必须是字母数字和下划线组成,长度3-30字符.');die();}

-	if (!GetVars('id')) {

-		$app2 = $zbp->LoadApp('plugin', $app->id);

-		if ($app2->id) {$zbp->ShowError('已存在同名的APP应用.');die();}

-		@mkdir($zbp->usersdir . 'plugin/' . $app->id . '/');

-		@copy($zbp->usersdir . 'plugin/AppCentre/images/plugin.png', $zbp->usersdir . 'plugin/' . $app->id . '/logo.png');

-

-		if (trim($_POST['app_path'])) {

-			$file = file_get_contents('tpl/main.html');

-			$file = str_replace("<%appid%>", $app->id, $file);

-			$path = $zbp->usersdir . 'plugin/' . $app->id . '/' . trim($_POST['app_path']);

-			@file_put_contents($path, $file);

-		}

-		if (trim($_POST['app_include'])) {

-			$file = file_get_contents('tpl/include.html');

-			$file = str_replace("<%appid%>", $app->id, $file);

-			$path = $zbp->usersdir . 'plugin/' . $app->id . '/include.php';

-			@file_put_contents($path, $file);

-		}

-	}

-

-	$app->name = trim($_POST['app_name']);

-	$app->url = trim($_POST['app_url']);

-	$app->note = trim($_POST['app_note']);

-	$app->adapted = $_POST['app_adapted'];

-	$app->version = (float) $_POST['app_version'];

-	if ($app->version == 1) {

-		$app->version = '1.0';

-	}

-

-	$app->pubdate = date('Y-m-d', strtotime($_POST['app_pubdate']));

-	$app->modified = date('Y-m-d', time());

-

-	$app->author_name = trim($_POST['app_author_name']);

-	$app->author_email = trim($_POST['app_author_email']);

-	$app->author_url = trim($_POST['app_author_url']);

-

-	$app->path = trim($_POST['app_path']);

-	$app->include = trim($_POST['app_include']);

-	$app->level = (int) $_POST['app_level'];

-	$app->price = (float) $_POST['app_price'];

-

-	$app->advanced_dependency = trim($_POST['app_advanced_dependency']);

-	$app->advanced_rewritefunctions = trim($_POST['app_advanced_rewritefunctions']);

-	$app->advanced_conflict = trim($_POST['app_advanced_conflict']);

-

-	$app->description = trim($_POST['app_description']);

-

-	$app->SaveInfoByXml();

-

-	$zbp->SetHint('good', '提交成功！现在立刻上传到应用中心！');

-	Redirect($_SERVER["HTTP_REFERER"]);

-}

-

-require $blogpath . 'zb_system/admin/admin_header.php';

-require $blogpath . 'zb_system/admin/admin_top.php';

-

-?>

-

-

-  

-

-  

-

-

-  

-    

-       

-       

-    

-    

-      · 插件ID

-            插件ID为插件的目录名,且不能重复.ID名只能用字母数字和下划线的组合.

-       

-          id) {

-	echo 'readonly="readonly"';

-}

-?>  />

-        

-    

-    

-      · 插件名称

-       

-          

-        

-    

-    

-      · 插件发布页面

-       

-          

-        

-    

-    

-      · 插件简介

-       

-          

-        

-    

-    

-      · 适用的最低要求 Z-Blog 版本

-       

-          

-adapted);?>

-          

-        

-    

-    

-      · 插件版本号

-       

-          

-        

-    

-    

-      · 插件首发时间

-            日期格式为2012-12-12

-       

-          

-        

-    

-    

-      · 插件最后修改时间

-            系统自动检查include.php的最后修改日期

-       

-          

-        

-    

-    

-      · 作者名称

-       

-          

-        

-    

-    

-      · 作者邮箱

-       

-          

-        

-    

-    

-      · 作者网站

-       

-          

-        

-    

-    

-      · 插件管理页 (可选)

-            习惯命名为main.php

-       

-          

-        

-    

-    

-      · 插件嵌入页 (可选)

-            只能命名为include.php

-       

-          

-        

-    

-    

-      · 插件管理权限 (可选)

-       

-          

-

-          

-        

-    

-    

-      · 插件定价

-       

-          

-        

-    

-    

-      · 【高级】依赖插件（以|分隔）(可选)

-       

-          

-        

-    

-    

-      · 【高级】插件重写系统函数列表（以|分隔）(可选)

-       

-          

-        

-    

-    

-      · 【高级】插件冲突插件列表（以|分隔）(可选)

-       

-          

-        

-    

-    

-      · 详细说明 (可选)

-       

-          description);?>

-        

-    

-  

-   提示:插件的图标是名为logo.png的128 x 128 px大小的png文件,推荐使用Metro Studio软件创建logo,插件的缩略图(可选)是名为screenshot.png的300x240px大小的png文件,放在插件的目录下.

-  

-    

-  

-   

-

-

-	

-	

-  

-

-
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/setting.php b/zb_users/plugin/AppCentre/setting.php
deleted file mode 100644
index 86c1cc3dd..000000000
--- a/zb_users/plugin/AppCentre/setting.php
+++ /dev/null
@@ -1,83 +0,0 @@
-Load();

-

-$action = 'root';

-if (!$zbp->CheckRights($action)) {$zbp->ShowError(6);die();}

-

-if (!$zbp->CheckPlugin('AppCentre')) {$zbp->ShowError(48);die();}

-

-$blogtitle = '应用中心-设置';

-

-if (GetVars('act') == 'save') {

-

-	$zbp->Config('AppCentre')->enabledcheck = (int) GetVars("app_enabledcheck");

-	$zbp->Config('AppCentre')->checkbeta = (int) GetVars("app_checkbeta");

-	$zbp->Config('AppCentre')->enabledevelop = (int) GetVars("app_enabledevelop");

-	$zbp->Config('AppCentre')->enablegzipapp = (int) GetVars("app_enablegzipapp");

-	$zbp->SaveConfig('AppCentre');

-

-	$zbp->SetHint('good');

-	Redirect('./setting.php');

-

-}

-

-require $blogpath . 'zb_system/admin/admin_header.php';

-require $blogpath . 'zb_system/admin/admin_top.php';

-?>

-

-

-  

-

-  

-

-            

-              

-                

-                  设置

-                    

-                

-                

-                  · 启用自动检查更新

-                        在进入后台时会检查应用更新和系统更新 

-                  

-                

-                

-                  · 检查Beta版程序

-                        若打开，则系统将检查最新测试版的Z-Blog更新

-                  

-                

-                

-                  · 启用开发者模式

-                        启用开发者模式可以修改应用信息、导出应用和远程提交应用

-                  

-                

-                

-                  · 导出经过GZip压缩的应用包

-                        1.4以下版本不支持应用压缩包导入及导出

-                  

-                

-              

-              

-              

-                

-              

-              

-            

-

-

-	

-	

-  

-

-

-

-
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/submit.php b/zb_users/plugin/AppCentre/submit.php
deleted file mode 100644
index d74f99098..000000000
--- a/zb_users/plugin/AppCentre/submit.php
+++ /dev/null
@@ -1,103 +0,0 @@
-Load();

-

-$action = 'root';

-if (!$zbp->CheckRights($action)) {$zbp->ShowError(6);die();}

-

-if (!$zbp->CheckPlugin('AppCentre')) {$zbp->ShowError(48);die();}

-

-$blogtitle = '应用中心-提交应用';

-

-$s = '';

-$t = '';

-

-$app = New App;

-$app->LoadInfoByXml($_GET['type'], $_GET['id']);

-

-$t['id'] = $app->id;

-$t['author'] = $app->author_name;

-$t['modified'] = $app->modified;

-

-$t = json_encode($t);

-

-if ($_SERVER['REQUEST_METHOD'] == 'GET') {

-	$s = Server_Open('submitpre');

-}

-

-if ($_SERVER['REQUEST_METHOD'] == 'POST') {

-	$url = Server_Open('submit');

-	if (substr($url, 0, 4) == 'http') {

-		Redirect($url);

-	} else {

-		echo '';

-	}

-}

-

-if (!$s) {

-	$s = '{"id":"未提交","author":"未提交","modified":"未提交"}';

-}

-

-require $blogpath . 'zb_system/admin/admin_header.php';

-require $blogpath . 'zb_system/admin/admin_top.php';

-

-?>

-

-

-  

-

-  

-

-

-

-

- 拟提交发布或更新的应用信息[编辑]

-

-· 应用ID 

-· 应用文件名 

-· 最后更新日期 

-

-

-

-

- “Z-Blog应用中心”目标应用的相关信息

-· 应用发布ID 

-· 应用提交用户 

-· 最后更新日期 

-

-

-

-

- 提示:金牌开发者、银牌开发者、铜牌开发者和铁牌开发者只能更新和提交自己的应用,白金开发者可以更新和提交所有应用.

- 

-

-

-

-

-

-	

-	

-  

-

-

-

-
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/theme.js.php b/zb_users/plugin/AppCentre/theme.js.php
deleted file mode 100644
index 522424f1c..000000000
--- a/zb_users/plugin/AppCentre/theme.js.php
+++ /dev/null
@@ -1,47 +0,0 @@
-Load();
-?>
-
-$(document).ready(function(){ 
-
-$("#divMain2").prepend("本地上传并安装主题zba文件:        ");
-
-
-
-$(".theme").each(function(){
-	var t=$(this).find("strong").html();
-	var s="";
-
-	if(app_enabledevelop){
-
-	s=s+"    ";
-
-	s=s+"    ";
-
-	}
-
-	if($(this).hasClass("theme-now")){
-		s=s+"    ";
-	}
-
-
-	if($(this).hasClass("theme-other")){
-		s=s+"    ";
-	}
-
-	if(app_enabledevelop&&app_username){
-		s=s+"";
-	}
-
-	s=s+"";
-	$(this).append(s);
-	
-});
-
-});
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/theme_edit.php b/zb_users/plugin/AppCentre/theme_edit.php
deleted file mode 100644
index d9b84da79..000000000
--- a/zb_users/plugin/AppCentre/theme_edit.php
+++ /dev/null
@@ -1,363 +0,0 @@
-Load();

-

-$action = 'root';

-if (!$zbp->CheckRights($action)) {$zbp->ShowError(6);die();}

-

-if (!$zbp->CheckPlugin('AppCentre')) {$zbp->ShowError(48);die();}

-

-$blogtitle = '应用中心-主题编辑';

-

-if (GetVars('id')) {

-	$app = $zbp->LoadApp('theme', GetVars('id'));

-	$mt = array();

-	$ft = GetFilesInDir($zbp->path . '/zb_users/theme/' . $app->id . '/', 'php|inc|png');

-	foreach ($ft as $f) {

-		$mt[] = filemtime($f);

-	}

-	$ft = GetFilesInDir($zbp->path . '/zb_users/theme/' . $app->id . '/include/', 'php|inc|png');

-	foreach ($ft as $f) {

-		$mt[] = filemtime($f);

-	}

-	$ft = GetFilesInDir($zbp->path . '/zb_users/theme/' . $app->id . '/style/', 'php|inc|png');

-	foreach ($ft as $f) {

-		$mt[] = filemtime($f);

-	}

-	$ft = GetFilesInDir($zbp->path . '/zb_users/theme/' . $app->id . '/template/', 'php|inc|png');

-	foreach ($ft as $f) {

-		$mt[] = filemtime($f);

-	}

-	$ft = GetFilesInDir($zbp->path . '/zb_users/theme/' . $app->id . '/source/', 'php|inc|png');

-	foreach ($ft as $f) {

-		$mt[] = filemtime($f);

-	}

-	rsort($mt);

-	if (count($mt) == 0) {

-		$mt[] = time();

-	}

-

-	$app->modified = date('Y-m-d', reset($mt));

-} else {

-	$app = new App;

-	$app->price = 0;

-	$app->version = '1.0';

-	$app->pubdate = date('Y-m-d', time());

-	$app->modified = date('Y-m-d', time());

-	$v = array_keys($zbpvers);

-	$app->adapted = (string) end($v);

-	$app->type = 'theme';

-}

-

-if (count($_POST) > 0) {

-

-	$app->id = trim($_POST['app_id']);

-	if (!CheckRegExp($app->id, "/^[A-Za-z0-9_]{3,30}/")) {$zbp->ShowError('ID名必须是字母数字和下划线组成,长度3-30字符.');die();}

-	if (!GetVars('id')) {

-		$app2 = $zbp->LoadApp('theme', $app->id);

-		if ($app2->id) {$zbp->ShowError('已存在同名的APP应用.');die();}

-		@mkdir($zbp->usersdir . 'theme/' . $app->id);

-		@mkdir($zbp->usersdir . 'theme/' . $app->id . '/style');

-		//@mkdir($zbp->usersdir . 'theme/' . $app->id . '/compile');

-		@mkdir($zbp->usersdir . 'theme/' . $app->id . '/template');

-		@copy($zbp->usersdir . 'plugin/AppCentre/images/theme.png', $zbp->usersdir . 'theme/' . $app->id . '/screenshot.png');

-		@file_put_contents($zbp->usersdir . 'theme/' . $app->id . '/style/style.css', '');

-

-		if (trim($_POST['app_path'])) {

-			$file = file_get_contents('tpl/main.html');

-			$file = str_replace("<%appid%>", $app->id, $file);

-			$path = $zbp->usersdir . 'theme/' . $app->id . '/' . trim($_POST['app_path']);

-			@file_put_contents($path, $file);

-		}

-		if (trim($_POST['app_include'])) {

-			$file = file_get_contents('tpl/include.html');

-			$file = str_replace("<%appid%>", $app->id, $file);

-			$path = $zbp->usersdir . 'theme/' . $app->id . '/include.php';

-			@file_put_contents($path, $file);

-		}

-	}

-

-	$app->name = trim($_POST['app_name']);

-	$app->url = trim($_POST['app_url']);

-	$app->note = trim($_POST['app_note']);

-	$app->adapted = $_POST['app_adapted'];

-	$app->version = (float) $_POST['app_version'];

-	if ($app->version == 1) {

-		$app->version = '1.0';

-	}

-

-	$app->pubdate = date('Y-m-d', strtotime($_POST['app_pubdate']));

-	$app->modified = date('Y-m-d', time());

-

-	$app->author_name = trim($_POST['app_author_name']);

-	$app->author_email = trim($_POST['app_author_email']);

-	$app->author_url = trim($_POST['app_author_url']);

-	$app->source_name = trim($_POST['app_source_name']);

-	$app->source_email = trim($_POST['app_source_email']);

-	$app->source_url = trim($_POST['app_source_url']);

-

-	$app->path = trim($_POST['app_path']);

-	$app->include = trim($_POST['app_include']);

-	$app->level = (int) $_POST['app_level'];

-	$app->price = (float) $_POST['app_price'];

-

-	$app->advanced_dependency = trim($_POST['app_advanced_dependency']);

-	$app->advanced_rewritefunctions = trim($_POST['app_advanced_rewritefunctions']);

-	$app->advanced_conflict = trim($_POST['app_advanced_conflict']);

-

-	$app->description = trim($_POST['app_description']);

-

-	if (GetVars('app_sidebars_sidebar1')) {

-		$app->sidebars_sidebar1 = $zbp->option['ZC_SIDEBAR_ORDER'];

-	} else {

-		$app->sidebars_sidebar1 = '';

-	}

-	if (GetVars('app_sidebars_sidebar2')) {

-		$app->sidebars_sidebar2 = $zbp->option['ZC_SIDEBAR2_ORDER'];

-	} else {

-		$app->sidebars_sidebar2 = '';

-	}

-	if (GetVars('app_sidebars_sidebar3')) {

-		$app->sidebars_sidebar3 = $zbp->option['ZC_SIDEBAR3_ORDER'];

-	} else {

-		$app->sidebars_sidebar3 = '';

-	}

-	if (GetVars('app_sidebars_sidebar4')) {

-		$app->sidebars_sidebar4 = $zbp->option['ZC_SIDEBAR4_ORDER'];

-	} else {

-		$app->sidebars_sidebar4 = '';

-	}

-	if (GetVars('app_sidebars_sidebar5')) {

-		$app->sidebars_sidebar5 = $zbp->option['ZC_SIDEBAR5_ORDER'];

-	} else {

-		$app->sidebars_sidebar5 = '';

-	}

-

-	$app->SaveInfoByXml();

-

-	$zbp->SetHint('good', '提交成功！现在立刻上传到应用中心！');

-	Redirect($_SERVER["HTTP_REFERER"]);

-}

-

-require $blogpath . 'zb_system/admin/admin_header.php';

-require $blogpath . 'zb_system/admin/admin_top.php';

-

-?>

-

-

-  

-

-  

-

-

-  

-    

-       

-       

-    

-    

-      · 主题ID

-            主题ID为主题的目录名,且不能重复.ID名只能用字母数字和下划线的组合.

-       

-          id) {

-	echo 'readonly="readonly"';

-}

-?>  />

-        

-    

-    

-      · 主题名称

-       

-          

-        

-    

-    

-      · 主题发布页面

-       

-          

-        

-    

-    

-      · 主题简介

-       

-          

-        

-    

-    

-      · 适用的最低要求 Z-Blog 版本

-       

-          

-adapted);?>

-          

-        

-    

-    

-      · 主题版本号

-       

-          

-        

-    

-    

-      · 主题首发时间

-            日期格式为2012-12-12

-       

-          

-        

-    

-    

-      · 主题最后修改时间

-            系统自动检查目录内文件的最后修改日期

-       

-          

-        

-    

-    

-      · 作者名称

-       

-          

-        

-    

-    

-      · 作者邮箱

-       

-          

-        

-    

-    

-      · 作者网站

-       

-          

-        

-    

-    

-      · 源作者名称 (可选)

-       

-          

-        

-    

-    

-      · 源作者邮箱 (可选)

-       

-          

-        

-    

-    

-      · 源作者网站 (可选)

-       

-          

-        

-    

-    

-      · 内置插件管理页 (可选)

-            习惯命名为main.php

-       

-          

-        

-    

-    

-      · 内置插件嵌入页 (可选)

-            只能命名为include.php

-       

-          

-        

-    

-    

-      · 内置插件管理权限 (可选)

-       

-          

-

-          

-        

-    

-    

-      · 主题定价

-       

-          

-        

-    

-    

-      · 【高级】依赖插件（以|分隔）(可选)

-       

-          

-        

-    

-    

-      · 【高级】内置插件重写系统函数列表（以|分隔）(可选)

-       

-          

-        

-    

-    

-      · 【高级】内置插件冲突插件列表（以|分隔）(可选)

-       

-          

-        

-    

-    

-      · 详细说明 (可选)

-       

-          description);?>

-        

-    

-    

-      · 侧栏配置导出 (可选)

-       

-          

-            sidebars_sidebar1) {

-	echo 'checked="checked"';

-}

-?>  />

-            侧栏

-               

-          

-            sidebars_sidebar2) {

-	echo 'checked="checked"';

-}

-?>   />

-            侧栏2

-               

-          

-            sidebars_sidebar3) {

-	echo 'checked="checked"';

-}

-?>   />

-            侧栏3

-               

-          

-            sidebars_sidebar4) {

-	echo 'checked="checked"';

-}

-?>   />

-            侧栏4

-               

-          

-            sidebars_sidebar5) {

-	echo 'checked="checked"';

-}

-?>   />

-            侧栏5

-               

-    

-  

-   提示:主题的缩略图是名为screenshot.png的300x240px大小的png文件,放在插件的目录下.

-  

-    

-  

-   

-

-

-

-	

-	

-  

-

-
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/tpl/include.html b/zb_users/plugin/AppCentre/tpl/include.html
deleted file mode 100644
index 759d69ce6..000000000
--- a/zb_users/plugin/AppCentre/tpl/include.html
+++ /dev/null
@@ -1,7 +0,0 @@
-","ActivePlugin_<%appid%>");

-

-function ActivePlugin_<%appid%>() {}

-function InstallPlugin_<%appid%>() {}

-function UninstallPlugin_<%appid%>() {}
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/tpl/main.html b/zb_users/plugin/AppCentre/tpl/main.html
deleted file mode 100644
index a19675d3e..000000000
--- a/zb_users/plugin/AppCentre/tpl/main.html
+++ /dev/null
@@ -1,25 +0,0 @@
-Load();

-$action='root';

-if (!$zbp->CheckRights($action)) {$zbp->ShowError(6);die();}

-if (!$zbp->CheckPlugin('<%appid%>')) {$zbp->ShowError(48);die();}

-

-$blogtitle='<%appid%>';

-require $blogpath . 'zb_system/admin/admin_header.php';

-require $blogpath . 'zb_system/admin/admin_top.php';

-?>

-

-  

-  

-  

-  

-

-  

-

-

-
\ No newline at end of file
diff --git a/zb_users/plugin/AppCentre/update.php b/zb_users/plugin/AppCentre/update.php
deleted file mode 100644
index fb64c295b..000000000
--- a/zb_users/plugin/AppCentre/update.php
+++ /dev/null
@@ -1,235 +0,0 @@
-Load();

-

-$action = 'root';

-if (!$zbp->CheckRights($action)) {$zbp->ShowError(6);die();}

-

-if (!$zbp->CheckPlugin('AppCentre')) {$zbp->ShowError(48);die();}

-

-$blogtitle = '应用中心-系统更新与校验';

-

-$checkbegin = false;

-$nowxml = '';

-

-function updatedb_14() {

-	global $zbp, $table;

-

-	if ($zbp->db->type == 'mysql') {

-		$zbp->db->Query("ALTER TABLE " . $table['Post'] . " DROP INDEX  " . $zbp->db->dbpre . "log_TISC ;");

-		$zbp->db->Query("ALTER TABLE " . $table['Post'] . " DROP INDEX  " . $zbp->db->dbpre . "log_PT ;");

-		$zbp->db->Query("ALTER TABLE " . $table['Post'] . " ADD INDEX  " . $zbp->db->dbpre . "log_TPISC(log_Type,log_PostTime,log_IsTop,log_Status,log_CateID) ;");

-		$zbp->db->Query("ALTER TABLE " . $table['Comment'] . " DROP INDEX  " . $zbp->db->dbpre . "comm_PT ;");

-		$zbp->db->Query("ALTER TABLE " . $table['Comment'] . " DROP INDEX  " . $zbp->db->dbpre . "comm_RIL ;");

-		$zbp->db->Query("ALTER TABLE " . $table['Comment'] . " ADD INDEX  " . $zbp->db->dbpre . "comm_LRI(comm_LogID,comm_RootID,comm_IsChecking) ;");

-		$zbp->db->Query("ALTER TABLE " . $table['Comment'] . " ADD INDEX  " . $zbp->db->dbpre . "comm_IsChecking(comm_IsChecking) ;");

-		$zbp->db->Query("ALTER TABLE " . $table['Category'] . " ADD INDEX  " . $zbp->db->dbpre . "cate_Order(cate_Order) ;");

-		$zbp->db->Query("ALTER TABLE " . $table['Member'] . " ADD INDEX  " . $zbp->db->dbpre . "mem_Alias(mem_Alias) ;");

-		$zbp->db->Query("ALTER TABLE " . $table['Member'] . " ADD INDEX  " . $zbp->db->dbpre . "mem_Level(mem_Level) ;");

-	} elseif ($zbp->db->type == 'sqlite') {

-		$zbp->db->Query("CREATE INDEX " . $zbp->db->dbpre . "cate_Order on " . $table['Category'] . "(cate_Order) ;");

-		$zbp->db->Query("CREATE INDEX " . $zbp->db->dbpre . "mem_Alias on " . $table['Member'] . "(mem_Alias) ;");

-	}

-	if ($zbp->db->type == 'mysql' || $zbp->db->type == 'sqlite') {

-		$zbp->db->DelTable($GLOBALS['table']['Config']);

-		$s = $zbp->db->sql->CreateTable($GLOBALS['table']['Config'], $GLOBALS['datainfo']['Config']);

-		$zbp->db->QueryMulit($s);

-		if ($zbp->db->type == 'mysql') {

-			$zbp->db->Query("ALTER TABLE " . $GLOBALS['table']['Config'] . " ADD INDEX  " . $zbp->db->dbpre . "conf_Name(conf_Name) ;");

-		} elseif ($zbp->db->type == 'sqlite') {

-			$zbp->db->Query("CREATE INDEX " . $zbp->db->dbpre . "conf_Name on " . $GLOBALS['table']['Config'] . "(conf_Name) ;");

-		}

-

-		array_unshift($zbp->configs, $zbp->configs['system'], $zbp->configs['cache']);

-		foreach ($zbp->configs as $c) {

-			$c->Save();

-		}

-	}

-	$zbp->option['ZC_LAST_VERSION'] = $zbp->version;

-	$zbp->SaveOption();

-

-	$zbp->SetHint('good');

-	Redirect('./update.php?ok');return;

-}

-if (isset($_GET['updatedb'])) {

-	if ($zbp->version >= 150101 && (int) $zbp->option['ZC_LAST_VERSION'] < 150101) {

-		updatedb_14();

-	}

-

-}

-if (GetVars('update', 'GET') != '') {

-	$url = APPCENTRE_SYSTEM_UPDATE . '?' . GetVars('update', 'GET') . '.xml';

-	$f = AppCentre_GetHttpContent($url);

-	$xml = simplexml_load_string($f);

-	if ($xml) {

-		foreach ($xml->children() as $file) {

-			$full = $zbp->path . str_replace('\\', '/', $file['name']);

-			$dir = dirname($full);

-			if (!file_exists($dir . '/')) {

-				@mkdir($dir, 0755, true);

-			}

-

-			$f = base64_decode($file);

-			@file_put_contents($full, $f);

-		}

-		$zbp->SetHint('good');

-	}

-	Redirect('./update.php?updatedb');

-}

-

-if (GetVars('restore', 'GET') != '') {

-	$file = base64_decode(GetVars('restore', 'GET'));

-	$url = APPCENTRE_SYSTEM_UPDATE . '?' . substr(ZC_BLOG_VERSION, -6, 6) . '\\' . $file;

-	$f = AppCentre_GetHttpContent($url);

-	$file = $zbp->path . str_replace('\\', '/', $file);

-	$dir = dirname($file);

-	if (!file_exists($dir . '/')) {

-		@mkdir($dir, 0755, true);

-	}

-

-	@file_put_contents($file, $f);

-	echo '';

-	die();

-}

-

-if (GetVars('check', 'GET') == 'now') {

-	$r = AppCentre_GetHttpContent(APPCENTRE_SYSTEM_UPDATE . array_search(ZC_BLOG_VERSION, $zbpvers) . '.xml');

-	//file_put_contents($zbp->usersdir . 'cache/now.xml', $r);

-	$nowxml = $r;

-	$checkbegin = true;

-}

-

-require $blogpath . 'zb_system/admin/admin_header.php';

-require $blogpath . 'zb_system/admin/admin_top.php';

-

-$newversion = AppCentre_GetHttpContent(APPCENTRE_SYSTEM_UPDATE . ($zbp->Config('AppCentre')->checkbeta == true ? '?beta' : ''));

-

-?>

-

-

-  

-

-  

-

-            

-

-

-version >= 150101 && (int) $zbp->option['ZC_LAST_VERSION'] < 150101) {

-	echo '';

-}

-

-?>

-			  

-

-              

-                

-                  当前版本

-                  最新版本

-                

-                

-                  Z-BlogPHP 

-                  Z-BlogPHP 

-                

-              

-              

-

- 0) {

-	echo '';

-}

-?>

-              

-			  

-              校验当前版本的系统核心文件  

-			  

-              

-                

-                  文件名

-                  状态

-                

-usersdir . 'cache/now.xml')) {

-if ($nowxml != '') {

-

-	$i = 0;

-	libxml_use_internal_errors(true);

-	//$xml=simplexml_load_file($zbp->usersdir . 'cache/now.xml');

-	$xml = simplexml_load_string($nowxml);

-	if ($xml) {

-		foreach ($xml->children() as $file) {

-			if (file_exists($f = $zbp->path . str_replace('\\', '/', $file['name']))) {

-				$f = file_get_contents($f);

-				$newcrc32 = substr(strtoupper(dechex(AppCentre_crc32_signed($f))), -8);

-				$f = str_replace("\n", "\r\n", $f);

-				$newcrc32_2 = substr(strtoupper(dechex(AppCentre_crc32_signed($f))), -8);

-			} else {

-				$newcrc32 = '';

-				$newcrc32_2 = '';

-			}

-			//echo PHP_INT_SIZE;

-			if (($newcrc32 == $file['crc32']) || ($newcrc32_2 == $file['crc32'])) {

-				echo '' . str_replace('\\', '/', $file['name']) . '';

-				$s = '';

-			} else {

-				$i += 1;

-				echo '' . str_replace('\\', '/', $file['name']) . '';

-				$s = '';

-			}

-			echo '' . $s . '';

-		}

-	}

-	echo '' . $i . '个文件不同或被修改过.';

-	//@unlink($zbp->usersdir . 'cache/now.xml');

-}

-?>

-

-              

- 0) {?>

-              

-                

-              

-

-               

-            

-

-	

-	

-  

-

-

-

-
\ No newline at end of file
