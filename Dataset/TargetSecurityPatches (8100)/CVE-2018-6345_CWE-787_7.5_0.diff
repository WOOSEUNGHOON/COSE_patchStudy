190ffdf6c8b1ec443be202c7d69e63a7e3da25e3
facebook@@hhvm
diff --git a/hphp/runtime/base/zend-string.cpp b/hphp/runtime/base/zend-string.cpp
index 072148f61c0..40267cffd6f 100644
--- a/hphp/runtime/base/zend-string.cpp
+++ b/hphp/runtime/base/zend-string.cpp
@@ -1768,6 +1768,7 @@ String string_number_format(double d, int dec,
   String tmpstr(63, ReserveString);
   tmpbuf = tmpstr.mutableData();
   tmplen = snprintf(tmpbuf, 64, "%.*F", dec, d);
+  if (tmplen < 0) return empty_string();
   if (tmpbuf == nullptr || !isdigit((int)tmpbuf[0])) {
     tmpstr.setSize(tmplen);
     return tmpstr;
@@ -1777,6 +1778,7 @@ String string_number_format(double d, int dec,
     tmpstr = String(tmplen, ReserveString);
     tmpbuf = tmpstr.mutableData();
     tmplen = snprintf(tmpbuf, tmplen + 1, "%.*F", dec, d);
+    if (tmplen < 0) return empty_string();
     if (tmpbuf == nullptr || !isdigit((int)tmpbuf[0])) {
       tmpstr.setSize(tmplen);
       return tmpstr;
diff --git a/hphp/test/slow/string/number_format_error.php b/hphp/test/slow/string/number_format_error.php
new file mode 100644
index 00000000000..e5899967bc0
--- /dev/null
+++ b/hphp/test/slow/string/number_format_error.php
@@ -0,0 +1,19 @@
+
diff --git a/hphp/test/slow/string/number_format_error.php.expect b/hphp/test/slow/string/number_format_error.php.expect
new file mode 100644
index 00000000000..4cbe7ce9a78
--- /dev/null
+++ b/hphp/test/slow/string/number_format_error.php.expect
@@ -0,0 +1,2 @@
+string(0) ""
+bool(false)
