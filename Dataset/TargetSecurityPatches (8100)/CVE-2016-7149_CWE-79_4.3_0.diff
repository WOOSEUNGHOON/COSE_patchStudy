9a4ab85439d1b838ee7b8eeebbf59174bb787811
b2evolution@@b2evolution
diff --git a/_tests/blogs/evocore/misc.funcs.simpletest.php b/_tests/blogs/evocore/misc.funcs.simpletest.php
index cd2fe71cbdb..a58d5b94349 100644
--- a/_tests/blogs/evocore/misc.funcs.simpletest.php
+++ b/_tests/blogs/evocore/misc.funcs.simpletest.php
@@ -54,6 +54,9 @@ function test_make_clickable()
 				'' => '',
 				'' => '',
 				'http://example.com/' => 'http://example.com/',
+
+				// XSS sample:
+				'text http://test_url.test"onmouseover="alert(1)"onerror=1 "text' => 'text http://test_url.test"onmouseover="alert(1)"onerror=1 "text',
 			) as $lText => $lExpected )
 		{
 			$this->assertEqual( make_clickable($lText), $lExpected );
diff --git a/inc/_core/_misc.funcs.php b/inc/_core/_misc.funcs.php
index c487df91492..0f716268c02 100644
--- a/inc/_core/_misc.funcs.php
+++ b/inc/_core/_misc.funcs.php
@@ -1321,11 +1321,11 @@ function make_clickable_callback( $text, $moredelim = '&', $additional_attrs
 		/* Tblue> I removed the double quotes from the first RegExp because
 				  it made URLs in tag attributes clickable.
 				  See http://forums.b2evolution.net/viewtopic.php?p=92073 */
-		array( '#(^|[\s>\(]|\[url=)(https?|mailto)://([^<>{}\s]+[^.,:;!\?<>{}\s\]\)])#i',
-			'#(^|[\s>\(]|\[url=)aim:([^,<\s\]\)]+)#i',
+		array( '#(^|[\s>\(]|\[url=)(https?|mailto)://([^"<>{}\s]+[^".,:;!\?<>{}\s\]\)])#i',
+			'#(^|[\s>\(]|\[url=)aim:([^",<\s\]\)]+)#i',
 			'#(^|[\s>\(]|\[url=)icq:(\d+)#i',
-			'#(^|[\s>\(]|\[url=)www\.'.$pattern_domain.'([^<>{}\s]*[^.,:;!\?\s\]\)])#i',
-			'#(^|[\s>\(]|\[url=)([a-z0-9\-_.]+?)@'.$pattern_domain.'([^.,:;!\?<\s\]\)]+)#i', ),
+			'#(^|[\s>\(]|\[url=)www\.'.$pattern_domain.'([^"<>{}\s]*[^".,:;!\?\s\]\)])#i',
+			'#(^|[\s>\(]|\[url=)([a-z0-9\-_.]+?)@'.$pattern_domain.'([^".,:;!\?<\s\]\)]+)#i', ),
 		array( '$1$2://$3',
 			'$1$2$3',
 			'$1$2',
